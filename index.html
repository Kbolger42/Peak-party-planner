<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Floor Planner ¬∑ Peak Party Rentals</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --blue-dark:#004a6e; --blue:#0093c7; --teal:#41b8ea;
  --teal-pale:#e0f4fc; --teal-tint:#f0fafd;
  --bg:#eef4f7; --bar:#1a2830; --bar2:#22343e;
  --sidebar:#ffffff; --panel:#f5f9fb; --border:#cde3ed;
  --text:#30393d; --muted:#5a7a88;
  --accent:#0093c7; --accent-h:#007aab;
  --sel:#0093c7; --danger:#dc2626;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif;font-size:17.1px;color:var(--text);}
body{display:flex;flex-direction:column;background:var(--bg);user-select:none;}

/* TOP BAR */
#topbar{
  height:64px;
  background:linear-gradient(135deg, #0d1c26 0%, #1a2e3c 55%, #0e2030 100%);
  border-bottom:2px solid #0093c7;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;z-index:100;overflow:visible;position:relative;
  box-shadow:0 3px 24px rgba(0,0,0,0.5);
}
/* Subtle mountain silhouette background decoration */
#topbar::before{
  content:'';position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='900' height='64' viewBox='0 0 900 64'%3E%3Cpolygon points='0,64 180,18 260,36 340,8 440,30 520,0 610,22 700,12 780,28 900,64' fill='rgba(0,147,199,0.04)'/%3E%3Cpolygon points='0,64 120,30 200,44 310,16 400,38 500,10 590,32 680,20 780,34 900,64' fill='rgba(65,184,234,0.03)'/%3E%3C/svg%3E");
  background-position:right center;background-repeat:no-repeat;background-size:cover;
}
#tb-left{display:flex;align-items:center;overflow:hidden;flex:1;min-width:0;}
#tb-right{display:flex;align-items:center;gap:6px;padding:0 14px;flex-shrink:0;background:var(--bar);}
.tb-3d-btn{background:rgba(65,184,234,0.15)!important;border-color:rgba(65,184,234,0.45)!important;color:#7dd6f5!important;font-weight:600!important;}
.tb-dropdown{position:absolute;top:44px;left:0;background:#1a2830;border:1px solid rgba(65,184,234,0.3);border-radius:8px;padding:9px;z-index:600;box-shadow:0 8px 28px rgba(0,0,0,0.55);}
.tb-dd-label{font-size:11.8px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
.dd-btn{height:26px!important;padding:2px 6px!important;font-size:13.9px!important;justify-content:center;}
.tb-logo{
  padding:0 18px 0 16px;height:100%;display:flex;align-items:center;gap:14px;
  border-right:1px solid rgba(255,255,255,0.1);flex-shrink:0;position:relative;z-index:1;
}
.tb-logo img{height:40px;object-fit:contain;filter:drop-shadow(0 1px 8px rgba(0,147,199,0.3));}
.tb-logo-divider{width:1px;height:32px;background:rgba(255,255,255,0.12);}
.tb-logo-text{display:flex;flex-direction:column;gap:1px;}
.tb-planner-label{
  display:block;
  font-size:17.1px;font-weight:800;letter-spacing:0.5px;
  color:#ffffff;line-height:1.1;
  text-transform:uppercase;
}
.tb-tagline{
  font-size:12.5px;font-style:italic;font-weight:500;
  color:#41b8ea;letter-spacing:0.2px;line-height:1.1;white-space:nowrap;
  opacity:0.9;
}
.tb-sect{display:flex;align-items:center;gap:5px;padding:0 10px;border-right:1px solid rgba(255,255,255,0.07);height:100%;}
.tb-label{font-size:13.2px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.8px;white-space:nowrap;margin-right:1px;}
.tb-select,.tb-input{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.14);color:#d8eaf4;border-radius:5px;padding:4px 7px;font-size:15.9px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.15s;}
.tb-select:focus,.tb-input:focus{border-color:var(--teal);}
.tb-input{width:50px;text-align:center;}
.tb-btn{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.13);color:#c8dde8;border-radius:5px;padding:5px 10px;font-size:15.9px;font-family:'DM Sans',sans-serif;cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all 0.14s;height:30px;}
.tb-btn:hover{background:rgba(255,255,255,0.14);border-color:var(--teal);color:#fff;}
.tb-btn:disabled{opacity:0.28;cursor:default;}
.tb-btn.active{background:var(--blue);border-color:var(--teal);color:#fff;}
.tb-btn.danger:hover{background:rgba(220,38,38,0.2);border-color:var(--danger);color:#fca5a5;}
.tb-btn
.send-btn{
  background:linear-gradient(135deg,#0093c7,#007aab)!important;
  border-color:#41b8ea!important;color:#fff!important;
  font-weight:800!important;
  box-shadow:0 2px 12px rgba(0,147,199,0.35);
}
.send-btn:hover{
  background:linear-gradient(135deg,#007aab,#005f8a)!important;
  transform:translateY(-1px);
  box-shadow:0 4px 18px rgba(0,147,199,0.45)!important;
}

.print-btn{background:var(--blue);border-color:var(--teal);color:#fff;font-weight:600;}
.tb-btn.print-btn:hover{background:var(--accent-h);}
.zoom-display{color:#d8eaf4;font-size:15.9px;font-weight:600;min-width:42px;text-align:center;}
.cap-pill{background:rgba(65,184,234,0.15);border:1px solid rgba(65,184,234,0.35);border-radius:20px;padding:4px 12px;color:#7dd6f5;font-size:14.5px;font-weight:600;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.sep{width:1px;background:rgba(255,255,255,0.08);height:26px;margin:0 2px;}
#align-sect .tb-btn{font-size:14.5px;padding:4px 7px;}
#align-menu .tb-btn{height:28px;padding:3px 6px;font-size:14.5px;}
#align-menu .tb-btn:hover{background:rgba(0,147,199,0.25);border-color:#41b8ea;color:#fff;}


/* BODY */
#body{display:flex;flex:1;overflow:hidden;}
#canvas-col{display:flex;flex-direction:column;flex:1;overflow:hidden;min-width:0;}


/* PALETTE */
#palette{width:200px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
/* #pal-hdr replaced by #pal-hdr-bar */
#pal-inner{flex:1;overflow-y:auto;padding:6px;}
.pal-cat{font-size:11.8px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding:10px 4px 5px;border-bottom:1px solid var(--border);margin-bottom:4px;}
.pal-item{border:1px solid var(--border);border-radius:7px;background:var(--panel);padding:7px 6px;cursor:grab;display:flex;flex-direction:column;align-items:center;gap:4px;margin-bottom:4px;transition:all 0.14s;}
.pal-item:hover{border-color:var(--accent);background:var(--teal-tint);box-shadow:0 2px 8px rgba(0,147,199,0.15);}
.pal-item:active{cursor:grabbing;transform:scale(0.97);}
.pal-item-active{border-color:var(--accent)!important;background:rgba(0,147,199,0.1)!important;box-shadow:0 0 0 2px rgba(0,147,199,0.25)!important;}
.pal-item-active .pal-lbl{color:var(--accent)!important;}
.pal-lbl{font-size:14.5px;font-weight:600;color:var(--text);}
.pal-sub{font-size:11.8px;color:var(--muted);text-align:center;}

/* CANVAS */
#canvas-area{flex:1;overflow:hidden;position:relative;background:var(--bg);cursor:default;}
#canvas-area.panning{cursor:grab;}
#canvas-area.panning.dragging{cursor:grabbing;}
#sel-rect{position:absolute;border:1.5px dashed var(--accent);background:rgba(0,147,199,0.06);pointer-events:none;display:none;z-index:500;}
#grp-box{position:absolute;display:none;box-sizing:border-box;border:2px solid var(--accent);background:rgba(0,147,199,0.04);border-radius:4px;cursor:move;z-index:50;}
#grp-box:hover{background:rgba(0,147,199,0.09);border-color:#41b8ea;}
#grp-box::after{content:"Move Group";position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;font-size:11.8px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;padding:2px 8px;border-radius:10px;white-space:nowrap;opacity:0;transition:opacity 0.15s;pointer-events:none;}
#grp-box:hover::after{opacity:1;}
#ev-banner{display:none;position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:50;background:rgba(0,40,60,0.88);backdrop-filter:blur(4px);border:1px solid var(--teal);border-radius:12px;padding:9px 18px;color:#fff;font-size:14.5px;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,0.3);pointer-events:none;text-align:center;}
#ev-banner.visible{display:block;}
.evb-name{font-size:17.1px;font-weight:700;margin-bottom:2px;}
.evb-det{font-size:13.2px;color:#7dd6f5;letter-spacing:0.5px;}
#world{position:absolute;}
#tent{position:relative;background:#fff;border:3px solid #374151;overflow:visible;box-shadow:0 4px 32px rgba(0,0,0,0.14);}
#grid-cvs{position:absolute;top:0;left:0;pointer-events:none;z-index:1;}
.tent-dim{position:absolute;font-size:14.5px;font-weight:600;color:#6b7280;pointer-events:none;white-space:nowrap;}

/* ITEMS */
.c-wrap{position:absolute;cursor:move;z-index:10;}
.c-wrap.selected .c-tbl{outline:2.5px solid var(--sel);outline-offset:1px;box-shadow:0 0 0 4px rgba(0,147,199,0.18)!important;}
.c-wrap.locked{cursor:not-allowed;}
.c-wrap.locked .c-tbl{opacity:0.75;}
.c-tbl{position:absolute;display:flex;align-items:center;justify-content:center;text-align:center;line-height:1.2;font-family:'DM Sans',sans-serif;font-weight:700;pointer-events:none;}
.c-dot{position:absolute;border-radius:50%;pointer-events:none;}
.lock-icon{position:absolute;top:1px;right:2px;font-size:10.6px;pointer-events:none;z-index:2;}

/* SIDEBAR */
#sidebar{width:216px;background:var(--sidebar);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
.sb-tabs{display:flex;border-bottom:2px solid var(--border);flex-shrink:0;}
.sb-tab{flex:1;padding:7px 1px;text-align:center;font-size:12.5px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all 0.14s;}
.sb-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.sb-panel{flex:1;overflow-y:auto;display:none;padding:12px;}
.sb-panel.active{display:block;}
.prop-section{margin-bottom:14px;}
.prop-title{font-size:11.8px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.prop-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;gap:6px;}
.prop-lbl{font-size:14.5px;color:var(--muted);white-space:nowrap;flex:1;}
.prop-val{font-size:15.9px;font-weight:600;color:var(--text);}
.prop-input{width:68px;background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:4px 7px;font-size:14.5px;font-family:'DM Sans',sans-serif;color:var(--text);outline:none;text-align:right;}
.prop-input:focus{border-color:var(--accent);}
.prop-btn{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:5px;padding:5px 8px;font-size:14.5px;font-family:'DM Sans',sans-serif;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all 0.14s;}
.prop-btn:hover{background:var(--teal-tint);border-color:var(--accent);color:var(--blue);}
.prop-btn.danger:hover{background:#fee2e2;border-color:var(--danger);color:var(--danger);}
.prop-btn.accent{background:var(--teal-tint);border-color:#b3dff0;color:var(--accent);}
.no-sel{color:var(--muted);font-size:14.5px;text-align:center;padding:20px 0;font-style:italic;}
.sum-row{display:flex;align-items:center;padding:6px 8px;border-radius:6px;margin-bottom:3px;background:var(--panel);border:1px solid var(--border);}
.sum-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.sum-name{font-size:14.5px;font-weight:500;flex:1;padding:0 6px;}
.sum-count{font-size:14.5px;font-weight:700;color:var(--accent);}
.sum-total{background:var(--teal-tint);border:1px solid #b3dff0;border-radius:6px;padding:8px 10px;margin-top:8px;display:flex;justify-content:space-between;align-items:center;}
.sum-total-lbl{font-size:14.5px;font-weight:600;color:var(--blue);}
.sum-total-val{font-size:21.2px;font-weight:700;color:var(--blue-dark);}

/* EVENT TAB */
.ev-input{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:5px;padding:6px 9px;font-size:14.5px;font-family:'DM Sans',sans-serif;color:var(--text);outline:none;margin-bottom:5px;resize:vertical;}
.ev-input:focus{border-color:var(--accent);}
.ev-lbl{font-size:13.2px;font-weight:600;color:var(--muted);margin-bottom:3px;display:block;text-transform:uppercase;letter-spacing:0.6px;}
.ev-preview-box{background:linear-gradient(135deg,#f0fafd 0%,#e5f3fb 100%);border:1.5px solid #b3dff0;border-radius:10px;padding:13px;font-size:14.5px;line-height:1.6;color:var(--text);}
.ev-preview-logo{height:20px;margin-bottom:8px;display:block;}
.ev-preview-name{font-size:18.5px;font-weight:700;color:var(--blue-dark);margin-bottom:1px;}
.ev-preview-type{font-size:13.2px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.ev-preview-row{display:flex;gap:5px;align-items:flex-start;margin-bottom:3px;font-size:13.2px;color:var(--muted);}
.ev-preview-row span{color:var(--text);font-weight:500;}
.ev-preview-note{margin-top:8px;padding-top:8px;border-top:1px solid #b3dff0;font-size:13.2px;color:#30393d;font-style:italic;line-height:1.5;}

/* UPSELL TAB */
.upsell-smart-card{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1.5px solid #fcd34d;border-radius:7px;padding:8px 10px;margin-bottom:5px;}
.usc-title{font-size:14.5px;font-weight:700;color:#92400e;margin-bottom:2px;}
.usc-why{font-size:13.2px;color:#a16207;line-height:1.4;}
.upsell-item{display:flex;align-items:flex-start;gap:8px;padding:7px 8px;border-radius:7px;margin-bottom:4px;background:var(--panel);border:1.5px solid var(--border);cursor:pointer;transition:all 0.14s;}
.upsell-item:hover{border-color:var(--accent);background:var(--teal-tint);}
.upsell-item.checked{background:var(--teal-tint);border-color:var(--accent);}
.upsell-item input[type=checkbox]{margin-top:2px;accent-color:var(--accent);flex-shrink:0;cursor:pointer;}
.upsell-item-name{font-size:14.5px;font-weight:600;color:var(--text);}
.upsell-item-desc{font-size:12.5px;color:var(--muted);line-height:1.4;margin-top:1px;}
.upsell-item-price{font-size:13.2px;font-weight:700;color:var(--accent);margin-top:2px;}

/* SAVES */
.save-input{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:5px;padding:6px 9px;font-size:15.9px;font-family:'DM Sans',sans-serif;color:var(--text);outline:none;margin-bottom:7px;}
.save-input:focus{border-color:var(--accent);}
.save-btn{width:100%;background:var(--accent);border:1px solid var(--accent-h);border-radius:5px;padding:7px;font-size:15.9px;font-family:'DM Sans',sans-serif;color:#fff;font-weight:600;cursor:pointer;transition:background 0.14s;margin-bottom:12px;}
.save-btn:hover{background:var(--accent-h);}
.save-row{display:flex;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;overflow:hidden;cursor:pointer;transition:all 0.14s;}
.save-row:hover{border-color:var(--accent);}
.save-name{flex:1;padding:7px 10px;font-size:14.5px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.save-del{background:none;border:none;padding:7px 9px;cursor:pointer;color:var(--muted);font-size:15.9px;}
.save-del:hover{color:var(--danger);}
.no-saves{font-size:14.5px;color:var(--muted);text-align:center;padding:16px 0;font-style:italic;}

/* STATUS BAR */
#statusbar{height:24px;background:var(--bar);border-top:1px solid var(--bar2);display:flex;align-items:center;padding:0 12px;gap:16px;flex-shrink:0;}
.status-item{font-size:13.2px;color:rgba(100,180,220,0.55);white-space:nowrap;}
.status-item span{color:var(--teal);}
.dir-dupe-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;}
code{font-family:monospace;}
label.prop-btn{display:flex;align-items:center;}
.import-drop-zone{border:2px dashed var(--border);border-radius:7px;padding:16px;text-align:center;font-size:13.2px;color:var(--muted);transition:all 0.14s;margin-bottom:8px;}
.import-drop-zone.dragover{border-color:var(--accent);background:var(--teal-tint);color:var(--blue);}
#toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:var(--bar);color:#fff;padding:8px 20px;border-radius:20px;font-size:15.9px;font-weight:500;z-index:9999;opacity:0;transition:opacity 0.25s;pointer-events:none;border:1px solid var(--blue);}

@media print{
  #topbar,#palette,#sidebar,#statusbar{display:none!important;}
  body{background:white;height:auto;overflow:visible;}
  #body{display:block;height:auto;overflow:visible;}
  #canvas-area{overflow:visible;background:white;height:auto;display:block;}
  #world{position:static!important;left:auto!important;top:auto!important;}
  #tent{margin:20px auto;box-shadow:none!important;border-color:#000!important;}
  .c-wrap.selected .c-tbl{outline:none!important;box-shadow:none!important;}
  #print-header{display:block!important;}
  #ev-banner{display:none!important;}
}
#print-header{display:none;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div id="tb-left">
    <div class="tb-logo">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTUuNDMgMTY4LjY0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6IzAwOTNjNzt9LmNscy0ze2ZpbGw6IzQxYjhlYTt9PC9zdHlsZT48L2RlZnM+PGcgaWQ9IkxheWVyXzIiIGRhdGEtbmFtZT0iTGF5ZXIgMiI+PGcgaWQ9IkxheWVyXzEtMiIgZGF0YS1uYW1lPSJMYXllciAxIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xLDExMVY5LjA1YTMsMywwLDAsMSwzLTNINDcuNTJBMzMuNCwzMy40LDAsMCwxLDYyLjExLDkuMjVhMzYuNTYsMzYuNTYsMCwwLDEsMTEuNTUsOC41OSw0MCw0MCwwLDAsMSw3LjUzLDEyLjA4LDM2LjQxLDM2LjQxLDAsMCwxLDIuNjYsMTMuNTMsMzguMjksMzguMjksMCwwLDEtNC40OSwxOC4wOUEzNy44OCwzNy44OCwwLDAsMSw2Ni45LDc1LjQ1YTMyLjUsMzIuNSwwLDAsMS0xOC42Miw1LjM5SDMwLjY1VjExMWEzLDMsMCwwLDEtMywzSDRBMywzLDAsMCwxLDEsMTExWk0zMC42NSw1My40NkExLjU0LDEuNTQsMCwwLDAsMzIuMTksNTVINDYuM2E2LjQyLDYuNDIsMCwwLDAsMy41LTEuMDYsOCw4LDAsMCwwLDIuODEtMy42NSwxNy4xNSwxNy4xNSwwLDAsMCwxLjE0LTYuODQsMTUuNzMsMTUuNzMsMCwwLDAtMS4yOS03LjA3LDcuNzcsNy43NywwLDAsMC0zLjE5LTMuNDksOCw4LDAsMCwwLTMuNzMtMUgzMi4xOWExLjU0LDEuNTQsMCwwLDAtMS41NCwxLjU0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE2OS41Nyw5MS4xNlYxMTFhMywzLDAsMCwxLTMsM0g5NS42OGEzLDMsMCwwLDEtMy0zVjkuMDhhMywzLDAsMCwxLDMtM2g2OS41YTMsMywwLDAsMSwzLDN2MTkuOGEzLDMsMCwwLDEtMywzSDEyMy43OWExLjQ5LDEuNDksMCwwLDAtMS40OSwxLjQ5VjQ1LjYxYTEuNDksMS40OSwwLDAsMCwxLjQ5LDEuNDloMzQuN2EzLDMsMCwwLDEsMywzdjE4YTMsMywwLDAsMS0zLDNoLTM0LjdhMS40OSwxLjQ5LDAsMCwwLTEuNDksMS40OVY4Ni42NWExLjQ5LDEuNDksMCwwLDAsMS40OSwxLjQ5aDQyLjc2QTMsMywwLDAsMSwxNjkuNTcsOTEuMTZaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjk3LjQ2LDExMVY5LjA4YTMsMywwLDAsMSwzLTNoMjMuNmEzLDMsMCwwLDEsMywzdjMzLjhhMS40OCwxLjQ4LDAsMCwwLDIuNjQuOTJMMzU5LjIzLDYuOTNhMi4zNCwyLjM0LDAsMCwxLDEuODItLjg3aDI3YTIuNTIsMi41MiwwLDAsMSwyLDQuMTFMMzU0LjkxLDUzLjQ2YTEuNjEsMS42MSwwLDAsMC0uMDYsMS45MkwzOTMuMzEsMTEwYTIuNTIsMi41MiwwLDAsMS0yLjA2LDRIMzYzLjNhMi4zMiwyLjMyLDAsMCwxLTEuOTMtMUwzMzYuNTMsNzYuMTFhMS43NywxLjc3LDAsMCwwLTIuNzMtLjI0bC01LjE0LDUuMzNhNS41Nyw1LjU3LDAsMCwwLTEuNTYsMy44N1YxMTFhMywzLDAsMCwxLTMsM2gtMjMuNkEzLDMsMCwwLDEsMjk3LjQ2LDExMVoiLz48cGF0aCBjbGFzcz0iY2xzLTIiIGQ9Ik0yODIuNTgsMTA2Ljg2LDI0MC4xNiw1LjIyYTguNDgsOC40OCwwLDAsMC0xNS42NiwwTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVWNTguNmg0Ljc3djQuOWwxOC4zNiw3LjgtMTguMzYsNy44Vjg1bDM3LjY1LDMwLjY5QTcuMDksNy4wOSwwLDAsMCwyODIuNTgsMTA2Ljg2WiIvPjxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTIzMCw1OC42aDIuMzJWMGE4LjM2LDguMzYsMCwwLDAtNy44Miw1LjIyTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMCwxNjguNDJWMTM3LjE4SDEzLjMzYTkuMDcsOS4wNywwLDAsMSw0LjA5LjkyLDExLjIyLDExLjIyLDAsMCwxLDMuMjQsMi40MiwxMC45MSwxMC45MSwwLDAsMSwyLjEzLDMuMzksMTAuNDEsMTAuNDEsMCwwLDEsLjc1LDMuODcsMTEsMTEsMCwwLDEtMS4yNSw1LjA4LDEwLjU4LDEwLjU4LDAsMCwxLTMuNDgsNCw5LDksMCwwLDEtNS4yMSwxLjUySDcuMjJ2MTAuMDhaTTcuMjIsMTUyaDUuODlhMi42NSwyLjY1LDAsMCwwLDEuNTItLjQ3LDMuMjcsMy4yNywwLDAsMCwxLjEyLTEuNDMsNS42Myw1LjYzLDAsMCwwLC40NC0yLjMzLDUuMzgsNS4zOCwwLDAsMC0uNDgtMi40NEEzLjMsMy4zLDAsMCwwLDE0LjQ1LDE0NGEzLjIyLDMuMjIsMCwwLDAtMS42LS40NEg3LjIyWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM3LjU4LDEzNy4xOGg3Ljc0bDEwLjgyLDMxLjI0SDQ4Ljc1bC0yLjEyLTdIMzYuMzJsLTIuMTMsN0gyNi44Wm03LjU2LDE5LjMxLTMuNjUtMTIuMDUtMy42NywxMi4wNVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik02My43NiwxNjguNDJWMTM3LjE4aDE0YTkuMzgsOS4zOCwwLDAsMSw0LjE0LjkyLDEwLjQyLDEwLjQyLDAsMCwxLDMuMjMsMi40MiwxMS40MywxMS40MywwLDAsMSwyLjExLDMuMzksMTAsMTAsMCwwLDEsLjc3LDMuODcsMTAuNzQsMTAuNzQsMCwwLDEtLjYzLDMuNjUsMTAuMTgsMTAuMTgsMCwwLDEtMS43OSwzLjEzLDkuNjIsOS42MiwwLDAsMS0yLjY4LDIuMjRsNi44NiwxMS42MmgtOGwtNi0xMC4wOEg3MXYxMC4wOFpNNzEsMTUyaDYuNjVhMi40MiwyLjQyLDAsMCwwLDEuNTEtLjUzLDMuODYsMy44NiwwLDAsMCwxLjEzLTEuNSw1LjMsNS4zLDAsMCwwLC40NC0yLjIsNC43NSw0Ljc1LDAsMCwwLS41MS0yLjI3QTQsNCwwLDAsMCw3OC45MSwxNDRhMi43NCwyLjc0LDAsMCwwLTEuNTYtLjUzSDcxWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTEyMS4yMiwxNDMuNTFoLTkuNXYyNC45MUgxMDQuNVYxNDMuNTFIOTV2LTYuMzNoMjYuMjdaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMTM0LjExLDEzNy4xOCwxNDAuODQsMTUxbDYuODctMTMuODFoNy44N2wtMTEuMTMsMjAuNTl2MTAuNjVoLTcuMTdWMTU3LjY4bC0xMS0yMC41WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE3Ni4yNiwxNjguNDJWMTM3LjE4aDE0YTkuNDEsOS40MSwwLDAsMSw0LjE0LjkyLDEwLjU0LDEwLjU0LDAsMCwxLDMuMjMsMi40MiwxMS42NCwxMS42NCwwLDAsMSwyLjExLDMuMzksMTAuMjMsMTAuMjMsMCwwLDEsLjc3LDMuODcsMTAuNTEsMTAuNTEsMCwwLDEtLjY0LDMuNjUsMTAuMTUsMTAuMTUsMCwwLDEtMS43OCwzLjEzLDkuNzYsOS43NiwwLDAsMS0yLjY4LDIuMjRsNi44NiwxMS42MmgtOGwtNi0xMC4wOGgtNC44OHYxMC4wOFpNMTgzLjQ4LDE1Mmg2LjY0YTIuNDIsMi40MiwwLDAsMCwxLjUyLS41MywzLjc1LDMuNzUsMCwwLDAsMS4xMi0xLjUsNS4xNSw1LjE1LDAsMCwwLC40NC0yLjIsNC44Nyw0Ljg3LDAsMCwwLS41LTIuMjcsNC4xMSw0LjExLDAsMCwwLTEuMjgtMS40NywyLjc0LDIuNzQsMCwwLDAtMS41Ni0uNTNoLTYuMzhaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjMyLjI4LDE2Mi4wOHY2LjM0aC0yMlYxMzcuMThoMjEuNTZ2Ni4zM0gyMTcuNTR2Ni4wOGgxMi4zMnY1Ljg1SDIxNy41NHY2LjY0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI0OC40NywxNTAuNTF2MTcuOTFoLTcuMjJWMTM3LjE4SDI0N2wxNC40OCwxOC4zOVYxMzcuMThoNy4xN3YzMS4yNGgtNS44NVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zMDMsMTQzLjUxaC05LjUxdjI0LjkxaC03LjIxVjE0My41MWgtOS41NXYtNi4zM0gzMDNaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMzE2LjA5LDEzNy4xOGg3Ljc1bDEwLjgyLDMxLjI0aC03LjM5bC0yLjEyLTdIMzE0Ljg0bC0yLjEzLDdoLTcuNFptNy41NywxOS4zMUwzMjAsMTQ0LjQ0bC0zLjY3LDEyLjA1WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM0Mi4yNywxNjguNDJWMTM3LjE4aDcuMjJ2MjQuOWgxNS4xNHY2LjM0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM5MS4zMywxNDYuMzNhNy4yOSw3LjI5LDAsMCwwLS45NC0uNjQsMTYuMjMsMTYuMjMsMCwwLDAtMi0xLDE1LjkxLDE1LjkxLDAsMCwwLTIuNTgtLjksMTAuODEsMTAuODEsMCwwLDAtMi44MS0uMzgsNS4yMiw1LjIyLDAsMCwwLTIuODYuNjYsMi4xMSwyLjExLDAsMCwwLTEsMS45MSwyLDIsMCwwLDAsLjc3LDEuNjQsNi41NSw2LjU1LDAsMCwwLDIuMjIsMS4wOWMxLC4zMSwyLjE1LjY1LDMuNTYsMWEyNy44NSwyNy44NSwwLDAsMSw1LjE5LDEuOTQsOC42LDguNiwwLDAsMSwzLjM3LDIuODUsOC4yMSw4LjIxLDAsMCwxLDEuMTcsNC42Myw5LjY4LDkuNjgsMCwwLDEtLjk1LDQuNDMsNy42Myw3LjYzLDAsMCwxLTIuNjQsMywxMi4wOCwxMi4wOCwwLDAsMS0zLjc4LDEuNjIsMTguODEsMTguODEsMCwwLDEtNC4zNC41LDIzLjA1LDIzLjA1LDAsMCwxLTQuNjgtLjQ5LDI2LjM2LDI2LjM2LDAsMCwxLTguNjUtMy4zOWwzLjEyLTYuMzNhNS42Myw1LjYzLDAsMCwwLDEuMTkuODMsMjIuMTIsMjIuMTIsMCwwLDAsMi40LDEuMjEsMjQuMDYsMjQuMDYsMCwwLDAsMy4xOSwxLjE1LDEyLjU5LDEyLjU5LDAsMCwwLDMuNTIuNTEsNS40LDUuNCwwLDAsMCwyLjkzLS42MywxLjkxLDEuOTEsMCwwLDAsLjk0LTEuNjksMi4wOSwyLjA5LDAsMCwwLTEtMS44MSwxMC43MywxMC43MywwLDAsMC0yLjY4LTEuMjNjLTEuMTMtLjM2LTIuNDMtLjc1LTMuOS0xLjE1YTI2LjA5LDI2LjA5LDAsMCwxLTQuNzMtMiw3LjMxLDcuMzEsMCwwLDEtMi43Ny0yLjY1LDcuNjksNy42OSwwLDAsMS0uOS0zLjg5LDkuNTUsOS41NSwwLDAsMSwxLjU2LTUuNTcsOS43Myw5LjczLDAsMCwxLDQuMi0zLjQsMTQuMDYsMTQuMDYsMCwwLDEsNS43Ny0xLjE2LDE2LjU0LDE2LjU0LDAsMCwxLDQuMjcuNTMsMjYuMzksMjYuMzksMCwwLDEsMy44MiwxLjMxLDI0LjM0LDI0LjM0LDAsMCwxLDMuMTMsMS42M1oiLz48L2c+PC9nPjwvc3ZnPg==" alt="Peak Party Rentals">
      <div class="tb-logo-divider"></div>
      <div class="tb-logo-text">
        <span class="tb-planner-label">Floor Planner</span>
        <span class="tb-tagline">Take your events to greater heights</span>
      </div>
    </div>
    <div class="tb-sect">
      <span class="tb-label">Tent</span>
      <select class="tb-select" id="preset" onchange="applyPreset()" style="width:80px;">
        <option value="">Custom</option>
        <option value="20,30">20√ó30</option><option value="20,40">20√ó40</option>
        <option value="20,50">20√ó50</option><option value="20,60">20√ó60</option>
        <option value="30,45">30√ó45</option><option value="30,60">30√ó60</option>
        <option value="30,75">30√ó75</option><option value="40,60">40√ó60</option>
        <option value="40,80">40√ó80</option><option value="40,100">40√ó100</option>
        <option value="40,120">40√ó120</option><option value="60,100">60√ó100</option>
        <option value="60,120">60√ó120</option>
      </select>
      <input class="tb-input" type="number" id="tw" value="30" min="10" max="300" onchange="updateTent()" title="Width ft">
      <span class="tb-label" style="color:rgba(255,255,255,0.18);">√ó</span>
      <input class="tb-input" type="number" id="tl" value="60" min="10" max="300" onchange="updateTent()" title="Length ft">
    </div>
    <div class="tb-sect">
      <button class="tb-btn active" id="btn-select" onclick="setTool('select')" title="Select (V)">‚ñ¢</button>
      <button class="tb-btn"        id="btn-pan"    onclick="setTool('pan')"    title="Pan (H)">‚úã</button>
    </div>
    <div class="tb-sect">
      <button class="tb-btn" id="btn-undo" onclick="undo()" disabled title="Undo Ctrl+Z">‚Ü©</button>
      <button class="tb-btn" id="btn-redo" onclick="redo()" disabled title="Redo Ctrl+Y">‚Ü™</button>
      <div class="sep"></div>
      <button class="tb-btn" id="btn-dup" onclick="duplicate()" disabled title="Duplicate Ctrl+D">‚ßâ</button>
      <button class="tb-btn" id="btn-del" onclick="deleteSelected()" disabled title="Delete">‚úï</button>
    </div>
    <div class="tb-sect" style="position:relative;">
      <button class="tb-btn" id="btn-align-toggle" onclick="toggleAlignMenu()" title="Align &amp; Distribute">‚äü Align ‚ñæ</button>
      <div id="align-menu" class="tb-dropdown" style="display:none;width:200px;">
        <div class="tb-dd-label">Align</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:8px;">
          <button class="tb-btn dd-btn" onclick="alignSel('left');closeAlignMenu()">‚¨° L</button>
          <button class="tb-btn dd-btn" onclick="alignSel('centerH');closeAlignMenu()">‚äü H</button>
          <button class="tb-btn dd-btn" onclick="alignSel('right');closeAlignMenu()">‚¨° R</button>
          <button class="tb-btn dd-btn" onclick="alignSel('top');closeAlignMenu()">‚¨° T</button>
          <button class="tb-btn dd-btn" onclick="alignSel('centerV');closeAlignMenu()">‚äü V</button>
          <button class="tb-btn dd-btn" onclick="alignSel('bottom');closeAlignMenu()">‚¨° B</button>
        </div>
        <div class="tb-dd-label">Distribute</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
          <button class="tb-btn dd-btn" onclick="distribute('h');closeAlignMenu()">‚áø H</button>
          <button class="tb-btn dd-btn" onclick="distribute('v');closeAlignMenu()">‚áø V</button>
        </div>
      </div>
    </div>
    <div class="tb-sect">
      <button class="tb-btn" onclick="zoomStep(-1)" title="Zoom Out">‚àí</button>
      <span class="zoom-display" id="zoom-lbl">100%</span>
      <button class="tb-btn" onclick="zoomStep(1)" title="Zoom In">+</button>
      <button class="tb-btn" onclick="fitView()" title="Fit">‚ä°</button>
    </div>
    <div class="tb-sect" style="position:relative;">
      <button class="tb-btn" id="btn-view-toggle" onclick="toggleViewMenu()" title="Grid &amp; Snap">‚äû View ‚ñæ</button>
      <div id="view-menu" class="tb-dropdown" style="display:none;width:162px;">
        <button class="tb-btn dd-btn active" id="btn-grid" onclick="toggleGrid()" style="width:100%;justify-content:flex-start;">‚äû Grid</button>
        <button class="tb-btn dd-btn active" id="btn-snap" onclick="toggleSnap()" style="width:100%;justify-content:flex-start;margin-top:4px;">‚äï Snap</button>
        <div class="tb-dd-label" style="margin-top:8px;">Snap Size</div>
        <select class="tb-select" id="snap-sz" onchange="snapSz=parseFloat(this.value)" style="width:100%;margin-top:4px;">
          <option value="0.5">¬Ω ft</option>
          <option value="1" selected>1 ft</option>
          <option value="2">2 ft</option>
        </select>
      </div>
    </div>
    <div class="tb-sect" style="border-right:none;">
      <div class="cap-pill">üë• <span id="cap-num">0</span></div>
    </div>
  </div>
  <div id="tb-right">
    <button class="tb-btn send-btn" onclick="openSendModal()" title="Generate email &amp; PDF for client">üìß Send to Client</button>
    <button class="tb-btn danger" onclick="clearAll()" title="Clear canvas">üóë</button>
    <button class="tb-btn tb-3d-btn" id="btn-3d" onclick="open3DView()" title="3D Preview">‚¨° 3D View</button>
    <button class="tb-btn print-btn" onclick="printLayout()">üñ® Print</button>
    <div class="tb-brand-badge" title="Exclusively built for Peak Party Rentals customers">
      <div class="tb-badge-icon">‚õ∞</div>
      <div class="tb-badge-text">
        <div class="tb-badge-top">Built exclusively for</div>
        <div class="tb-badge-bot">Peak Party Rentals</div>
      </div>
    </div>
  </div>
</div>

<div id="body">
  <!-- PALETTE -->
  <div id="palette">
    <!-- Accessories header -->
    <div id="pal-hdr-bar">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:5px;flex-shrink:0;"><rect x="3" y="8" width="18" height="3" rx="1.5"/><line x1="8" y1="11" x2="8" y2="20"/><line x1="16" y1="11" x2="16" y2="20"/><line x1="5" y1="20" x2="11" y2="20"/><line x1="13" y1="20" x2="19" y2="20"/></svg>
      Accessories
    </div>
    <!-- Accessories list -->
    <div id="pal-inner"></div>
  </div>

  <!-- CANVAS COLUMN -->
  <div id="canvas-col">
    <!-- SCENE TAB BAR -->
    <div id="scene-tab-bar"></div>

    <!-- TENT CANVAS -->
    <div id="canvas-area">
      <div id="sel-rect"></div>
      <div id="grp-box"></div>
      <div id="ev-banner"><div class="evb-name" id="evb-name"></div><div class="evb-det" id="evb-det"></div></div>
      <div id="world">
        <div id="print-header"></div>
        <div id="tent"><canvas id="grid-cvs"></canvas></div>
      </div>
    </div>

    <!-- FIELD VIEW CANVAS -->
    <div id="field-canvas-wrap" style="display:none;flex:1;position:relative;overflow:hidden;background:#2a3520;">
      <canvas id="field-cvs" style="position:absolute;top:0;left:0;"></canvas>
      <!-- Field toolbar -->
      <div id="field-toolbar">
        <button class="ftb-btn active" id="ftb-select" onclick="setFieldTool('select')">‚úã Move</button>
        <button class="ftb-btn" id="ftb-road" onclick="setFieldTool('road')">üõ£ Draw Road</button>
        <div style="width:1px;background:rgba(255,255,255,0.15);margin:0 4px;"></div>
        <button class="ftb-btn" onclick="_fieldZoomStep(-1)" title="Zoom out (-)">‚àí</button>
        <button class="ftb-btn" onclick="_fieldZoomStep(1)"  title="Zoom in (+)">+</button>
        <button class="ftb-btn" onclick="fieldFit()">‚ä° Fit All</button>
        <button class="ftb-btn" id="ftb-zoom-tent" onclick="if(fieldSelId){const i=scenes.findIndex(s=>s.id===fieldSelId);if(i>=0)zoomToScene(i);}else toast('Click a tent first')" title="Zoom to selected tent">üîç Zoom Tent</button>
        <button class="ftb-btn" onclick="deleteFieldSel()">‚úï Delete</button>
        <div style="width:1px;background:rgba(255,255,255,0.15);margin:0 4px;"></div>
        <span style="color:rgba(255,255,255,0.4);font-size:11.5px;font-style:italic;">Scroll to zoom ¬∑ Double-click tent to zoom in ¬∑ Double-click again to edit</span>
      </div>
      <!-- Road label input (hidden by default) -->
      <div id="road-label-popup" style="display:none;position:absolute;background:#1a2830;border:1px solid #0093c7;border-radius:8px;padding:10px;z-index:100;">
        <div style="font-size:11.5px;color:#7dd6f5;margin-bottom:6px;font-weight:600;">Road / Path Label</div>
        <input id="road-label-input" type="text" placeholder="e.g. Main Entrance Road" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:4px;padding:5px 8px;font-size:12.6px;width:200px;outline:none;">
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button onclick="confirmRoadLabel()" style="background:#0093c7;border:none;color:#fff;padding:4px 12px;border-radius:4px;font-size:11.5px;cursor:pointer;">Add</button>
          <button onclick="cancelRoadLabel()" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:#aaa;padding:4px 10px;border-radius:4px;font-size:11.5px;cursor:pointer;">Cancel</button>
        </div>
      </div>
      <!-- Compass rose -->
      <div id="compass" title="North">
        <svg width="40" height="40" viewBox="0 0 40 40">
          <circle cx="20" cy="20" r="18" fill="rgba(0,0,0,0.45)" stroke="rgba(255,255,255,0.15)" stroke-width="1"/>
          <polygon points="20,4 23,20 20,17 17,20" fill="#e74c3c"/>
          <polygon points="20,36 23,20 20,23 17,20" fill="rgba(255,255,255,0.5)"/>
          <text x="20" y="10" text-anchor="middle" fill="white" font-size="7" font-weight="bold" font-family="sans-serif">N</text>
        </svg>
      </div>
      <!-- Scale bar -->
      <div id="field-scale-bar">
        <div id="field-scale-line"></div>
        <div id="field-scale-label">100 ft</div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sb-tabs">
      <div class="sb-tab active" onclick="openTab('props')"   id="tab-props">Props</div>
      <div class="sb-tab"       onclick="openTab('summary')" id="tab-summary">Summary</div>
      <div class="sb-tab"       onclick="openTab('upsell')"  id="tab-upsell">Upsells</div>
      <div class="sb-tab"       onclick="openTab('saves')"   id="tab-saves">Saves</div>
    </div>

    <!-- PROPERTIES -->
    <div class="sb-panel active" id="panel-props">
      <div id="no-sel" class="no-sel">Click an item to edit</div>
      <div id="sel-props" style="display:none;">
        <div class="prop-section">
          <div class="prop-title">Position</div>
          <div class="prop-row"><span class="prop-lbl">X (ft)</span><input class="prop-input" type="number" id="px" step="0.5" min="0" onchange="propChange('x')"></div>
          <div class="prop-row"><span class="prop-lbl">Y (ft)</span><input class="prop-input" type="number" id="py" step="0.5" min="0" onchange="propChange('y')"></div>
        </div>
        <div class="prop-section">
          <div class="prop-title">Size</div>
          <div class="prop-row"><span class="prop-lbl">Width (ft)</span><input class="prop-input" type="number" id="pw" step="0.5" min="0.5" onchange="propChange('w')"></div>
          <div class="prop-row"><span class="prop-lbl">Depth (ft)</span><input class="prop-input" type="number" id="ph" step="0.5" min="0.5" onchange="propChange('h')"></div>
        </div>
        <div class="prop-section">
          <div class="prop-title">Actions</div>
          <div class="prop-row" style="align-items:center;gap:8px;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;">
              <div style="font-size:10.3px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;">Rotation</div>
              <div style="display:flex;align-items:center;gap:5px;width:100%;">
                <canvas id="rot-dial" width="40" height="40" title="Drag to rotate freely" style="cursor:crosshair;flex-shrink:0;"></canvas>
                <div style="display:flex;flex-direction:column;gap:3px;flex:1;">
                  <input id="rot-input" type="number" class="prop-input" min="0" max="359" step="1" value="0" onchange="setRotDeg(parseFloat(this.value),true)" style="width:100%;">
                  <div style="display:flex;gap:3px;">
                    <button class="prop-btn" onclick="setRotDeg(0,true)" style="flex:1;padding:3px 4px;font-size:10.3px;">0¬∞</button>
                    <button class="prop-btn" onclick="setRotDeg(90,true)" style="flex:1;padding:3px 4px;font-size:10.3px;">90¬∞</button>
                    <button class="prop-btn" onclick="setRotDeg(180,true)" style="flex:1;padding:3px 4px;font-size:10.3px;">180¬∞</button>
                    <button class="prop-btn" onclick="setRotDeg(270,true)" style="flex:1;padding:3px 4px;font-size:10.3px;">270¬∞</button>
                  </div>
                </div>
              </div>
            </div>
            <button class="prop-btn accent" id="lock-btn" onclick="toggleLock()" style="align-self:flex-end;">üîì Lock</button>
          </div>
          <div class="prop-row">
            <button class="prop-btn" onclick="bringFront()">‚¨Ü Front</button>
            <button class="prop-btn" onclick="sendBack()">‚¨á Back</button>
          </div>
          <div class="prop-row" style="margin-top:4px;">
            <button class="prop-btn danger" onclick="deleteSelected()">‚úï Delete</button>
          </div>
        </div>
        <div class="prop-section">
          <div class="prop-title">‚Üî Directional Duplicate</div>
          <div style="font-size:10.3px;color:var(--muted);margin-bottom:8px;line-height:1.5;">Duplicates item at equal spacing. Matches gap from nearest neighbor, or uses last-used spacing.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:6px;">
            <div></div>
            <button class="prop-btn accent" onclick="dirDupe('up')"    title="Shift+‚Üë" style="justify-content:center;font-size:14.9px;">‚Üë</button>
            <div></div>
            <button class="prop-btn accent" onclick="dirDupe('left')"  title="Shift+‚Üê" style="justify-content:center;font-size:14.9px;">‚Üê</button>
            <button class="prop-btn accent" onclick="dirDupe('down')"  title="Shift+‚Üì" style="justify-content:center;font-size:14.9px;">‚Üì</button>
            <button class="prop-btn accent" onclick="dirDupe('right')" title="Shift+‚Üí" style="justify-content:center;font-size:14.9px;">‚Üí</button>
          </div>
          <div class="prop-row">
            <span class="prop-lbl">Gap override (ft)</span>
            <input class="prop-input" type="number" id="dupe-gap" value="" min="0" max="20" step="0.5" placeholder="auto" style="width:60px;" title="Leave blank to auto-detect from neighbors">
          </div>
          <button class="prop-btn accent" style="width:100%;justify-content:center;margin-top:4px;" onclick="dupeRow()">‚äû Fill Row ‚Üí</button>
          <button class="prop-btn accent" style="width:100%;justify-content:center;margin-top:4px;" onclick="dupeCol()">‚äü Fill Column ‚Üì</button>
        </div>
        <div class="prop-section" id="seats-section">
          <div class="prop-title">Seating</div>
          <div class="prop-row"><span class="prop-lbl">Seats</span><span class="prop-val" id="prop-seats">‚Äî</span></div>
          <div class="prop-row"><span class="prop-lbl">Table #</span><span class="prop-val" id="prop-tnum">‚Äî</span></div>
        </div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="sb-panel" id="panel-summary"><div id="summary-content"></div></div>



    <!-- UPSELLS -->
    <div class="sb-panel" id="panel-upsell">
      <div class="prop-section">
        <div class="prop-title">üí° Smart Suggestions</div>
        <div id="upsell-smart"><span style="font-size:11.5px;color:var(--muted);font-style:italic;">Add items to the canvas to get suggestions</span></div>
      </div>
      <div class="prop-section">
        <div class="prop-title">‚úÖ Add-On Checklist</div>
        <div id="upsell-list"></div>
        <button class="prop-btn accent" style="width:100%;justify-content:center;margin-top:8px;" onclick="copyUpsellQuote()">üìã Copy Quote to Clipboard</button>
      </div>
    </div>

    <!-- SAVES -->
    <div class="sb-panel" id="panel-saves">
      <div class="prop-title" style="margin-bottom:8px;">Save Layout</div>
      <input class="save-input" type="text" id="cname" placeholder="Client / event name‚Ä¶">
      <button class="save-btn" onclick="saveLayout()">üíæ Save to This Browser</button>

      <div class="prop-title" style="margin-bottom:8px;margin-top:4px;">üì§ Share with Team</div>
      <div style="font-size:10.9px;color:var(--muted);margin-bottom:8px;line-height:1.5;">Export a <code style="background:var(--panel);padding:1px 4px;border-radius:3px;font-size:10.3px;">.json</code> file anyone on your team can import ‚Äî even on a different computer.</div>
      <button class="prop-btn accent" style="width:100%;justify-content:center;margin-bottom:5px;" onclick="exportLayout()">üì§ Export Layout File</button>
      <label class="prop-btn accent" style="width:100%;justify-content:center;cursor:pointer;margin-bottom:12px;">
        üì• Import Layout File
        <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importLayout(event)">
      </label>

      <div class="prop-title" style="margin-bottom:8px;">Saved Layouts</div>
      <div id="saves-list"></div>
    </div>
  </div>
</div>

<!-- EVENT BAR -->
<div id="event-bar">
  <!-- Toggle header -->
  <div id="event-bar-hdr" onclick="toggleEventBar()">
    <span id="event-bar-arrow" class="eb-arrow">‚ñ≤</span>
    <span class="eb-title">üìã Event Details</span>
    <span id="event-bar-summary" class="eb-summary"></span>
    <span class="eb-hint">Click to collapse</span>
  </div>
  <!-- Content row -->
  <div id="event-bar-body">
    <div class="eb-col">
      <label class="ev-lbl">Client Name</label>
      <input class="ev-input" id="ev-client" type="text" placeholder="e.g. Johnson Family" oninput="refreshEvent()">
      <label class="ev-lbl" style="margin-top:6px;">Event Type</label>
      <select class="ev-input" id="ev-type" onchange="refreshEvent()">
        <option value="">‚Äî Select type ‚Äî</option>
        <option>üéì Graduation Party</option>
        <option>üíç Wedding</option>
        <option>üè¢ Corporate Event</option>
        <option>üéÇ Birthday Party</option>
        <option>üéâ Social Gathering</option>
        <option>üçΩ Rehearsal Dinner</option>
        <option>‚õ™ Religious Celebration</option>
        <option>üé™ Festival / Fair</option>
      </select>
    </div>
    <div class="eb-col">
      <label class="ev-lbl">Event Date</label>
      <input class="ev-input" id="ev-date" type="date" oninput="refreshEvent()">
      <label class="ev-lbl" style="margin-top:6px;">Venue / Address</label>
      <input class="ev-input" id="ev-venue" type="text" placeholder="e.g. 123 Main St, Yardley PA" oninput="refreshEvent()">
    </div>
    <div class="eb-col">
      <label class="ev-lbl">Est. Guest Count</label>
      <input class="ev-input" id="ev-guests" type="number" placeholder="e.g. 80" min="1" oninput="refreshEvent()">
      <label class="ev-lbl" style="margin-top:6px;">Personal Note</label>
      <textarea class="ev-input" id="ev-note" rows="2" placeholder="Message for the client‚Ä¶" oninput="refreshEvent()" style="resize:none;"></textarea>
    </div>
    <div class="eb-col eb-preview-col">
      <div class="ev-lbl" style="margin-bottom:4px;">Preview</div>
      <div id="ev-preview" class="ev-preview-box" style="max-height:90px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<div id="statusbar">
  <div class="status-item" id="st-pos">Cursor: <span>‚Äî</span></div>
  <div class="status-item" id="st-size">Size: <span>‚Äî</span></div>
  <div class="status-item">Items: <span id="st-count">0</span></div>
  <div class="status-item" style="margin-left:auto;">Peak Party Rentals ¬∑ PA, NJ & DE ¬∑ <span>(215) 385-4040</span></div>
</div>

<!-- ‚ïê‚ïê SEND TO CLIENT MODAL ‚ïê‚ïê -->
<div id="send-modal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;">
  <div id="send-modal-inner" style="background:#fff;border-radius:16px;width:92vw;max-width:1060px;height:88vh;max-height:820px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,0.45);">
    
    <!-- Modal header -->
    <div style="background:linear-gradient(135deg,#0d1c26,#1a2e3c);padding:18px 24px;border-bottom:3px solid #0093c7;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
      <div>
        <div style="font-size:17px;font-weight:800;color:#fff;display:flex;align-items:center;gap:10px;">
          üìß Send to Client
          <span style="font-size:10px;background:#0093c7;color:#fff;padding:3px 8px;border-radius:10px;font-weight:700;letter-spacing:0.5px;">EMAIL + PDF</span>
        </div>
        <div style="font-size:12px;color:rgba(255,255,255,0.45);margin-top:3px;">Generate a personalised client email and branded PDF floor plan ‚Äî together</div>
      </div>
      <button onclick="closeSendModal()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:18px;width:34px;height:34px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">‚úï</button>
    </div>

    <!-- Modal body: two columns -->
    <div style="display:flex;flex:1;min-height:0;">

      <!-- LEFT: Controls -->
      <div style="width:320px;flex-shrink:0;border-right:1px solid #d0e4ee;display:flex;flex-direction:column;overflow-y:auto;background:#f8fbfd;">
        
        <!-- Event summary (from floor planner) -->
        <div style="padding:14px 16px;border-bottom:1px solid #d0e4ee;">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#5a7a88;margin-bottom:8px;">Event Details (from Floor Planner)</div>
          <div id="sm-event-summary" style="font-size:12.5px;color:#30393d;line-height:1.6;"></div>
          <div style="font-size:11px;color:#0093c7;margin-top:6px;cursor:pointer;font-weight:600;" onclick="openPalTab('event');closeSendModal();">‚úè Edit in Event Details ‚Üó</div>
        </div>

        <!-- Upsell picker -->
        <div style="padding:14px 16px;border-bottom:1px solid #d0e4ee;flex:1;">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#5a7a88;margin-bottom:4px;">Recommended Add-Ons to Include</div>
          <div style="font-size:11px;color:#5a7a88;margin-bottom:10px;">Check the ones you want in the email and PDF</div>
          <div id="sm-upsell-list" style="display:flex;flex-direction:column;gap:5px;"></div>
        </div>

        <!-- Action buttons -->
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:8px;flex-shrink:0;border-top:2px solid #d0e4ee;background:#fff;">
          <button id="sm-copy-btn" onclick="smCopyEmail()" style="width:100%;padding:11px;background:#0093c7;color:#fff;border:none;border-radius:8px;font-size:13.5px;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:7px;" onmouseover="this.style.background='#007aab'" onmouseout="this.style.background='#0093c7'">
            üìã Copy Email to Clipboard
          </button>
          <button id="sm-pdf-btn" onclick="smDownloadPDF()" style="width:100%;padding:11px;background:transparent;color:#0093c7;border:2px solid #0093c7;border-radius:8px;font-size:13.5px;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:7px;" onmouseover="this.style.background='#0093c7';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#0093c7'">
            ‚¨á Download PDF Floor Plan
          </button>
          <div style="font-size:11px;color:#5a7a88;text-align:center;line-height:1.5;">Copy the email ‚Üí paste into Gmail or Outlook.<br>Attach the PDF to the same email.</div>
        </div>
      </div>

      <!-- RIGHT: Live email preview -->
      <div style="flex:1;overflow-y:auto;background:#e8ecef;padding:20px;">
        <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#5a7a88;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
          Live Email Preview
          <span style="font-size:10px;font-weight:600;color:#aaa;text-transform:none;letter-spacing:0;">(updates as you check/uncheck)</span>
        </div>
        <!-- Gmail chrome simulation -->
        <div style="background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,0.1);">
          <div style="background:#f1f3f4;padding:8px 14px;border-bottom:1px solid #d0d0d0;display:flex;align-items:center;gap:6px;">
            <div style="width:10px;height:10px;border-radius:50%;background:#ff5f57;"></div>
            <div style="width:10px;height:10px;border-radius:50%;background:#ffbd2e;"></div>
            <div style="width:10px;height:10px;border-radius:50%;background:#28c840;"></div>
            <span style="font-size:11px;color:#888;margin-left:8px;">New Message ‚Äî Gmail</span>
          </div>
          <div style="padding:12px 18px;border-bottom:1px solid #eee;background:#fafafa;">
            <div style="display:flex;gap:8px;font-size:12px;margin-bottom:3px;"><span style="font-weight:700;color:#888;min-width:52px;">From:</span><span>Peak Party Rentals &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f49182919a8087b48491959f849586808d86919a80959887da979b99">[email&#160;protected]</a>&gt;</span></div>
            <div style="display:flex;gap:8px;font-size:12px;margin-bottom:3px;"><span style="font-weight:700;color:#888;min-width:52px;">To:</span><span id="sm-ep-to">‚Äî</span></div>
            <div style="display:flex;gap:8px;font-size:12px;"><span style="font-weight:700;color:#888;min-width:52px;">Subject:</span><span id="sm-ep-subject" style="font-weight:600;">‚Äî</span></div>
          </div>
          <div id="sm-email-body" style="font-family:'DM Sans',sans-serif;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ‚îÄ‚îÄ LOGOS ‚îÄ‚îÄ
const LOGO_DARK_B64  = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTUuNDMgMTY4LjY0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6IzAwOTNjNzt9LmNscy0ze2ZpbGw6IzQxYjhlYTt9PC9zdHlsZT48L2RlZnM+PGcgaWQ9IkxheWVyXzIiIGRhdGEtbmFtZT0iTGF5ZXIgMiI+PGcgaWQ9IkxheWVyXzEtMiIgZGF0YS1uYW1lPSJMYXllciAxIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xLDExMVY5LjA1YTMsMywwLDAsMSwzLTNINDcuNTJBMzMuNCwzMy40LDAsMCwxLDYyLjExLDkuMjVhMzYuNTYsMzYuNTYsMCwwLDEsMTEuNTUsOC41OSw0MCw0MCwwLDAsMSw3LjUzLDEyLjA4LDM2LjQxLDM2LjQxLDAsMCwxLDIuNjYsMTMuNTMsMzguMjksMzguMjksMCwwLDEtNC40OSwxOC4wOUEzNy44OCwzNy44OCwwLDAsMSw2Ni45LDc1LjQ1YTMyLjUsMzIuNSwwLDAsMS0xOC42Miw1LjM5SDMwLjY1VjExMWEzLDMsMCwwLDEtMywzSDRBMywzLDAsMCwxLDEsMTExWk0zMC42NSw1My40NkExLjU0LDEuNTQsMCwwLDAsMzIuMTksNTVINDYuM2E2LjQyLDYuNDIsMCwwLDAsMy41LTEuMDYsOCw4LDAsMCwwLDIuODEtMy42NSwxNy4xNSwxNy4xNSwwLDAsMCwxLjE0LTYuODQsMTUuNzMsMTUuNzMsMCwwLDAtMS4yOS03LjA3LDcuNzcsNy43NywwLDAsMC0zLjE5LTMuNDksOCw4LDAsMCwwLTMuNzMtMUgzMi4xOWExLjU0LDEuNTQsMCwwLDAtMS41NCwxLjU0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE2OS41Nyw5MS4xNlYxMTFhMywzLDAsMCwxLTMsM0g5NS42OGEzLDMsMCwwLDEtMy0zVjkuMDhhMywzLDAsMCwxLDMtM2g2OS41YTMsMywwLDAsMSwzLDN2MTkuOGEzLDMsMCwwLDEtMywzSDEyMy43OWExLjQ5LDEuNDksMCwwLDAtMS40OSwxLjQ5VjQ1LjYxYTEuNDksMS40OSwwLDAsMCwxLjQ5LDEuNDloMzQuN2EzLDMsMCwwLDEsMywzdjE4YTMsMywwLDAsMS0zLDNoLTM0LjdhMS40OSwxLjQ5LDAsMCwwLTEuNDksMS40OVY4Ni42NWExLjQ5LDEuNDksMCwwLDAsMS40OSwxLjQ5aDQyLjc2QTMsMywwLDAsMSwxNjkuNTcsOTEuMTZaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjk3LjQ2LDExMVY5LjA4YTMsMywwLDAsMSwzLTNoMjMuNmEzLDMsMCwwLDEsMywzdjMzLjhhMS40OCwxLjQ4LDAsMCwwLDIuNjQuOTJMMzU5LjIzLDYuOTNhMi4zNCwyLjM0LDAsMCwxLDEuODItLjg3aDI3YTIuNTIsMi41MiwwLDAsMSwyLDQuMTFMMzU0LjkxLDUzLjQ2YTEuNjEsMS42MSwwLDAsMC0uMDYsMS45MkwzOTMuMzEsMTEwYTIuNTIsMi41MiwwLDAsMS0yLjA2LDRIMzYzLjNhMi4zMiwyLjMyLDAsMCwxLTEuOTMtMUwzMzYuNTMsNzYuMTFhMS43NywxLjc3LDAsMCwwLTIuNzMtLjI0bC01LjE0LDUuMzNhNS41Nyw1LjU3LDAsMCwwLTEuNTYsMy44N1YxMTFhMywzLDAsMCwxLTMsM2gtMjMuNkEzLDMsMCwwLDEsMjk3LjQ2LDExMVoiLz48cGF0aCBjbGFzcz0iY2xzLTIiIGQ9Ik0yODIuNTgsMTA2Ljg2LDI0MC4xNiw1LjIyYTguNDgsOC40OCwwLDAsMC0xNS42NiwwTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVWNTguNmg0Ljc3djQuOWwxOC4zNiw3LjgtMTguMzYsNy44Vjg1bDM3LjY1LDMwLjY5QTcuMDksNy4wOSwwLDAsMCwyODIuNTgsMTA2Ljg2WiIvPjxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTIzMCw1OC42aDIuMzJWMGE4LjM2LDguMzYsMCwwLDAtNy44Miw1LjIyTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMCwxNjguNDJWMTM3LjE4SDEzLjMzYTkuMDcsOS4wNywwLDAsMSw0LjA5LjkyLDExLjIyLDExLjIyLDAsMCwxLDMuMjQsMi40MiwxMC45MSwxMC45MSwwLDAsMSwyLjEzLDMuMzksMTAuNDEsMTAuNDEsMCwwLDEsLjc1LDMuODcsMTEsMTEsMCwwLDEtMS4yNSw1LjA4LDEwLjU4LDEwLjU4LDAsMCwxLTMuNDgsNCw5LDksMCwwLDEtNS4yMSwxLjUySDcuMjJ2MTAuMDhaTTcuMjIsMTUyaDUuODlhMi42NSwyLjY1LDAsMCwwLDEuNTItLjQ3LDMuMjcsMy4yNywwLDAsMCwxLjEyLTEuNDMsNS42Myw1LjYzLDAsMCwwLC40NC0yLjMzLDUuMzgsNS4zOCwwLDAsMC0uNDgtMi40NEEzLjMsMy4zLDAsMCwwLDE0LjQ1LDE0NGEzLjIyLDMuMjIsMCwwLDAtMS42LS40NEg3LjIyWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM3LjU4LDEzNy4xOGg3Ljc0bDEwLjgyLDMxLjI0SDQ4Ljc1bC0yLjEyLTdIMzYuMzJsLTIuMTMsN0gyNi44Wm03LjU2LDE5LjMxLTMuNjUtMTIuMDUtMy42NywxMi4wNVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik02My43NiwxNjguNDJWMTM3LjE4aDE0YTkuMzgsOS4zOCwwLDAsMSw0LjE0LjkyLDEwLjQyLDEwLjQyLDAsMCwxLDMuMjMsMi40MiwxMS40MywxMS40MywwLDAsMSwyLjExLDMuMzksMTAsMTAsMCwwLDEsLjc3LDMuODcsMTAuNzQsMTAuNzQsMCwwLDEtLjYzLDMuNjUsMTAuMTgsMTAuMTgsMCwwLDEtMS43OSwzLjEzLDkuNjIsOS42MiwwLDAsMS0yLjY4LDIuMjRsNi44NiwxMS42MmgtOGwtNi0xMC4wOEg3MXYxMC4wOFpNNzEsMTUyaDYuNjVhMi40MiwyLjQyLDAsMCwwLDEuNTEtLjUzLDMuODYsMy44NiwwLDAsMCwxLjEzLTEuNSw1LjMsNS4zLDAsMCwwLC40NC0yLjIsNC43NSw0Ljc1LDAsMCwwLS41MS0yLjI3QTQsNCwwLDAsMCw3OC45MSwxNDRhMi43NCwyLjc0LDAsMCwwLTEuNTYtLjUzSDcxWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTEyMS4yMiwxNDMuNTFoLTkuNXYyNC45MUgxMDQuNVYxNDMuNTFIOTV2LTYuMzNoMjYuMjdaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMTM0LjExLDEzNy4xOCwxNDAuODQsMTUxbDYuODctMTMuODFoNy44N2wtMTEuMTMsMjAuNTl2MTAuNjVoLTcuMTdWMTU3LjY4bC0xMS0yMC41WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE3Ni4yNiwxNjguNDJWMTM3LjE4aDE0YTkuNDEsOS40MSwwLDAsMSw0LjE0LjkyLDEwLjU0LDEwLjU0LDAsMCwxLDMuMjMsMi40MiwxMS42NCwxMS42NCwwLDAsMSwyLjExLDMuMzksMTAuMjMsMTAuMjMsMCwwLDEsLjc3LDMuODcsMTAuNTEsMTAuNTEsMCwwLDEtLjY0LDMuNjUsMTAuMTUsMTAuMTUsMCwwLDEtMS43OCwzLjEzLDkuNzYsOS43NiwwLDAsMS0yLjY4LDIuMjRsNi44NiwxMS42MmgtOGwtNi0xMC4wOGgtNC44OHYxMC4wOFpNMTgzLjQ4LDE1Mmg2LjY0YTIuNDIsMi40MiwwLDAsMCwxLjUyLS41MywzLjc1LDMuNzUsMCwwLDAsMS4xMi0xLjUsNS4xNSw1LjE1LDAsMCwwLC40NC0yLjIsNC44Nyw0Ljg3LDAsMCwwLS41LTIuMjcsNC4xMSw0LjExLDAsMCwwLTEuMjgtMS40NywyLjc0LDIuNzQsMCwwLDAtMS41Ni0uNTNoLTYuMzhaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjMyLjI4LDE2Mi4wOHY2LjM0aC0yMlYxMzcuMThoMjEuNTZ2Ni4zM0gyMTcuNTR2Ni4wOGgxMi4zMnY1Ljg1SDIxNy41NHY2LjY0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI0OC40NywxNTAuNTF2MTcuOTFoLTcuMjJWMTM3LjE4SDI0N2wxNC40OCwxOC4zOVYxMzcuMThoNy4xN3YzMS4yNGgtNS44NVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zMDMsMTQzLjUxaC05LjUxdjI0LjkxaC03LjIxVjE0My41MWgtOS41NXYtNi4zM0gzMDNaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMzE2LjA5LDEzNy4xOGg3Ljc1bDEwLjgyLDMxLjI0aC03LjM5bC0yLjEyLTdIMzE0Ljg0bC0yLjEzLDdoLTcuNFptNy41NywxOS4zMUwzMjAsMTQ0LjQ0bC0zLjY3LDEyLjA1WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM0Mi4yNywxNjguNDJWMTM3LjE4aDcuMjJ2MjQuOWgxNS4xNHY2LjM0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM5MS4zMywxNDYuMzNhNy4yOSw3LjI5LDAsMCwwLS45NC0uNjQsMTYuMjMsMTYuMjMsMCwwLDAtMi0xLDE1LjkxLDE1LjkxLDAsMCwwLTIuNTgtLjksMTAuODEsMTAuODEsMCwwLDAtMi44MS0uMzgsNS4yMiw1LjIyLDAsMCwwLTIuODYuNjYsMi4xMSwyLjExLDAsMCwwLTEsMS45MSwyLDIsMCwwLDAsLjc3LDEuNjQsNi41NSw2LjU1LDAsMCwwLDIuMjIsMS4wOWMxLC4zMSwyLjE1LjY1LDMuNTYsMWEyNy44NSwyNy44NSwwLDAsMSw1LjE5LDEuOTQsOC42LDguNiwwLDAsMSwzLjM3LDIuODUsOC4yMSw4LjIxLDAsMCwxLDEuMTcsNC42Myw5LjY4LDkuNjgsMCwwLDEtLjk1LDQuNDMsNy42Myw3LjYzLDAsMCwxLTIuNjQsMywxMi4wOCwxMi4wOCwwLDAsMS0zLjc4LDEuNjIsMTguODEsMTguODEsMCwwLDEtNC4zNC41LDIzLjA1LDIzLjA1LDAsMCwxLTQuNjgtLjQ5LDI2LjM2LDI2LjM2LDAsMCwxLTguNjUtMy4zOWwzLjEyLTYuMzNhNS42Myw1LjYzLDAsMCwwLDEuMTkuODMsMjIuMTIsMjIuMTIsMCwwLDAsMi40LDEuMjEsMjQuMDYsMjQuMDYsMCwwLDAsMy4xOSwxLjE1LDEyLjU5LDEyLjU5LDAsMCwwLDMuNTIuNTEsNS40LDUuNCwwLDAsMCwyLjkzLS42MywxLjkxLDEuOTEsMCwwLDAsLjk0LTEuNjksMi4wOSwyLjA5LDAsMCwwLTEtMS44MSwxMC43MywxMC43MywwLDAsMC0yLjY4LTEuMjNjLTEuMTMtLjM2LTIuNDMtLjc1LTMuOS0xLjE1YTI2LjA5LDI2LjA5LDAsMCwxLTQuNzMtMiw3LjMxLDcuMzEsMCwwLDEtMi43Ny0yLjY1LDcuNjksNy42OSwwLDAsMS0uOS0zLjg5LDkuNTUsOS41NSwwLDAsMSwxLjU2LTUuNTcsOS43Myw5LjczLDAsMCwxLDQuMi0zLjQsMTQuMDYsMTQuMDYsMCwwLDEsNS43Ny0xLjE2LDE2LjU0LDE2LjU0LDAsMCwxLDQuMjcuNTMsMjYuMzksMjYuMzksMCwwLDEsMy44MiwxLjMxLDI0LjM0LDI0LjM0LDAsMCwxLDMuMTMsMS42M1oiLz48L2c+PC9nPjwvc3ZnPg==";
const LOGO_LIGHT_B64 = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTUuNDMgMTY4LjY0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6IzMwMzkzZDt9LmNscy0ye2ZpbGw6IzAwOTNjNzt9LmNscy0ze2ZpbGw6IzQxYjhlYTt9PC9zdHlsZT48L2RlZnM+PGcgaWQ9IkxheWVyXzIiIGRhdGEtbmFtZT0iTGF5ZXIgMiI+PGcgaWQ9IkxheWVyXzEtMiIgZGF0YS1uYW1lPSJMYXllciAxIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xLDExMVY5LjA1YTMsMywwLDAsMSwzLTNINDcuNTJBMzMuNCwzMy40LDAsMCwxLDYyLjExLDkuMjVhMzYuNTYsMzYuNTYsMCwwLDEsMTEuNTUsOC41OSw0MCw0MCwwLDAsMSw3LjUzLDEyLjA4LDM2LjQxLDM2LjQxLDAsMCwxLDIuNjYsMTMuNTMsMzguMjksMzguMjksMCwwLDEtNC40OSwxOC4wOUEzNy44OCwzNy44OCwwLDAsMSw2Ni45LDc1LjQ1YTMyLjUsMzIuNSwwLDAsMS0xOC42Miw1LjM5SDMwLjY1VjExMWEzLDMsMCwwLDEtMywzSDRBMywzLDAsMCwxLDEsMTExWk0zMC42NSw1My40NkExLjU0LDEuNTQsMCwwLDAsMzIuMTksNTVINDYuM2E2LjQyLDYuNDIsMCwwLDAsMy41LTEuMDYsOCw4LDAsMCwwLDIuODEtMy42NSwxNy4xNSwxNy4xNSwwLDAsMCwxLjE0LTYuODQsMTUuNzMsMTUuNzMsMCwwLDAtMS4yOS03LjA3LDcuNzcsNy43NywwLDAsMC0zLjE5LTMuNDksOCw4LDAsMCwwLTMuNzMtMUgzMi4xOWExLjU0LDEuNTQsMCwwLDAtMS41NCwxLjU0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE2OS41Nyw5MS4xNlYxMTFhMywzLDAsMCwxLTMsM0g5NS42OGEzLDMsMCwwLDEtMy0zVjkuMDhhMywzLDAsMCwxLDMtM2g2OS41YTMsMywwLDAsMSwzLDN2MTkuOGEzLDMsMCwwLDEtMywzSDEyMy43OWExLjQ5LDEuNDksMCwwLDAtMS40OSwxLjQ5VjQ1LjYxYTEuNDksMS40OSwwLDAsMCwxLjQ5LDEuNDloMzQuN2EzLDMsMCwwLDEsMywzdjE4YTMsMywwLDAsMS0zLDNoLTM0LjdhMS40OSwxLjQ5LDAsMCwwLTEuNDksMS40OVY4Ni42NWExLjQ5LDEuNDksMCwwLDAsMS40OSwxLjQ5aDQyLjc2QTMsMywwLDAsMSwxNjkuNTcsOTEuMTZaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjk3LjQ2LDExMVY5LjA4YTMsMywwLDAsMSwzLTNoMjMuNmEzLDMsMCwwLDEsMywzdjMzLjhhMS40OCwxLjQ4LDAsMCwwLDIuNjQuOTJMMzU5LjIzLDYuOTNhMi4zNCwyLjM0LDAsMCwxLDEuODItLjg3aDI3YTIuNTIsMi41MiwwLDAsMSwyLDQuMTFMMzU0LjkxLDUzLjQ2YTEuNjEsMS42MSwwLDAsMC0uMDYsMS45MkwzOTMuMzEsMTEwYTIuNTIsMi41MiwwLDAsMS0yLjA2LDRIMzYzLjNhMi4zMiwyLjMyLDAsMCwxLTEuOTMtMUwzMzYuNTMsNzYuMTFhMS43NywxLjc3LDAsMCwwLTIuNzMtLjI0bC01LjE0LDUuMzNhNS41Nyw1LjU3LDAsMCwwLTEuNTYsMy44N1YxMTFhMywzLDAsMCwxLTMsM2gtMjMuNkEzLDMsMCwwLDEsMjk3LjQ2LDExMVoiLz48cGF0aCBjbGFzcz0iY2xzLTIiIGQ9Ik0yODIuNTgsMTA2Ljg2LDI0MC4xNiw1LjIyYTguNDgsOC40OCwwLDAsMC0xNS42NiwwTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVWNTguNmg0Ljc3djQuOWwxOC4zNiw3LjgtMTguMzYsNy44Vjg1bDM3LjY1LDMwLjY5QTcuMDksNy4wOSwwLDAsMCwyODIuNTgsMTA2Ljg2WiIvPjxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTIzMCw1OC42aDIuMzJWMGE4LjM2LDguMzYsMCwwLDAtNy44Miw1LjIyTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMCwxNjguNDJWMTM3LjE4SDEzLjMzYTkuMDcsOS4wNywwLDAsMSw0LjA5LjkyLDExLjIyLDExLjIyLDAsMCwxLDMuMjQsMi40MiwxMC45MSwxMC45MSwwLDAsMSwyLjEzLDMuMzksMTAuNDEsMTAuNDEsMCwwLDEsLjc1LDMuODcsMTEsMTEsMCwwLDEtMS4yNSw1LjA4LDEwLjU4LDEwLjU4LDAsMCwxLTMuNDgsNCw5LDksMCwwLDEtNS4yMSwxLjUySDcuMjJ2MTAuMDhaTTcuMjIsMTUyaDUuODlhMi42NSwyLjY1LDAsMCwwLDEuNTItLjQ3LDMuMjcsMy4yNywwLDAsMCwxLjEyLTEuNDMsNS42Myw1LjYzLDAsMCwwLC40NC0yLjMzLDUuMzgsNS4zOCwwLDAsMC0uNDgtMi40NEEzLjMsMy4zLDAsMCwwLDE0LjQ1LDE0NGEzLjIyLDMuMjIsMCwwLDAtMS42LS40NEg3LjIyWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM3LjU4LDEzNy4xOGg3Ljc0bDEwLjgyLDMxLjI0SDQ4Ljc1bC0yLjEyLTdIMzYuMzJsLTIuMTMsN0gyNi44Wm03LjU2LDE5LjMxLTMuNjUtMTIuMDUtMy42NywxMi4wNVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik02My43NiwxNjguNDJWMTM3LjE4aDE0YTkuMzgsOS4zOCwwLDAsMSw0LjE0LjkyLDEwLjQyLDEwLjQyLDAsMCwxLDMuMjMsMi40MiwxMS40MywxMS40MywwLDAsMSwyLjExLDMuMzksMTAsMTAsMCwwLDEsLjc3LDMuODcsMTAuNzQsMTAuNzQsMCwwLDEtLjYzLDMuNjUsMTAuMTgsMTAuMTgsMCwwLDEtMS43OSwzLjEzLDkuNjIsOS42MiwwLDAsMS0yLjY4LDIuMjRsNi44NiwxMS42MmgtOGwtNi0xMC4wOEg3MXYxMC4wOFpNNzEsMTUyaDYuNjVhMi40MiwyLjQyLDAsMCwwLDEuNTEtLjUzLDMuODYsMy44NiwwLDAsMCwxLjEzLTEuNSw1LjMsNS4zLDAsMCwwLC40NC0yLjIsNC43NSw0Ljc1LDAsMCwwLS41MS0yLjI3QTQsNCwwLDAsMCw3OC45MSwxNDRhMi43NCwyLjc0LDAsMCwwLTEuNTYtLjUzSDcxWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTEyMS4yMiwxNDMuNTFoLTkuNXYyNC45MUgxMDQuNVYxNDMuNTFIOTV2LTYuMzNoMjYuMjdaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMTM0LjExLDEzNy4xOCwxNDAuODQsMTUxbDYuODctMTMuODFoNy44N2wtMTEuMTMsMjAuNTl2MTAuNjVoLTcuMTdWMTU3LjY4bC0xMS0yMC41WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE3Ni4yNiwxNjguNDJWMTM3LjE4aDE0YTkuNDEsOS40MSwwLDAsMSw0LjE0LjkyLDEwLjU0LDEwLjU0LDAsMCwxLDMuMjMsMi40MiwxMS42NCwxMS42NCwwLDAsMSwyLjExLDMuMzksMTAuMjMsMTAuMjMsMCwwLDEsLjc3LDMuODcsMTAuNTEsMTAuNTEsMCwwLDEtLjY0LDMuNjUsMTAuMTUsMTAuMTUsMCwwLDEtMS43OCwzLjEzLDkuNzYsOS43NiwwLDAsMS0yLjY4LDIuMjRsNi44NiwxMS42MmgtOGwtNi0xMC4wOGgtNC44OHYxMC4wOFpNMTgzLjQ4LDE1Mmg2LjY0YTIuNDIsMi40MiwwLDAsMCwxLjUyLS41MywzLjc1LDMuNzUsMCwwLDAsMS4xMi0xLjUsNS4xNSw1LjE1LDAsMCwwLC40NC0yLjIsNC44Nyw0Ljg3LDAsMCwwLS41LTIuMjcsNC4xMSw0LjExLDAsMCwwLTEuMjgtMS40NywyLjc0LDIuNzQsMCwwLDAtMS41Ni0uNTNoLTYuMzhaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjMyLjI4LDE2Mi4wOHY2LjM0aC0yMlYxMzcuMThoMjEuNTZ2Ni4zM0gyMTcuNTR2Ni4wOGgxMi4zMnY1Ljg1SDIxNy41NHY2LjY0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI0OC40NywxNTAuNTF2MTcuOTFoLTcuMjJWMTM3LjE4SDI0N2wxNC40OCwxOC4zOVYxMzcuMThoNy4xN3YzMS4yNGgtNS44NVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zMDMsMTQzLjUxaC05LjUxdjI0LjkxaC03LjIxVjE0My41MWgtOS41NXYtNi4zM0gzMDNaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMzE2LjA5LDEzNy4xOGg3Ljc1bDEwLjgyLDMxLjI0aC03LjM5bC0yLjEyLTdIMzE0Ljg0bC0yLjEzLDdoLTcuNFptNy41NywxOS4zMUwzMjAsMTQ0LjQ0bC0zLjY3LDEyLjA1WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM0Mi4yNywxNjguNDJWMTM3LjE4aDcuMjJ2MjQuOWgxNS4xNHY2LjM0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM5MS4zMywxNDYuMzNhNy4yOSw3LjI5LDAsMCwwLS45NC0uNjQsMTYuMjMsMTYuMjMsMCwwLDAtMi0xLDE1LjkxLDE1LjkxLDAsMCwwLTIuNTgtLjksMTAuODEsMTAuODEsMCwwLDAtMi44MS0uMzgsNS4yMiw1LjIyLDAsMCwwLTIuODYuNjYsMi4xMSwyLjExLDAsMCwwLTEsMS45MSwyLDIsMCwwLDAsLjc3LDEuNjQsNi41NSw2LjU1LDAsMCwwLDIuMjIsMS4wOWMxLC4zMSwyLjE1LjY1LDMuNTYsMWEyNy44NSwyNy44NSwwLDAsMSw1LjE5LDEuOTQsOC42LDguNiwwLDAsMSwzLjM3LDIuODUsOC4yMSw4LjIxLDAsMCwxLDEuMTcsNC42Myw5LjY4LDkuNjgsMCwwLDEtLjk1LDQuNDMsNy42Myw3LjYzLDAsMCwxLTIuNjQsMywxMi4wOCwxMi4wOCwwLDAsMS0zLjc4LDEuNjIsMTguODEsMTguODEsMCwwLDEtNC4zNC41LDIzLjA1LDIzLjA1LDAsMCwxLTQuNjgtLjQ5LDI2LjM2LDI2LjM2LDAsMCwxLTguNjUtMy4zOWwzLjEyLTYuMzNhNS42Myw1LjYzLDAsMCwwLDEuMTkuODMsMjIuMTIsMjIuMTIsMCwwLDAsMi40LDEuMjEsMjQuMDYsMjQuMDYsMCwwLDAsMy4xOSwxLjE1LDEyLjU5LDEyLjU5LDAsMCwwLDMuNTIuNTEsNS40LDUuNCwwLDAsMCwyLjkzLS42MywxLjkxLDEuOTEsMCwwLDAsLjk0LTEuNjksMi4wOSwyLjA5LDAsMCwwLTEtMS44MSwxMC43MywxMC43MywwLDAsMC0yLjY4LTEuMjNjLTEuMTMtLjM2LTIuNDMtLjc1LTMuOS0xLjE1YTI2LjA5LDI2LjA5LDAsMCwxLTQuNzMtMiw3LjMxLDcuMzEsMCwwLDEtMi43Ny0yLjY1LDcuNjksNy42OSwwLDAsMS0uOS0zLjg5LDkuNTUsOS41NSwwLDAsMSwxLjU2LTUuNTcsOS43Myw5LjczLDAsMCwxLDQuMi0zLjQsMTQuMDYsMTQuMDYsMCwwLDEsNS43Ny0xLjE2LDE2LjU0LDE2LjU0LDAsMCwxLDQuMjcuNTMsMjYuMzksMjYuMzksMCwwLDEsMy44MiwxLjMxLDI0LjM0LDI0LjM0LDAsMCwxLDMuMTMsMS42M1oiLz48L2c+PC9nPjwvc3ZnPg==";
const LOGO_WHITE_B64 = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTUuNDMgMTY4LjY0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9PC9zdHlsZT48L2RlZnM+PGcgaWQ9IkxheWVyXzIiIGRhdGEtbmFtZT0iTGF5ZXIgMiI+PGcgaWQ9IkxheWVyXzEtMiIgZGF0YS1uYW1lPSJMYXllciAxIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xLDExMVY5LjA1YTMsMywwLDAsMSwzLTNINDcuNTJBMzMuNCwzMy40LDAsMCwxLDYyLjExLDkuMjVhMzYuNTYsMzYuNTYsMCwwLDEsMTEuNTUsOC41OSw0MCw0MCwwLDAsMSw3LjUzLDEyLjA4LDM2LjQxLDM2LjQxLDAsMCwxLDIuNjYsMTMuNTMsMzguMjksMzguMjksMCwwLDEtNC40OSwxOC4wOUEzNy44OCwzNy44OCwwLDAsMSw2Ni45LDc1LjQ1YTMyLjUsMzIuNSwwLDAsMS0xOC42Miw1LjM5SDMwLjY1VjExMWEzLDMsMCwwLDEtMywzSDRBMywzLDAsMCwxLDEsMTExWk0zMC42NSw1My40NkExLjU0LDEuNTQsMCwwLDAsMzIuMTksNTVINDYuM2E2LjQyLDYuNDIsMCwwLDAsMy41LTEuMDYsOCw4LDAsMCwwLDIuODEtMy42NSwxNy4xNSwxNy4xNSwwLDAsMCwxLjE0LTYuODQsMTUuNzMsMTUuNzMsMCwwLDAtMS4yOS03LjA3LDcuNzcsNy43NywwLDAsMC0zLjE5LTMuNDksOCw4LDAsMCwwLTMuNzMtMUgzMi4xOWExLjU0LDEuNTQsMCwwLDAtMS41NCwxLjU0WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTE2OS41Nyw5MS4xNlYxMTFhMywzLDAsMCwxLTMsM0g5NS42OGEzLDMsMCwwLDEtMy0zVjkuMDhhMywzLDAsMCwxLDMtM2g2OS41YTMsMywwLDAsMSwzLDN2MTkuOGEzLDMsMCwwLDEtMywzSDEyMy43OWExLjQ5LDEuNDksMCwwLDAtMS40OSwxLjQ5VjQ1LjYxYTEuNDksMS40OSwwLDAsMCwxLjQ5LDEuNDloMzQuN2EzLDMsMCwwLDEsMywzdjE4YTMsMywwLDAsMS0zLDNoLTM0LjdhMS40OSwxLjQ5LDAsMCwwLTEuNDksMS40OVY4Ni42NWExLjQ5LDEuNDksMCwwLDAsMS40OSwxLjQ5aDQyLjc2QTMsMywwLDAsMSwxNjkuNTcsOTEuMTZaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjk3LjQ2LDExMVY5LjA4YTMsMywwLDAsMSwzLTNoMjMuNmEzLDMsMCwwLDEsMywzdjMzLjhhMS40OCwxLjQ4LDAsMCwwLDIuNjQuOTJMMzU5LjIzLDYuOTNhMi4zNCwyLjM0LDAsMCwxLDEuODItLjg3aDI3YTIuNTIsMi41MiwwLDAsMSwyLDQuMTFMMzU0LjkxLDUzLjQ2YTEuNjEsMS42MSwwLDAsMC0uMDYsMS45MkwzOTMuMzEsMTEwYTIuNTIsMi41MiwwLDAsMS0yLjA2LDRIMzYzLjNhMi4zMiwyLjMyLDAsMCwxLTEuOTMtMUwzMzYuNTMsNzYuMTFhMS43NywxLjc3LDAsMCwwLTIuNzMtLjI0bC01LjE0LDUuMzNhNS41Nyw1LjU3LDAsMCwwLTEuNTYsMy44N1YxMTFhMywzLDAsMCwxLTMsM2gtMjMuNkEzLDMsMCwwLDEsMjk3LjQ2LDExMVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0yODIuNTgsMTA2Ljg2LDI0MC4xNiw1LjIyYTguNDgsOC40OCwwLDAsMC0xNS42NiwwTDE4Mi4wNiwxMDYuOWE3LjA5LDcuMDksMCwwLDAsMTAuMTYsOC44M0wyMzAsODUuMDVWNTguNmg0Ljc3djQuOWwxOC4zNiw3LjgtMTguMzYsNy44Vjg1bDM3LjY1LDMwLjY5QTcuMDksNy4wOSwwLDAsMCwyODIuNTgsMTA2Ljg2WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTAsMTY4LjQyVjEzNy4xOEgxMy4zM2E5LjA3LDkuMDcsMCwwLDEsNC4wOS45MiwxMS4yMiwxMS4yMiwwLDAsMSwzLjI0LDIuNDIsMTAuOTEsMTAuOTEsMCwwLDEsMi4xMywzLjM5LDEwLjQxLDEwLjQxLDAsMCwxLC43NSwzLjg3LDExLDExLDAsMCwxLTEuMjUsNS4wOCwxMC41OCwxMC41OCwwLDAsMS0zLjQ4LDQsOSw5LDAsMCwxLTUuMjEsMS41Mkg3LjIydjEwLjA4Wk03LjIyLDE1Mmg1Ljg5YTIuNjUsMi42NSwwLDAsMCwxLjUyLS40NywzLjI3LDMuMjcsMCwwLDAsMS4xMi0xLjQzLDUuNjMsNS42MywwLDAsMCwuNDQtMi4zMyw1LjM4LDUuMzgsMCwwLDAtLjQ4LTIuNDRBMy4zLDMuMywwLDAsMCwxNC40NSwxNDRhMy4yMiwzLjIyLDAsMCwwLTEuNi0uNDRINy4yMloiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zNy41OCwxMzcuMThoNy43NGwxMC44MiwzMS4yNEg0OC43NWwtMi4xMi03SDM2LjMybC0yLjEzLDdIMjYuOFptNy41NiwxOS4zMS0zLjY1LTEyLjA1LTMuNjcsMTIuMDVaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNjMuNzYsMTY4LjQyVjEzNy4xOGgxNGE5LjM4LDkuMzgsMCwwLDEsNC4xNC45MiwxMC40MiwxMC40MiwwLDAsMSwzLjIzLDIuNDIsMTEuNDMsMTEuNDMsMCwwLDEsMi4xMSwzLjM5LDEwLDEwLDAsMCwxLC43NywzLjg3LDEwLjc0LDEwLjc0LDAsMCwxLS42MywzLjY1LDEwLjE4LDEwLjE4LDAsMCwxLTEuNzksMy4xMyw5LjYyLDkuNjIsMCwwLDEtMi42OCwyLjI0bDYuODYsMTEuNjJoLThsLTYtMTAuMDhINzF2MTAuMDhaTTcxLDE1Mmg2LjY1YTIuNDIsMi40MiwwLDAsMCwxLjUxLS41MywzLjg2LDMuODYsMCwwLDAsMS4xMy0xLjUsNS4zLDUuMywwLDAsMCwuNDQtMi4yLDQuNzUsNC43NSwwLDAsMC0uNTEtMi4yN0E0LDQsMCwwLDAsNzguOTEsMTQ0YTIuNzQsMi43NCwwLDAsMC0xLjU2LS41M0g3MVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xMjEuMjIsMTQzLjUxaC05LjV2MjQuOTFIMTA0LjVWMTQzLjUxSDk1di02LjMzaDI2LjI3WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTEzNC4xMSwxMzcuMTgsMTQwLjg0LDE1MWw2Ljg3LTEzLjgxaDcuODdsLTExLjEzLDIwLjU5djEwLjY1aC03LjE3VjE1Ny42OGwtMTEtMjAuNVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xNzYuMjYsMTY4LjQyVjEzNy4xOGgxNGE5LjQxLDkuNDEsMCwwLDEsNC4xNC45MiwxMC41NCwxMC41NCwwLDAsMSwzLjIzLDIuNDIsMTEuNjQsMTEuNjQsMCwwLDEsMi4xMSwzLjM5LDEwLjIzLDEwLjIzLDAsMCwxLC43NywzLjg3LDEwLjUxLDEwLjUxLDAsMCwxLS42NCwzLjY1LDEwLjE1LDEwLjE1LDAsMCwxLTEuNzgsMy4xMyw5Ljc2LDkuNzYsMCwwLDEtMi42OCwyLjI0bDYuODYsMTEuNjJoLThsLTYtMTAuMDhoLTQuODh2MTAuMDhaTTE4My40OCwxNTJoNi42NGEyLjQyLDIuNDIsMCwwLDAsMS41Mi0uNTMsMy43NSwzLjc1LDAsMCwwLDEuMTItMS41LDUuMTUsNS4xNSwwLDAsMCwuNDQtMi4yLDQuODcsNC44NywwLDAsMC0uNS0yLjI3LDQuMTEsNC4xMSwwLDAsMC0xLjI4LTEuNDcsMi43NCwyLjc0LDAsMCwwLTEuNTYtLjUzaC02LjM4WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTIzMi4yOCwxNjIuMDh2Ni4zNGgtMjJWMTM3LjE4aDIxLjU2djYuMzNIMjE3LjU0djYuMDhoMTIuMzJ2NS44NUgyMTcuNTR2Ni42NFoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0yNDguNDcsMTUwLjUxdjE3LjkxaC03LjIyVjEzNy4xOEgyNDdsMTQuNDgsMTguMzlWMTM3LjE4aDcuMTd2MzEuMjRoLTUuODVaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMzAzLDE0My41MWgtOS41MXYyNC45MWgtNy4yMVYxNDMuNTFoLTkuNTV2LTYuMzNIMzAzWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTMxNi4wOSwxMzcuMThoNy43NWwxMC44MiwzMS4yNGgtNy4zOWwtMi4xMi03SDMxNC44NGwtMi4xMyw3aC03LjRabTcuNTcsMTkuMzFMMzIwLDE0NC40NGwtMy42NywxMi4wNVoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zNDIuMjcsMTY4LjQyVjEzNy4xOGg3LjIydjI0LjloMTUuMTR2Ni4zNFoiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zOTEuMzMsMTQ2LjMzYTcuMjksNy4yOSwwLDAsMC0uOTQtLjY0LDE2LjIzLDE2LjIzLDAsMCwwLTItMSwxNS45MSwxNS45MSwwLDAsMC0yLjU4LS45LDEwLjgxLDEwLjgxLDAsMCwwLTIuODEtLjM4LDUuMjIsNS4yMiwwLDAsMC0yLjg2LjY2LDIuMTEsMi4xMSwwLDAsMC0xLDEuOTEsMiwyLDAsMCwwLC43NywxLjY0LDYuNTUsNi41NSwwLDAsMCwyLjIyLDEuMDljMSwuMzEsMi4xNS42NSwzLjU2LDFhMjcuODUsMjcuODUsMCwwLDEsNS4xOSwxLjk0LDguNiw4LjYsMCwwLDEsMy4zNywyLjg1LDguMjEsOC4yMSwwLDAsMSwxLjE3LDQuNjMsOS42OCw5LjY4LDAsMCwxLS45NSw0LjQzLDcuNjMsNy42MywwLDAsMS0yLjY0LDMsMTIuMDgsMTIuMDgsMCwwLDEtMy43OCwxLjYyLDE4LjgxLDE4LjgxLDAsMCwxLTQuMzQuNSwyMy4wNSwyMy4wNSwwLDAsMS00LjY4LS40OSwyNi4zNiwyNi4zNiwwLDAsMS04LjY1LTMuMzlsMy4xMi02LjMzYTUuNjMsNS42MywwLDAsMCwxLjE5LjgzLDIyLjEyLDIyLjEyLDAsMCwwLDIuNCwxLjIxLDI0LjA2LDI0LjA2LDAsMCwwLDMuMTksMS4xNSwxMi41OSwxMi41OSwwLDAsMCwzLjUyLjUxLDUuNCw1LjQsMCwwLDAsMi45My0uNjMsMS45MSwxLjkxLDAsMCwwLC45NC0xLjY5LDIuMDksMi4wOSwwLDAsMC0xLTEuODEsMTAuNzMsMTAuNzMsMCwwLDAtMi42OC0xLjIzYy0xLjEzLS4zNi0yLjQzLS43NS0zLjktMS4xNWEyNi4wOSwyNi4wOSwwLDAsMS00LjczLTIsNy4zMSw3LjMxLDAsMCwxLTIuNzctMi42NSw3LjY5LDcuNjksMCwwLDEtLjktMy44OSw5LjU1LDkuNTUsMCwwLDEsMS41Ni01LjU3LDkuNzMsOS43MywwLDAsMSw0LjItMy40LDE0LjA2LDE0LjA2LDAsMCwxLDUuNzctMS4xNiwxNi41NCwxNi41NCwwLDAsMSw0LjI3LjUzLDI2LjM5LDI2LjM5LDAsMCwxLDMuODIsMS4zMSwyNC4zNCwyNC4zNCwwLDAsMSwzLjEzLDEuNjNaIi8+PC9nPjwvZz48L3N2Zz4=";

// ‚îÄ‚îÄ FIREBASE CLOUD SYNC ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyC13ldxny_Zsq_l4Mlf9u1mJa6lFJ1whRE",
  authDomain: "peak-party-planner.firebaseapp.com",
  databaseURL: "https://peak-party-planner-default-rtdb.firebaseio.com",
  projectId: "peak-party-planner",
  storageBucket: "peak-party-planner.firebasestorage.app",
  messagingSenderId: "1087242500581",
  appId: "1:1087242500581:web:b8a33cf08a07d9e46f170c"
};
firebase.initializeApp(firebaseConfig);
const fbDb = firebase.database();
let cloudSaves = {};
function fbKey(n){ return n.replace(/[.#$\[\]\/]/g,'_'); }

// ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ
const CATS = [
  {cat:"Round Tables", items:[
    {type:"r60_8", lbl:'60"', sub:"Round ¬∑ 8 seats", w:5,h:5,shape:"circle",seats:8, numbered:true, bg:"#dfc9a0",bd:"#8b6030",fg:"#2a1200",chairBg:"#7a5028"},
    {type:"r60_10",lbl:'60"', sub:"Round ¬∑ 10 seats",w:5,h:5,shape:"circle",seats:10,numbered:true, bg:"#cdb888",bd:"#7a5020",fg:"#2a1200",chairBg:"#6a4018"},
    {type:"r72",   lbl:'72"', sub:"Round ¬∑ 10 seats",w:6,h:6,shape:"circle",seats:10,numbered:true, bg:"#dfc9a0",bd:"#8b6030",fg:"#2a1200",chairBg:"#7a5028"},
  ]},
  {cat:"Banquet Tables", items:[
    {type:"b6",  lbl:"6ft", sub:"Banquet ¬∑ 6 seats",w:6,h:2.5,shape:"rect",seats:6, numbered:true, bg:"#c8b070",bd:"#7a6020",fg:"#1a0e00",chairBg:"#7a6020"},
    {type:"b8",  lbl:"8ft", sub:"Banquet ¬∑ 8 seats",w:8,h:2.5,shape:"rect",seats:8, numbered:true, bg:"#c8b070",bd:"#7a6020",fg:"#1a0e00",chairBg:"#7a6020"},
    {type:"head",lbl:"Head",sub:"Table ¬∑ custom",   w:8,h:2.5,shape:"rect",seats:10,numbered:false,bg:"#b89048",bd:"#705010",fg:"#fff8e0",chairBg:"#705010"},
    {type:"swht",lbl:"‚ô•",   sub:"Sweetheart ¬∑ 2",   w:4,h:2.5,shape:"rect",seats:2, numbered:false,bg:"#f0c0c8",bd:"#c07080",fg:"#5a0020",chairBg:"#c07080"},
  ]},
  {cat:"Cocktail / Hi-Top", items:[
    {type:"ckt30",lbl:'30"',sub:"Hi-Top ¬∑ 4 seats",w:2.5,h:2.5,shape:"circle",seats:4,numbered:false,bg:"#e0c870",bd:"#9a8020",fg:"#2a1a00",chairBg:"#9a8020"},
    {type:"ckt36",lbl:'36"',sub:"Hi-Top ¬∑ 5 seats",w:3,  h:3,  shape:"circle",seats:5,numbered:false,bg:"#d4b850",bd:"#8a7010",fg:"#2a1a00",chairBg:"#8a7010"},
  ]},
  {cat:"Event Elements", items:[
    {type:"bar",   lbl:"Bar",   sub:"6ft Bar",     w:6, h:2, shape:"rect", seats:0,numbered:false,bg:"#004a6e",bd:"#003050",fg:"#7dd6f5"},
    {type:"dj",    lbl:"DJ",    sub:"DJ Booth",    w:6, h:4, shape:"rect", seats:0,numbered:false,bg:"#0093c7",bd:"#005a80",fg:"#e0f4fc"},
    {type:"dance", lbl:"Dance", sub:"Floor 12√ó12", w:12,h:12,shape:"check",seats:0,numbered:false,bg:"#e0f4fc",bd:"#0093c7",fg:"#004a6e"},
    {type:"stage", lbl:"Stage", sub:"Riser/Stage", w:16,h:8, shape:"rect", seats:0,numbered:false,bg:"#374151",bd:"#1f2937",fg:"#f9fafb"},
    {type:"buffet",lbl:"Buffet",sub:"Buffet Line", w:8, h:2, shape:"rect", seats:0,numbered:false,bg:"#0e4a62",bd:"#083040",fg:"#b3dff0"},
    {type:"cake",  lbl:"Cake",  sub:"Cake Table",  w:3, h:2, shape:"rect", seats:0,numbered:false,bg:"#fce7f3",bd:"#db2777",fg:"#831843"},
  ]},
  {cat:"Markers", items:[
    {type:"door",lbl:"‚Üë Entry",sub:"Entrance / Door",w:4,h:0.5,shape:"door",seats:0,numbered:false,bg:"#0093c7",bd:"#005a80",fg:"#e0f4fc"},
    {type:"pole",lbl:"‚äï Pole", sub:"Tent Pole",     w:1,h:1,  shape:"pole",seats:0,numbered:false,bg:"#9ca3af",bd:"#4b5563",fg:"#ffffff"},
  ]},
  {cat:"Chair Styles", items:[
    {type:"chair_white",   lbl:"White",    sub:"White Folding",     w:0.5,h:0.5,shape:"chair",seats:0,numbered:false,bg:"#edede9",bd:"#c8c8c4",fg:"#555",chairStyle:"white_folding"},
    {type:"chair_brown",   lbl:"Brown",    sub:"Brown Folding",     w:0.5,h:0.5,shape:"chair",seats:0,numbered:false,bg:"#7a5530",bd:"#5a3a18",fg:"#fff",chairStyle:"brown_folding"},
    {type:"chair_chiavari",lbl:"Chiavari", sub:"Chiavari/Ballroom", w:0.5,h:0.5,shape:"chair",seats:0,numbered:false,bg:"#d4af6a",bd:"#a07830",fg:"#fff",chairStyle:"chiavari"},
    {type:"chair_padded",  lbl:"Padded",   sub:"Padded Folding",    w:0.5,h:0.5,shape:"chair",seats:0,numbered:false,bg:"#d8d8d8",bd:"#a8a8a8",fg:"#333",chairStyle:"padded"},
  ]},
  {cat:"Chair Rows", items:[
    {type:"crow4",  lbl:"Row ¬∑ 4",  sub:"4 chairs ¬∑ 7 ft",  w:7,  h:1.5,shape:"chairrow",seats:4,  numbered:false,bg:"#edede9",bd:"#b0b0a8",fg:"#30393d",chairCount:4},
    {type:"crow6",  lbl:"Row ¬∑ 6",  sub:"6 chairs ¬∑ 10.5 ft",w:10.5,h:1.5,shape:"chairrow",seats:6,  numbered:false,bg:"#edede9",bd:"#b0b0a8",fg:"#30393d",chairCount:6},
    {type:"crow8",  lbl:"Row ¬∑ 8",  sub:"8 chairs ¬∑ 14.5 ft",w:14.5,h:1.5,shape:"chairrow",seats:8,  numbered:false,bg:"#edede9",bd:"#b0b0a8",fg:"#30393d",chairCount:8},
    {type:"crow10", lbl:"Row ¬∑ 10", sub:"10 chairs ¬∑ 18 ft",w:18, h:1.5,shape:"chairrow",seats:10, numbered:false,bg:"#edede9",bd:"#b0b0a8",fg:"#30393d",chairCount:10},
    {type:"crow12", lbl:"Row ¬∑ 12", sub:"12 chairs ¬∑ 22 ft",w:22, h:1.5,shape:"chairrow",seats:12, numbered:false,bg:"#edede9",bd:"#b0b0a8",fg:"#30393d",chairCount:12},
  ]},
];
function defOf(t){for(const c of CATS)for(const d of c.items)if(d.type===t)return d;return null;}

// ‚îÄ‚îÄ UPSELL CATALOG ‚îÄ‚îÄ
const UPSELLS = [
  {id:"string",   icon:"‚ú®",name:"String Lights",           desc:"Overhead bistro string lights ‚Äî warm, elegant ambiance.",           price:"From $199",    trigger:"any"},
  {id:"linens",   icon:"üé®",name:"Linen Package",           desc:"Full linen sets for all tables ‚Äî white, ivory, or custom colors.",  price:"From $8/table",trigger:"tables"},
  {id:"sidewalls",icon:"ü™ü",name:"Tent Sidewalls",          desc:"Solid or window sidewalls for wind, rain & privacy protection.",    price:"From $149",    trigger:"any"},
  {id:"flooring", icon:"üî≤",name:"Portable Dance Flooring", desc:"Modular flooring under the tent ‚Äî ideal for grass or uneven ground.",price:"From $499",  trigger:"dance"},
  {id:"heating",  icon:"üå°",name:"Heating / Cooling",       desc:"Propane heaters or evaporative coolers to keep guests comfortable.",price:"From $149/unit",trigger:"any"},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const BASE = 12;
let tentW=30, tentL=60, zoom=1, panX=40, panY=40;
let items=[], nid=1, selIds=new Set();

// ‚îÄ‚îÄ MULTI-SCENE / FESTIVAL MODE ‚îÄ‚îÄ
let scenes = [];
let activeSceneIdx = 0;
let isFieldView = false;
let fieldElements = [];   // roads + field-level annotations
let fieldNid = 1;
let fieldPanX = 100, fieldPanY = 100, fieldZoom = 1;
let fieldDragging = null; // {type:'tent'|'road', id, startX,startY,origX,origY}
let fieldDrawingRoad = null; // {startX,startY}
let fieldRoadTool = false;

function _sceneInit() {
  // Called once at load ‚Äî wraps existing globals into first scene
  scenes = [{
    id: 1, name: 'Tent A',
    tentL, tentW, items: JSON.parse(JSON.stringify(items)),
    nid, panX, panY, zoom: 1,
    history: [], future: [],
    fieldX: 50, fieldY: 50   // position on field overview
  }];
  activeSceneIdx = 0;
}

function _sceneSaveCurrent() {
  if (isFieldView || !scenes[activeSceneIdx]) return;
  const s = scenes[activeSceneIdx];
  s.tentL = tentL; s.tentW = tentW;
  s.items = JSON.parse(JSON.stringify(items));
  s.nid = nid; s.panX = panX; s.panY = panY; s.zoom = zoom;
  s.history = JSON.parse(JSON.stringify(history));
  s.future  = JSON.parse(JSON.stringify(future));
}

function activateScene(idx, skipSave) {
  if (!skipSave) _sceneSaveCurrent();
  isFieldView = false;
  activeSceneIdx = idx;
  const s = scenes[idx];
  tentL = s.tentL; tentW = s.tentW;
  items = JSON.parse(JSON.stringify(s.items));
  nid   = s.nid; panX = s.panX; panY = s.panY; zoom = s.zoom || 1;
  history = JSON.parse(JSON.stringify(s.history || []));
  future  = JSON.parse(JSON.stringify(s.future  || []));
  selIds.clear();
  document.getElementById('tw').value = tentL;
  document.getElementById('tl').value = tentW;
  const k = tentW+','+tentL, ps = document.getElementById('preset');
  ps.value = [...ps.options].some(o=>o.value===k) ? k : '';
  document.getElementById('canvas-area').style.display = '';
  document.getElementById('field-canvas-wrap').style.display = 'none';
  applyTent(); applyTransform(); renderAll(); updateCapacity();
  renderSceneTabs();
}

function addScene() {
  _sceneSaveCurrent();
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const name = 'Tent ' + (letters[scenes.length] || (scenes.length+1));
  // Auto-position new tent to the right of the last one on the field
  const last = scenes[scenes.length-1];
  const fX = last ? last.fieldX + last.tentL + 20 : 50;
  const fY = last ? last.fieldY : 50;
  scenes.push({
    id: Date.now(), name,
    tentL: 40, tentW: 20, items: [], nid: 1,
    panX: 40, panY: 40, zoom: 1,
    history: [], future: [],
    fieldX: fX, fieldY: fY
  });
  activateScene(scenes.length - 1);
  toast('Added ' + name);
}

function renameScene(idx) {
  // Find the tab by data-scene-idx
  const tab = document.querySelector(`#scene-tab-bar .scene-tab[data-scene-idx="${idx}"]`);
  const nameSpan = tab ? tab.querySelector('.scene-tab-name') : null;
  if (!nameSpan) return;
  const s = scenes[idx];
  const orig = s.name;

  const input = document.createElement('input');
  input.value = orig;
  input.style.cssText = 'background:rgba(255,255,255,0.15);border:1px solid #41b8ea;border-radius:3px;color:#fff;font-size:11px;font-weight:700;font-family:inherit;padding:1px 5px;width:' + Math.max(80, orig.length*9+20) + 'px;outline:none;max-width:160px;';
  nameSpan.replaceWith(input);
  input.focus();
  input.select();

  let committed = false;
  function commit() {
    if (committed) return; committed = true;
    s.name = input.value.trim() || orig;
    renderSceneTabs();
  }
  function cancel() {
    if (committed) return; committed = true;
    s.name = orig; renderSceneTabs();
  }
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter')  { e.preventDefault(); commit(); }
    if (e.key === 'Escape') { e.preventDefault(); cancel(); }
    e.stopPropagation();
  });
  input.addEventListener('blur', commit);
  input.addEventListener('mousedown', e => e.stopPropagation());
  input.addEventListener('click', e => e.stopPropagation());
}

function deleteScene(idx) {
  if (scenes.length <= 1) { toast('Need at least one tent'); return; }
  if (!confirm('Delete "' + scenes[idx].name + '"?')) return;
  scenes.splice(idx, 1);
  activateScene(Math.min(activeSceneIdx, scenes.length - 1));
}

function openFieldView() {
  _sceneSaveCurrent();
  isFieldView = true;
  selIds.clear();
  document.getElementById('canvas-area').style.display = 'none';
  document.getElementById('field-canvas-wrap').style.display = '';
  renderSceneTabs();
  renderFieldView();
}

function renderSceneTabs() {
  const bar = document.getElementById('scene-tab-bar');
  if (!bar) return;
  bar.innerHTML = '';
  scenes.forEach((s, i) => {
    const tab = document.createElement('div');
    tab.className = 'scene-tab' + (!isFieldView && i===activeSceneIdx ? ' active' : '');
    tab.dataset.sceneIdx = i;
    tab.innerHTML = `
      <span class="scene-tab-name">${s.name}</span>
      <small class="scene-tab-dims">${s.tentW}√ó${s.tentL}</small>
      <button class="scene-tab-rename-btn" title="Rename">‚úè</button>
      ${scenes.length > 1 ? `<button class="scene-tab-del" title="Delete">√ó</button>` : ''}
    `;
    tab.querySelector('.scene-tab-rename-btn').addEventListener('click', e => { e.stopPropagation(); renameScene(i); });
    if (scenes.length > 1) {
      tab.querySelector('.scene-tab-del').addEventListener('click', e => { e.stopPropagation(); deleteScene(i); });
    }
    tab.addEventListener('dblclick', e => { e.stopPropagation(); renameScene(i); });
    tab.addEventListener('click', e => { if (!e.target.closest('button')) activateScene(i); });
    bar.appendChild(tab);
  });
  // Add tent button
  const addBtn = document.createElement('button');
  addBtn.className = 'scene-tab-add';
  addBtn.textContent = '+ Add Tent';
  addBtn.onclick = addScene;
  bar.appendChild(addBtn);
  // Spacer
  const sp = document.createElement('div'); sp.style.flex = '1'; bar.appendChild(sp);
  // Field view button
  const fv = document.createElement('button');
  fv.className = 'scene-tab' + (isFieldView ? ' active' : '') + ' field-view-tab';
  fv.innerHTML = 'üó∫ Field View';
  fv.onclick = openFieldView;
  bar.appendChild(fv);
}
let tool="select", showGrid=true, snapOn=true, snapSz=1;
let history=[], future=[];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener("load", ()=>{
  buildPalette();
  buildUpsellList();
  _sceneInit();
  applyTent();
  fitView();
  setupCanvasEvents(); setupGroupBox(); setupRotDial();
  setupFieldView();
  document.addEventListener("keydown", onKey);
  // Start real-time sync from Firebase ‚Äî replaces local renderSaves()
  fbDb.ref('saves').on('value', snap => {
    cloudSaves = snap.val() || {};
    renderSaves();
  });
  migrateLocalSaves();
  renderSceneTabs();
});

// ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ
function buildPalette(){
  const inner=document.getElementById("pal-inner");
  CATS.forEach(cat=>{
    const h=document.createElement("div");h.className="pal-cat";h.textContent=cat.cat;inner.appendChild(h);
    cat.items.forEach(d=>{
      const el=document.createElement("div");el.className="pal-item";el.id="pal-"+d.type;
      if(d.shape==="chair"){
        const isChiavari=d.chairStyle==='chiavari';
        const col=d.bg,brd=d.bd;
        const svgIcon=isChiavari
          ?`<svg width="28" height="32" viewBox="0 0 28 32"><rect x="4" y="14" width="20" height="4" rx="1" fill="${col}" stroke="${brd}" stroke-width="1"/><rect x="5" y="18" width="18" height="12" rx="1" fill="none" stroke="${brd}" stroke-width="1"/><line x1="8" y1="4" x2="6" y2="30" stroke="${brd}" stroke-width="1.5"/><line x1="20" y1="4" x2="22" y2="30" stroke="${brd}" stroke-width="1.5"/><rect x="4" y="4" width="20" height="10" rx="1" fill="${col}" stroke="${brd}" stroke-width="1"/></svg>`
          :`<svg width="28" height="32" viewBox="0 0 28 32"><rect x="4" y="13" width="20" height="4" rx="1" fill="${col}" stroke="${brd}" stroke-width="1.2"/><rect x="4" y="4" width="20" height="10" rx="1" fill="${col}" stroke="${brd}" stroke-width="1.2"/><line x1="6" y1="17" x2="6" y2="30" stroke="${brd}" stroke-width="2"/><line x1="22" y1="17" x2="22" y2="30" stroke="${brd}" stroke-width="2"/><line x1="6" y1="28" x2="4" y2="31" stroke="${brd}" stroke-width="1.5"/><line x1="22" y1="28" x2="24" y2="31" stroke="${brd}" stroke-width="1.5"/><line x1="8" y1="23" x2="20" y2="25" stroke="${brd}" stroke-width="1" opacity="0.6"/><line x1="8" y1="26" x2="20" y2="24" stroke="${brd}" stroke-width="1" opacity="0.6"/></svg>`;
        el.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;margin-bottom:3px;">${svgIcon}</div><div class="pal-lbl">${d.lbl}</div><div class="pal-sub">${d.sub}</div>`;
        el.style.cursor="pointer";
        el.addEventListener("click",()=>setChairStyle(d.chairStyle));
        if(d.chairStyle===_3chairStyle)el.classList.add("pal-item-active");
      } else if(d.shape==="chairrow"){
        const count=d.chairCount||d.seats||8;
        const styleColors={white_folding:"#edede9",brown_folding:"#7a5530",chiavari:"#d4af6a",padded:"#d8d8d8"};
        const sBorderColors={white_folding:"#b0b0a8",brown_folding:"#5a3a18",chiavari:"#a07830",padded:"#a8a8a8"};
        const col=styleColors[_3chairStyle]||d.bg,brd=sBorderColors[_3chairStyle]||d.bd;
        const dotW=Math.max(3,Math.min(7,Math.floor(72/count))),gap=Math.max(1,Math.min(2,Math.floor(10/count)));
        const totalW=count*dotW+(count-1)*gap,svgW=Math.max(totalW,60),svgH=14,offsetX=(svgW-totalW)/2;
        const dots=Array.from({length:count},(_,i)=>`<rect x="${offsetX+i*(dotW+gap)}" y="2" width="${dotW}" height="${svgH-4}" rx="1" fill="${col}" stroke="${brd}" stroke-width="0.8"/>`).join('');
        el.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}">${dots}</svg><div style="font-size:15px;font-weight:800;color:var(--accent);line-height:1;">${count}</div><div style="font-size:8px;color:var(--muted);letter-spacing:0.5px;line-height:1;">chairs</div></div><div class="pal-lbl" style="margin-top:3px;">${d.sub.split('¬∑')[1]?.trim()||d.lbl}</div>`;
        el.addEventListener("mousedown",e=>startPalDrag(e,d));
      } else {
        const isC=d.shape==="circle";
        const pw=isC?28:Math.min(88,Math.max(26,(d.w/Math.max(d.h,1))*20));
        const ph=isC?28:Math.min(28,Math.max(12,(d.h/Math.max(d.w,1))*88));
        let bgS=d.shape==="check"?`background:repeating-conic-gradient(${d.bg} 0% 25%,#b3dff0 0% 50%);background-size:8px 8px;`:`background:${d.bg};`;
        el.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;margin-bottom:3px;"><div style="width:${pw}px;height:${ph}px;${bgS}border:1.5px solid ${d.bd};border-radius:${isC?"50%":"4px"};"></div></div><div class="pal-lbl">${d.lbl}</div><div class="pal-sub">${d.sub}</div>`;
        el.addEventListener("mousedown",e=>startPalDrag(e,d));
      }
      inner.appendChild(el);
    });
  });
}

function setChairStyle(style){
  _3chairStyle=style;
  document.getElementById("pal-inner").innerHTML="";
  buildPalette();
  const sel=document.getElementById("chair-style-sel");if(sel)sel.value=style;
  if(document.getElementById("view3d-overlay").style.display!=="none")_3build();
  renderAll();
  toast("Chair style: "+style.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()));
}

// ‚îÄ‚îÄ TENT ‚îÄ‚îÄ
function applyPreset(){
  const v = document.getElementById("preset").value; if(!v) return;
  const [w,l] = v.split(",").map(Number);
  document.getElementById("tw").value=w; document.getElementById("tl").value=l; updateTent();
}
function updateTent(){
  if(scenes[activeSceneIdx]){scenes[activeSceneIdx].tentL=parseFloat(document.getElementById("tl").value)||60;scenes[activeSceneIdx].tentW=parseFloat(document.getElementById("tw").value)||30;}
  tentW = parseFloat(document.getElementById("tw").value)||30;
  tentL = parseFloat(document.getElementById("tl").value)||60;
  const k = tentW+","+tentL, ps = document.getElementById("preset");
  ps.value = [...ps.options].some(o=>o.value===k)?k:"";
  applyTent();
}
function applyTent(){
  const t = document.getElementById("tent");
  t.style.width  = (tentL*BASE*zoom)+"px";
  t.style.height = (tentW*BASE*zoom)+"px";
  t.querySelectorAll(".tent-dim").forEach(e=>e.remove());
  const dl = document.createElement("div"); dl.className="tent-dim";
  dl.style.cssText = "top:-20px;left:50%;transform:translateX(-50%);"; dl.textContent=tentL+" ft"; t.appendChild(dl);
  const dw = document.createElement("div"); dw.className="tent-dim";
  dw.style.cssText = "left:-28px;top:50%;transform:translateY(-50%) rotate(-90deg);"; dw.textContent=tentW+" ft"; t.appendChild(dw);
  drawGrid(); renderAll();
}
function applyTransform(){
  const w = document.getElementById("world");
  w.style.left=panX+"px"; w.style.top=panY+"px";
  const t = document.getElementById("tent");
  t.style.width=(tentL*BASE*zoom)+"px"; t.style.height=(tentW*BASE*zoom)+"px";
  drawGrid(); renderAll();
  document.getElementById("zoom-lbl").textContent = Math.round(zoom*100)+"%";
}
function zoomStep(dir){
  const steps=[0.25,0.33,0.5,0.67,0.75,0.9,1,1.1,1.25,1.5,1.75,2,2.5,3];
  let i=steps.findIndex(s=>Math.abs(s-zoom)<0.01); if(i<0) i=steps.findIndex(s=>s>zoom)-1;
  const ni=Math.max(0,Math.min(steps.length-1,i+dir));
  const ca=document.getElementById("canvas-area").getBoundingClientRect();
  zoomAt(ca.left+ca.width/2, ca.top+ca.height/2, steps[ni]);
}
function zoomAt(sx,sy,nz){
  const ca=document.getElementById("canvas-area").getBoundingClientRect();
  const fx=(sx-ca.left-panX)/(BASE*zoom), fy=(sy-ca.top-panY)/(BASE*zoom);
  panX=(sx-ca.left)-fx*BASE*nz; panY=(sy-ca.top)-fy*BASE*nz; zoom=nz; applyTransform();
}
function fitView(){
  const ca=document.getElementById("canvas-area");
  const cw=ca.clientWidth-80, ch=ca.clientHeight-80;
  zoom=Math.min(cw/(tentL*BASE), ch/(tentW*BASE), 2);
  panX=(ca.clientWidth-tentL*BASE*zoom)/2; panY=(ca.clientHeight-tentW*BASE*zoom)/2; applyTransform();
}
function toggleGrid(){ showGrid=!showGrid; document.getElementById("btn-grid").className="tb-btn"+(showGrid?" active":""); drawGrid(); }
function toggleSnap(){ snapOn=!snapOn; document.getElementById("btn-snap").className="tb-btn"+(snapOn?" active":""); }
function setTool(t){
  tool=t;
  document.getElementById("btn-select").className="tb-btn"+(t==="select"?" active":"");
  document.getElementById("btn-pan").className="tb-btn"+(t==="pan"?" active":"");
  document.getElementById("canvas-area").className=t==="pan"?"panning":"";
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ
function drawGrid(){
  const cvs=document.getElementById("grid-cvs");
  const cw=tentL*BASE*zoom, ch=tentW*BASE*zoom;
  cvs.width=cw; cvs.height=ch; cvs.style.width=cw+"px"; cvs.style.height=ch+"px";
  const ctx=cvs.getContext("2d"); ctx.clearRect(0,0,cw,ch); if(!showGrid) return;
  ctx.strokeStyle="rgba(0,147,199,0.07)"; ctx.lineWidth=0.5;
  for(let x=0;x<=tentL;x++){ctx.beginPath();ctx.moveTo(x*BASE*zoom,0);ctx.lineTo(x*BASE*zoom,ch);ctx.stroke();}
  for(let y=0;y<=tentW;y++){ctx.beginPath();ctx.moveTo(0,y*BASE*zoom);ctx.lineTo(cw,y*BASE*zoom);ctx.stroke();}
  ctx.strokeStyle="rgba(0,147,199,0.16)"; ctx.lineWidth=0.8;
  for(let x=0;x<=tentL;x+=5){ctx.beginPath();ctx.moveTo(x*BASE*zoom,0);ctx.lineTo(x*BASE*zoom,ch);ctx.stroke();}
  for(let y=0;y<=tentW;y+=5){ctx.beginPath();ctx.moveTo(0,y*BASE*zoom);ctx.lineTo(cw,y*BASE*zoom);ctx.stroke();}
  ctx.fillStyle="rgba(0,120,180,0.4)"; ctx.font=`${Math.max(8,9*zoom)}px DM Sans,sans-serif`;
  ctx.textAlign="center"; for(let x=5;x<=tentL;x+=5) if(x*BASE*zoom>20) ctx.fillText(x+"'",x*BASE*zoom,ch-3);
  ctx.textAlign="right";  for(let y=5;y<=tentW;y+=5) if(y*BASE*zoom>16) ctx.fillText(y+"'",cw-3,y*BASE*zoom-3);
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function r2(n){return Math.round(n*100)/100;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function sp(v){return snapOn?Math.round(v/snapSz)*snapSz:v;}
function getTableNums(){const m={};let n=1;items.forEach(it=>{const d=defOf(it.type);if(d&&d.numbered)m[it.id]=n++;});return m;}

function renderAll(){
  document.querySelectorAll(".c-wrap").forEach(e=>e.remove());
  const tn=getTableNums();
  items.forEach(it=>renderItem(it,tn));
  updateCapacity(); updateSummary();
  document.getElementById("st-count").textContent=items.length;
  refreshBanner();
}

function renderItem(item, tnums){
  const d=defOf(item.type); if(!d) return;
  const wpx=item.w*BASE*zoom, hpx=item.h*BASE*zoom;
  const cSz=Math.max(6,Math.min(11,BASE*zoom*0.78)), cGap=2;
  const pad=(d.seats>0&&d.shape!=="door"&&d.shape!=="pole")?cSz+cGap+2:0;
  const wrap=document.createElement("div");
  wrap.className="c-wrap"+(selIds.has(item.id)?" selected":"")+(item.locked?" locked":"");
  wrap.id="ci"+item.id;
  wrap.style.cssText=`left:${item.x*BASE*zoom-pad}px;top:${item.y*BASE*zoom-pad}px;width:${wpx+pad*2}px;height:${hpx+pad*2}px;transform:rotate(${item.rot||0}deg);z-index:${item.zIndex||10};`;
  const tbl=document.createElement("div"); tbl.className="c-tbl";
  let bg=d.bg; if(d.shape==="check") bg=`repeating-conic-gradient(${d.bg} 0% 25%,#b3dff0 0% 50%)`;
  let br=d.shape==="circle"||d.shape==="pole"?"50%":d.shape==="door"?"2px":"4px";
  const fsize=Math.max(7,Math.min(12,Math.min(wpx,hpx)/5.2));
  tbl.style.cssText=`left:${pad}px;top:${pad}px;width:${wpx}px;height:${hpx}px;background:${bg};${d.shape==="check"?`background-size:${Math.max(8,BASE*zoom*0.9)}px ${Math.max(8,BASE*zoom*0.9)}px;`:""}border:2px solid ${d.bd};border-radius:${br};color:${d.fg};font-size:${fsize}px;box-shadow:0 2px 8px rgba(0,0,0,0.1);`;
  const tnum=tnums&&tnums[item.id];
  if(d.shape==="door") tbl.textContent="‚Üë ENTRANCE";
  else if(d.shape==="pole") tbl.textContent="‚úï";
  else if(d.shape==="chairrow"){
    // Match the sidebar icon exactly: a row of flat seat rectangles + count label
    const count=d.chairCount||d.seats||8;
    const styleColors={white_folding:"#edede9",brown_folding:"#7a5530",chiavari:"#d4af6a",padded:"#d8d8d8"};
    const sBorderColors={white_folding:"#b0b0a8",brown_folding:"#5a3a18",chiavari:"#a07830",padded:"#a8a8a8"};
    const col=styleColors[_3chairStyle]||d.bg;
    const brd=sBorderColors[_3chairStyle]||d.bd;

    // Build the same SVG the sidebar uses: one rect per chair, scaled to canvas width
    const CHAIR_W_FT=1.5, GAP_FT=4/12;
    const pxPerFt=BASE*zoom;
    const cPx=CHAIR_W_FT*pxPerFt, gPx=GAP_FT*pxPerFt;
    const totalPx=count*cPx+(count-1)*gPx;
    const startX=(wpx-totalPx)/2;
    const dotH=Math.max(6, hpx*0.55);
    const dotY=(hpx-dotH)/2;

    const rects=Array.from({length:count},(_,i)=>{
      const x=startX+i*(cPx+gPx);
      return `<rect x="${x.toFixed(1)}" y="${dotY.toFixed(1)}" width="${cPx.toFixed(1)}" height="${dotH.toFixed(1)}" rx="2" fill="${col}" stroke="${brd}" stroke-width="1.2"/>`;
    }).join('');

    const svgStr=`<svg xmlns="http://www.w3.org/2000/svg" width="${wpx}" height="${hpx}" style="position:absolute;left:0;top:0;">${rects}</svg>`;
    tbl.style.background="transparent";
    tbl.style.border="1.5px dashed "+brd;
    tbl.style.borderRadius="3px";
    tbl.style.overflow="visible";
    tbl.innerHTML=svgStr;
  }
  else if(tnum) tbl.innerHTML=`<div style="font-size:${Math.max(6,fsize)}px;font-weight:700">T${tnum}</div>`;
  else tbl.textContent=d.lbl;
  wrap.appendChild(tbl);
  if(item.locked){const li=document.createElement("div");li.className="lock-icon";li.textContent="üîí";wrap.appendChild(li);}
  if(d.seats>0&&d.shape!=="door"&&d.shape!=="pole"){
    const cx=pad+wpx/2, cy=pad+hpx/2;
    if(d.shape==="circle"){
      const r=wpx/2+cGap+cSz/2;
      for(let i=0;i<d.seats;i++){const a=(i/d.seats)*2*Math.PI-Math.PI/2;addDot(wrap,cx+r*Math.cos(a)-cSz/2,cy+r*Math.sin(a)-cSz/2,cSz,d.chairBg||d.bd);}
    }else{
      const spp=Math.floor(d.seats/2), rem=d.seats-spp*2;
      for(let i=0;i<spp;i++){const x=pad+(i+1)*wpx/(spp+1)-cSz/2;addDot(wrap,x,pad-cGap-cSz,cSz,d.chairBg||d.bd);addDot(wrap,x,pad+hpx+cGap,cSz,d.chairBg||d.bd);}
      if(rem>0) addDot(wrap,pad-cGap-cSz,cy-cSz/2,cSz,d.chairBg||d.bd);
    }
  }
  wrap.addEventListener("mousedown", e=>{if(!item.locked)startItemDrag(e,item.id);else e.stopPropagation();});
  wrap.addEventListener("click", e=>{e.stopPropagation();handleItemClick(e,item.id);});
  document.getElementById("tent").appendChild(wrap);
}
function addDot(parent,x,y,sz,bg){const d=document.createElement("div");d.className="c-dot";d.style.cssText=`left:${x}px;top:${y}px;width:${sz}px;height:${sz}px;background:${bg};border:1px solid rgba(0,0,0,0.18);`;parent.appendChild(d);}

// ‚îÄ‚îÄ SELECTION ‚îÄ‚îÄ
function handleItemClick(e,id){if(e.shiftKey){selIds.has(id)?selIds.delete(id):selIds.add(id);}else{selIds.clear();selIds.add(id);}updateSelUI();}
function deselect(){selIds.clear();updateSelUI();}
function updateSelUI(){
  document.querySelectorAll(".c-wrap").forEach(el=>{const id=parseInt(el.id.replace("ci",""));el.classList.toggle("selected",selIds.has(id));});
  const count=selIds.size;
  // Position group drag overlay
  const gb=document.getElementById("grp-box");
  if(gb){
    if(count>1){
      let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
      selIds.forEach(sid=>{
        const it=items.find(i=>i.id===sid);if(!it)return;
        const d=defOf(it.type);
        const cSz=Math.max(6,Math.min(11,BASE*zoom*0.78));
        const pad=(d&&d.seats>0&&d.shape!=="door"&&d.shape!=="pole"&&d.shape!=="chairrow")?cSz+4:0;
        minX=Math.min(minX,it.x*BASE*zoom+panX-pad);minY=Math.min(minY,it.y*BASE*zoom+panY-pad);
        maxX=Math.max(maxX,(it.x+it.w)*BASE*zoom+panX+pad);maxY=Math.max(maxY,(it.y+it.h)*BASE*zoom+panY+pad);
      });
      const m=6;
      gb.style.display="block";gb.style.left=(minX-m)+"px";gb.style.top=(minY-m)+"px";
      gb.style.width=(maxX-minX+m*2)+"px";gb.style.height=(maxY-minY+m*2)+"px";
    } else { gb.style.display="none"; }
  }
  document.getElementById("btn-dup").disabled=count<1;
  document.getElementById("btn-del").disabled=count<1;
  const atBtn=document.getElementById("btn-align-toggle"); if(atBtn){atBtn.disabled=count<2;atBtn.style.opacity=count>1?"1":"0.4";}
  if(count===1){const item=items.find(i=>i.id===[...selIds][0]);if(item)showProps(item);}
  else{document.getElementById("no-sel").style.display="block";document.getElementById("no-sel").textContent=count>1?count+" items selected":"Click an item to edit";document.getElementById("sel-props").style.display="none";}
}
function showProps(item){
  const d=defOf(item.type);
  document.getElementById("no-sel").style.display="none"; document.getElementById("sel-props").style.display="block";
  document.getElementById("px").value=r2(item.x); document.getElementById("py").value=r2(item.y);
  document.getElementById("pw").value=item.w; document.getElementById("ph").value=item.h;
  document.getElementById("lock-btn").textContent=item.locked?"üîí Locked":"üîì Lock";
  const ss=document.getElementById("seats-section");
  if(d&&d.seats>0){ss.style.display="block";document.getElementById("prop-seats").textContent=d.seats;const tn=getTableNums();document.getElementById("prop-tnum").textContent=tn[item.id]?"T"+tn[item.id]:"‚Äî";}
  else ss.style.display="none";
  document.getElementById("st-pos").innerHTML=`Position: <span>${r2(item.x)}ft, ${r2(item.y)}ft</span>`;
  document.getElementById("st-size").innerHTML=`Size: <span>${item.w}ft √ó ${item.h}ft</span>`;
  updateRotDial();
}

function propChange(p){const id=[...selIds][0];if(!id)return;const item=items.find(i=>i.id===id);if(!item||item.locked)return;const v=parseFloat(document.getElementById("p"+p).value);if(isNaN(v))return;pushUndo();item[p]=v;renderAll();showProps(item);}

// ‚îÄ‚îÄ CANVAS EVENTS ‚îÄ‚îÄ
let selBoxActive=false, selBoxStart={};
function setupCanvasEvents(){
  const ca=document.getElementById("canvas-area");
  ca.addEventListener("wheel",e=>{e.preventDefault();zoomAt(e.clientX,e.clientY,clamp(zoom*(e.deltaY<0?1.1:0.91),0.2,3));},{passive:false});
  ca.addEventListener("mousedown",e=>{
    const onBg=e.target===ca||e.target===document.getElementById("world")||e.target===document.getElementById("tent")||e.target===document.getElementById("grid-cvs");
    if(e.button===1||(tool==="pan"&&e.button===0)||e.altKey){startPan(e);return;}
    if(onBg&&e.button===0&&tool==="select"){if(!e.shiftKey)deselect();startSelBox(e);}
  });
}

function setupGroupBox(){
  const gb=document.getElementById("grp-box");
  if(!gb)return;
  gb.addEventListener("mousedown",e=>{
    if(e.button!==0)return;
    e.preventDefault();e.stopPropagation();
    const starts={};
    selIds.forEach(sid=>{const it=items.find(i=>i.id===sid);if(it)starts[sid]={x:it.x,y:it.y};});
    let moved=false;
    const sx=e.clientX,sy=e.clientY;
    const mv=ev=>{
      const dx=(ev.clientX-sx)/(BASE*zoom),dy=(ev.clientY-sy)/(BASE*zoom);
      if(!moved&&(Math.abs(dx)>0.1||Math.abs(dy)>0.1)){pushUndo();moved=true;}
      selIds.forEach(sid=>{
        const it=items.find(i=>i.id===sid);if(!it||it.locked)return;
        const ss=starts[sid];if(!ss)return;
        it.x=r2(clamp(sp(ss.x+dx),0,tentL-it.w));it.y=r2(clamp(sp(ss.y+dy),0,tentW-it.h));
        const el=document.getElementById("ci"+sid);
        if(el){const d=defOf(it.type);const cSz=Math.max(6,Math.min(11,BASE*zoom*0.78));const pad=(d&&d.seats>0&&d.shape!=="door"&&d.shape!=="pole"&&d.shape!=="chairrow")?cSz+4:0;el.style.left=(it.x*BASE*zoom-pad)+"px";el.style.top=(it.y*BASE*zoom-pad)+"px";}
      });
      updateSelUI();
    };
    const up=ev=>{
      document.removeEventListener("mousemove",mv);document.removeEventListener("mouseup",up);
      if(moved){renderAll();updateCapacity();}
    };
    document.addEventListener("mousemove",mv);document.addEventListener("mouseup",up);
  });
}

function startPan(e){
  const ca=document.getElementById("canvas-area"), s={mx:e.clientX,my:e.clientY,px:panX,py:panY};
  ca.classList.add("dragging");
  const mv=ev=>{panX=s.px+(ev.clientX-s.mx);panY=s.py+(ev.clientY-s.my);document.getElementById("world").style.left=panX+"px";document.getElementById("world").style.top=panY+"px";};
  const up=()=>{ca.classList.remove("dragging");document.removeEventListener("mousemove",mv);document.removeEventListener("mouseup",up);};
  document.addEventListener("mousemove",mv);document.addEventListener("mouseup",up);e.preventDefault();
}
function startSelBox(e){
  const ca=document.getElementById("canvas-area"),rect=ca.getBoundingClientRect();
  selBoxStart={sx:e.clientX-rect.left,sy:e.clientY-rect.top};selBoxActive=true;
  const sr=document.getElementById("sel-rect");sr.style.display="block";sr.style.left=selBoxStart.sx+"px";sr.style.top=selBoxStart.sy+"px";sr.style.width="0";sr.style.height="0";
  const mv=ev=>{if(!selBoxActive)return;const cx=ev.clientX-rect.left,cy=ev.clientY-rect.top;sr.style.left=Math.min(cx,selBoxStart.sx)+"px";sr.style.top=Math.min(cy,selBoxStart.sy)+"px";sr.style.width=Math.abs(cx-selBoxStart.sx)+"px";sr.style.height=Math.abs(cy-selBoxStart.sy)+"px";};
  const up=ev=>{
    if(!selBoxActive)return;selBoxActive=false;sr.style.display="none";
    const cx=ev.clientX-rect.left,cy=ev.clientY-rect.top;
    const x1=Math.min(cx,selBoxStart.sx),y1=Math.min(cy,selBoxStart.sy),x2=Math.max(cx,selBoxStart.sx),y2=Math.max(cy,selBoxStart.sy);
    if(Math.abs(x2-x1)>4||Math.abs(y2-y1)>4){
      const tx1=(x1-panX)/(BASE*zoom),ty1=(y1-panY)/(BASE*zoom),tx2=(x2-panX)/(BASE*zoom),ty2=(y2-panY)/(BASE*zoom);
      if(!ev.shiftKey)selIds.clear();
      items.forEach(it=>{const cx2=it.x+it.w/2,cy2=it.y+it.h/2;if(cx2>=tx1&&cx2<=tx2&&cy2>=ty1&&cy2<=ty2)selIds.add(it.id);});
      updateSelUI();
    }
    document.removeEventListener("mousemove",mv);document.removeEventListener("mouseup",up);
  };
  document.addEventListener("mousemove",mv);document.addEventListener("mouseup",up);
}

// ‚îÄ‚îÄ ITEM DRAG ‚îÄ‚îÄ
let itemDrag=null;
function startItemDrag(e,id){
  if(tool==="pan"||e.button!==0)return;e.preventDefault();e.stopPropagation();
  if(!selIds.has(id)){if(!e.shiftKey)selIds.clear();selIds.add(id);updateSelUI();}
  const starts={};selIds.forEach(sid=>{const it=items.find(i=>i.id===sid);if(it)starts[sid]={x:it.x,y:it.y};});
  itemDrag={id,clientX:e.clientX,clientY:e.clientY,starts,moved:false};
  document.addEventListener("mousemove",onItemMove);document.addEventListener("mouseup",onItemUp);
}
function onItemMove(e){
  if(!itemDrag)return;
  const dx=(e.clientX-itemDrag.clientX)/(BASE*zoom),dy=(e.clientY-itemDrag.clientY)/(BASE*zoom);
  if(!itemDrag.moved&&(Math.abs(dx)>0.1||Math.abs(dy)>0.1)){pushUndo();itemDrag.moved=true;}
  selIds.forEach(sid=>{
    const it=items.find(i=>i.id===sid);if(!it||it.locked)return;
    const ss=itemDrag.starts[sid];if(!ss)return;
    it.x=r2(clamp(sp(ss.x+dx),0,tentL-it.w));it.y=r2(clamp(sp(ss.y+dy),0,tentW-it.h));
    const el=document.getElementById("ci"+sid);
    if(el){const d=defOf(it.type);const cSz=Math.max(6,Math.min(11,BASE*zoom*0.78));const pad=(d&&d.seats>0&&d.shape!=="door"&&d.shape!=="pole")?cSz+4:0;el.style.left=(it.x*BASE*zoom-pad)+"px";el.style.top=(it.y*BASE*zoom-pad)+"px";}
  });
  if(selIds.size===1){const it=items.find(i=>i.id===[...selIds][0]);if(it){document.getElementById("st-pos").innerHTML=`Position: <span>${r2(it.x)}ft, ${r2(it.y)}ft</span>`;document.getElementById("px").value=r2(it.x);document.getElementById("py").value=r2(it.y);}}
}
function onItemUp(){document.removeEventListener("mousemove",onItemMove);document.removeEventListener("mouseup",onItemUp);if(itemDrag&&itemDrag.moved)updateCapacity();itemDrag=null;}

// ‚îÄ‚îÄ PALETTE DRAG ‚îÄ‚îÄ
let palDrag=null, ghost=null;
function startPalDrag(e,d){
  e.preventDefault();palDrag=d;ghost=document.createElement("div");
  const wpx=d.w*BASE*zoom,hpx=d.h*BASE*zoom,cSz=Math.max(6,Math.min(11,BASE*zoom*0.78));
  const pad=(d.seats>0&&d.shape!=="door"&&d.shape!=="pole")?cSz+4:0;
  let bg=d.bg;if(d.shape==="check")bg=`repeating-conic-gradient(${d.bg} 0% 25%,#b3dff0 0% 50%)`;
  ghost.style.cssText=`position:fixed;pointer-events:none;z-index:9999;opacity:0.85;width:${wpx+pad*2}px;height:${hpx+pad*2}px;`;
  const inner=document.createElement("div");
  inner.style.cssText=`position:absolute;left:${pad}px;top:${pad}px;width:${wpx}px;height:${hpx}px;background:${bg};border:2px solid ${d.bd};border-radius:${d.shape==="circle"?"50%":"4px"};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:${d.fg};font-family:'DM Sans',sans-serif;`;
  inner.textContent=d.lbl;ghost.appendChild(inner);document.body.appendChild(ghost);
  moveGhost(e);document.addEventListener("mousemove",moveGhost);document.addEventListener("mouseup",dropPal);
}
function moveGhost(e){if(!ghost)return;ghost.style.left=(e.clientX-ghost.offsetWidth/2)+"px";ghost.style.top=(e.clientY-ghost.offsetHeight/2)+"px";}
function dropPal(e){
  document.removeEventListener("mousemove",moveGhost);document.removeEventListener("mouseup",dropPal);
  if(ghost){ghost.remove();ghost=null;}if(!palDrag)return;
  const d=palDrag;palDrag=null;
  const tent=document.getElementById("tent"),rect=tent.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  if(mx<0||mx>rect.width||my<0||my>rect.height)return;
  pushUndo();
  const ni={id:nid++,type:d.type,x:r2(clamp(sp(mx/(BASE*zoom)-d.w/2),0,tentL-d.w)),y:r2(clamp(sp(my/(BASE*zoom)-d.h/2),0,tentW-d.h)),w:d.w,h:d.h,rot:0,locked:false,zIndex:10};
  items.push(ni);selIds.clear();selIds.add(ni.id);renderAll();toast("Added "+d.lbl);
}

// ‚îÄ‚îÄ ITEM ACTIONS ‚îÄ‚îÄ
function deleteSelected(){if(!selIds.size)return;pushUndo();items=items.filter(i=>!selIds.has(i.id));selIds.clear();renderAll();}
function clearAll(){if(!confirm("Remove all items from the canvas?"))return;pushUndo();items=[];selIds.clear();renderAll();}
function duplicate(){
  if(!selIds.size)return;pushUndo();const nids=[];
  [...selIds].forEach(sid=>{const it=items.find(i=>i.id===sid);if(!it)return;const ni={...it,id:nid++,x:r2(Math.min(it.x+2,tentL-it.w)),y:r2(Math.min(it.y+2,tentW-it.h))};items.push(ni);nids.push(ni.id);});
  selIds.clear();nids.forEach(id=>selIds.add(id));renderAll();toast("Duplicated "+nids.length+" item(s)");
}
function rotateSel(step=15){
  pushUndo();
  [...selIds].forEach(sid=>{
    const it=items.find(i=>i.id===sid);if(!it||it.locked)return;
    setItemRot(it, ((it.rot||0)+step+360)%360);
  });
  renderAll(); updateRotDial();
}

function setRotDeg(deg, addUndo=false){
  deg=((deg%360)+360)%360;
  if(addUndo) pushUndo();
  [...selIds].forEach(sid=>{
    const it=items.find(i=>i.id===sid);if(!it||it.locked)return;
    setItemRot(it, deg);
  });
  renderAll(); updateRotDial();
}

function setItemRot(it, deg){
  it.rot = ((deg%360)+360)%360;
}

function updateRotDial(){
  const dial=document.getElementById('rot-dial');
  const inp=document.getElementById('rot-input');
  if(!dial)return;
  const it=selIds.size===1?items.find(i=>i.id===[...selIds][0]):null;
  const deg=it?(it.rot||0):0;
  if(inp)inp.value=Math.round(deg);
  drawRotDial(dial, deg);
}

function drawRotDial(cvs, deg){
  const ctx=cvs.getContext('2d');
  const cx=20,cy=20,r=16;
  ctx.clearRect(0,0,40,40);
  // Outer ring
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle='rgba(65,184,234,0.3)';ctx.lineWidth=2;ctx.stroke();
  // Tick marks: bold every 90¬∞, fine every 15¬∞
  for(let a=0;a<360;a+=15){
    const rad=(a-90)*Math.PI/180;
    const isMajor=(a%90===0);
    const inner=isMajor?r-5:r-3;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(rad)*inner,cy+Math.sin(rad)*inner);
    ctx.lineTo(cx+Math.cos(rad)*r,cy+Math.sin(rad)*r);
    ctx.strokeStyle=isMajor?'rgba(65,184,234,0.7)':'rgba(65,184,234,0.25)';
    ctx.lineWidth=isMajor?1.5:0.8;ctx.stroke();
  }
  // Filled arc showing current rotation
  const startRad=-Math.PI/2;
  const endRad=(deg-90)*Math.PI/180;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r-4,startRad,endRad,false);ctx.closePath();
  ctx.fillStyle='rgba(0,147,199,0.18)';ctx.fill();
  // Needle
  const needleRad=(deg-90)*Math.PI/180;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx+Math.cos(needleRad)*(r-3),cy+Math.sin(needleRad)*(r-3));
  ctx.strokeStyle='#41b8ea';ctx.lineWidth=2;ctx.lineCap='round';ctx.stroke();
  // Center dot
  ctx.beginPath();ctx.arc(cx,cy,3,0,Math.PI*2);
  ctx.fillStyle='#0093c7';ctx.fill();
}

function setupRotDial(){
  const dial=document.getElementById('rot-dial');
  if(!dial)return;
  drawRotDial(dial,0);
  let dragging=false;
  dial.addEventListener('mousedown',e=>{
    e.preventDefault();e.stopPropagation();
    pushUndo(); // single undo entry for the whole drag
    dragging=true;
    handleDialMove(e,dial);
  });
  const onMove=e=>{if(dragging)handleDialMove(e,dial);};
  const onUp=()=>{dragging=false;};
  window.addEventListener('mousemove',onMove);
  window.addEventListener('mouseup',onUp);
}

function handleDialMove(e,dial){
  const rect=dial.getBoundingClientRect();
  const cx=rect.left+20,cy=rect.top+20;
  const dx=e.clientX-cx,dy=e.clientY-cy;
  let deg=Math.round(Math.atan2(dy,dx)*180/Math.PI+90);
  deg=((deg%360)+360)%360;
  setRotDeg(deg); // no extra undo ‚Äî already pushed on mousedown
}


function toggleLock(){const id=[...selIds][0];if(!id)return;const it=items.find(i=>i.id===id);if(!it)return;it.locked=!it.locked;renderAll();showProps(it);}
function bringFront(){[...selIds].forEach(sid=>{const it=items.find(i=>i.id===sid);if(it)it.zIndex=(it.zIndex||10)+5;});renderAll();}
function sendBack(){[...selIds].forEach(sid=>{const it=items.find(i=>i.id===sid);if(it)it.zIndex=Math.max(5,(it.zIndex||10)-5);});renderAll();}

// ‚îÄ‚îÄ ALIGN ‚îÄ‚îÄ
function alignSel(dir){
  if(selIds.size<2)return;pushUndo();
  const sel=items.filter(i=>selIds.has(i.id)&&!i.locked);
  const minX=Math.min(...sel.map(i=>i.x)),maxX=Math.max(...sel.map(i=>i.x+i.w));
  const minY=Math.min(...sel.map(i=>i.y)),maxY=Math.max(...sel.map(i=>i.y+i.h));
  const midX=(minX+maxX)/2,midY=(minY+maxY)/2;
  sel.forEach(it=>{if(dir==="left")it.x=minX;if(dir==="right")it.x=r2(maxX-it.w);if(dir==="centerH")it.x=r2(midX-it.w/2);if(dir==="top")it.y=minY;if(dir==="bottom")it.y=r2(maxY-it.h);if(dir==="centerV")it.y=r2(midY-it.h/2);});
  renderAll();toast("Aligned: "+dir);
}
function distribute(axis){
  if(selIds.size<3)return;pushUndo();
  const sel=items.filter(i=>selIds.has(i.id)&&!i.locked);
  if(axis==="h"){sel.sort((a,b)=>a.x-b.x);const span=sel[sel.length-1].x+sel[sel.length-1].w-sel[0].x,gap=(span-sel.reduce((s,i)=>s+i.w,0))/(sel.length-1);let x=sel[0].x;sel.forEach(it=>{it.x=r2(x);x+=it.w+gap;});}
  else{sel.sort((a,b)=>a.y-b.y);const span=sel[sel.length-1].y+sel[sel.length-1].h-sel[0].y,gap=(span-sel.reduce((s,i)=>s+i.h,0))/(sel.length-1);let y=sel[0].y;sel.forEach(it=>{it.y=r2(y);y+=it.h+gap;});}
  renderAll();toast("Distributed "+axis.toUpperCase());
}

// ‚îÄ‚îÄ UNDO/REDO ‚îÄ‚îÄ
function snapState(){return JSON.parse(JSON.stringify(items));}
function pushUndo(){history.push(snapState());if(history.length>50)history.shift();future=[];updUndoBtn();}
function undo(){if(!history.length)return;future.push(snapState());items=history.pop();selIds.clear();renderAll();updUndoBtn();toast("Undo");}
function redo(){if(!future.length)return;history.push(snapState());items=future.pop();selIds.clear();renderAll();updUndoBtn();toast("Redo");}
function updUndoBtn(){document.getElementById("btn-undo").disabled=!history.length;document.getElementById("btn-redo").disabled=!future.length;}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
function onKey(e){
  if(["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))return;
  if(e.key==="Delete"||e.key==="Backspace")deleteSelected();
  if(e.key==="Escape")deselect();
  if(e.key==="r"||e.key==="R"){if(e.shiftKey)rotateSel(-15);else rotateSel(15);}
  if(e.key==="v"||e.key==="V")setTool("select");
  if(e.key==="h"||e.key==="H")setTool("pan");
  if(e.key===" "){setTool(tool==="pan"?"select":"pan");e.preventDefault();}
  if((e.ctrlKey||e.metaKey)&&e.key==="z"){undo();e.preventDefault();}
  if((e.ctrlKey||e.metaKey)&&(e.key==="y"||(e.shiftKey&&e.key==="z"))){redo();e.preventDefault();}
  if((e.ctrlKey||e.metaKey)&&e.key==="d"){duplicate();e.preventDefault();}
  if((e.ctrlKey||e.metaKey)&&e.key==="a"){e.preventDefault();selIds.clear();items.forEach(i=>selIds.add(i.id));updateSelUI();}
  if(e.key==="?")toast("V=Select  H=Pan  R=Rotate 15¬∞  Shift+R=Rotate -15¬∞  Del=Delete  Ctrl+Z=Undo  Ctrl+D=Dupe");
  if(e.shiftKey&&e.key==="ArrowRight"){dirDupe("right");e.preventDefault();}
  if(e.shiftKey&&e.key==="ArrowLeft") {dirDupe("left"); e.preventDefault();}
  if(e.shiftKey&&e.key==="ArrowDown") {dirDupe("down"); e.preventDefault();}
  if(e.shiftKey&&e.key==="ArrowUp")   {dirDupe("up");   e.preventDefault();}
}

// ‚îÄ‚îÄ CAPACITY & SUMMARY ‚îÄ‚îÄ
function updateCapacity(){const t=items.reduce((s,i)=>{const d=defOf(i.type);return s+(d?d.seats:0);},0);document.getElementById("cap-num").textContent=t;}
function updateSummary(){
  if(!document.getElementById("panel-summary").classList.contains("active"))return;
  const counts={};items.forEach(i=>{const d=defOf(i.type);if(!d)return;if(!counts[i.type])counts[i.type]={d,count:0,seats:0};counts[i.type].count++;counts[i.type].seats+=d.seats;});
  const el=document.getElementById("summary-content");
  if(!Object.keys(counts).length){el.innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px 0;font-style:italic;">No items yet</p>';return;}
  let html="",totalG=0;
  Object.values(counts).forEach(({d,count,seats})=>{totalG+=seats;html+=`<div class="sum-row"><div class="sum-dot" style="background:${d.bg};border:1px solid ${d.bd};"></div><div class="sum-name">${d.lbl} <span style="font-size:9px;color:var(--muted)">${d.sub}</span></div><div class="sum-count">√ó${count}</div></div>`;});
  if(totalG>0)html+=`<div class="sum-total"><div class="sum-total-lbl">üë• Total Guests</div><div class="sum-total-val">${totalG}</div></div>`;
  el.innerHTML=html;
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ



function toggleEventBar() {
  const bar   = document.getElementById('event-bar');
  const arrow = document.getElementById('event-bar-arrow');
  const hint  = document.querySelector('.eb-hint');
  const collapsed = bar.dataset.collapsed === 'true';
  bar.dataset.collapsed = collapsed ? 'false' : 'true';
  arrow.classList.toggle('collapsed', !collapsed);
  if (hint) hint.textContent = collapsed ? 'Click to collapse' : 'Click to expand';
}

function togglePalEvent() {
  const body  = document.getElementById('pal-event-body');
  const arrow = document.getElementById('pal-event-arrow');
  const open  = body.style.display === 'none';
  body.style.display  = open ? 'block' : 'none';
  arrow.classList.toggle('open', open);
}

function openPalTab(name) {
  document.querySelectorAll('.pal-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.pal-panel').forEach(p => { p.classList.remove('active'); p.style.display='none'; });
  const tab = document.getElementById('pal-tab-' + name);
  const panel = document.getElementById('pal-panel-' + name);
  if (tab)   tab.classList.add('active');
  if (panel) { panel.classList.add('active'); panel.style.display='flex'; }
}

function openTab(id){
  document.querySelectorAll(".sb-tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".sb-panel").forEach(p=>p.classList.remove("active"));
  document.getElementById("tab-"+id).classList.add("active");
  document.getElementById("panel-"+id).classList.add("active");
  if(id==="summary")updateSummary();
  if(id==="upsell")refreshSmartSuggestions();
  if(id==="saves")renderSaves();
}

// ‚îÄ‚îÄ SAVES (Cloud-synced via Firebase Realtime Database) ‚îÄ‚îÄ
function getSaves(){ return cloudSaves; }

function saveLayout(){
  _sceneSaveCurrent();
  const n=document.getElementById("cname").value.trim();
  if(!n){toast("Enter a name first");return;}
  const key=fbKey(n);
  const layoutData={tentW,tentL,items:JSON.parse(JSON.stringify(items)),nid,
    scenes:JSON.parse(JSON.stringify(scenes)),fieldElements:JSON.parse(JSON.stringify(fieldElements)),activeSceneIdx,
    evClient:document.getElementById("ev-client").value,evType:document.getElementById("ev-type").value,
    evDate:document.getElementById("ev-date").value,evVenue:document.getElementById("ev-venue").value,
    evNote:document.getElementById("ev-note").value};
  const record={_name:n,_savedAt:new Date().toLocaleDateString(),_tentW:tentW,_tentL:tentL,
    _json:JSON.stringify(layoutData)};
  fbDb.ref('saves/'+key).set(record).then(()=>{
    document.getElementById("cname").value="";toast("Saved: "+n);
  }).catch(err=>toast("Save failed: "+err.message));
}

function loadLayout(n){
  const saves=getSaves(),record=saves[n];if(!record||!record._json)return;
  const lay=JSON.parse(record._json);
  if(lay.scenes && lay.scenes.length>0){
    scenes=lay.scenes;fieldElements=lay.fieldElements||[];
    activateScene(Math.min(lay.activeSceneIdx||0,scenes.length-1), true);
  } else {
    tentW=lay.tentW;tentL=lay.tentL;items=lay.items||[];nid=lay.nid||items.length+1;
    scenes[0]=Object.assign(scenes[0]||{},{tentW,tentL,items:JSON.parse(JSON.stringify(items)),nid});
  }
  document.getElementById("tw").value=tentW;document.getElementById("tl").value=tentL;
  if(lay.evClient)document.getElementById("ev-client").value=lay.evClient;
  if(lay.evType)document.getElementById("ev-type").value=lay.evType;
  if(lay.evDate)document.getElementById("ev-date").value=lay.evDate;
  if(lay.evVenue)document.getElementById("ev-venue").value=lay.evVenue;
  if(lay.evNote)document.getElementById("ev-note").value=lay.evNote;
  const k=tentW+","+tentL,ps=document.getElementById("preset");ps.value=[...ps.options].some(o=>o.value===k)?k:"";
  selIds.clear();history=[];future=[];applyTent();fitView();renderAll();refreshEvent();renderSceneTabs();toast("Loaded: "+(record._name||n));
}

function delSave(n){
  fbDb.ref('saves/'+n).remove().catch(err=>toast("Delete failed: "+err.message));
}

function renderSaves(){
  const saves=getSaves();
  const keys=Object.keys(saves).sort((a,b)=>{
    const na=(saves[a]._name||a).toLowerCase(),nb=(saves[b]._name||b).toLowerCase();
    return na<nb?-1:na>nb?1:0;
  });
  const el=document.getElementById("saves-list");
  if(!el)return;
  if(!keys.length){el.innerHTML='<div class="no-saves">No saved layouts yet</div>';return;}
  el.innerHTML="";
  keys.forEach(n=>{
    const s=saves[n];const displayName=s._name||n;
    const r=document.createElement("div");r.className="save-row";
    r.innerHTML=`<div class="save-name" title="${displayName}">${displayName}<div style="font-size:9px;color:var(--muted)">${s._savedAt||s.savedAt||""} ¬∑ ${s._tentW||s.tentW}√ó${s._tentL||s.tentL}</div></div><button class="save-del" data-n="${n}">‚úï</button>`;
    r.querySelector(".save-del").addEventListener("click",e=>{e.stopPropagation();delSave(n);});
    r.addEventListener("click",()=>loadLayout(n));el.appendChild(r);
  });
}

// Migrate any existing localStorage saves to Firebase (one-time)
function migrateLocalSaves(){
  try{
    const local=JSON.parse(localStorage.getItem("ppr_v3")||"{}");
    const keys=Object.keys(local);
    if(!keys.length)return;
    const updates={};
    keys.forEach(n=>{
      const s=local[n];const key=fbKey(n);
      updates[key]={_name:n,_savedAt:s.savedAt||new Date().toLocaleDateString(),
        _tentW:s.tentW,_tentL:s.tentL,_json:JSON.stringify(s)};
    });
    fbDb.ref('saves').update(updates).then(()=>{
      localStorage.removeItem("ppr_v3");
      toast("Local saves synced to cloud");
    });
  }catch(e){}
}

// ‚îÄ‚îÄ EVENT PERSONALIZATION ‚îÄ‚îÄ
function refreshEvent(){
  refreshPreview();refreshBanner();
}
function refreshPreview(){
  const name  =document.getElementById("ev-client").value.trim();
  const type  =document.getElementById("ev-type").value;
  const date  =document.getElementById("ev-date").value;
  const venue =document.getElementById("ev-venue").value.trim();
  const guests=document.getElementById("ev-guests")?document.getElementById("ev-guests").value.trim():"";
  const note  =document.getElementById("ev-note").value.trim();
  const box   =document.getElementById("ev-preview");
  if(!name&&!type&&!date){box.innerHTML='<span style="font-size:11.5px;color:var(--muted);font-style:italic;">Fill in details above to see preview</span>';return;}
  const dateStr=date?new Date(date+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"}):"";
  const seatedGuests=items.reduce((s,i)=>{const d=defOf(i.type);return s+(d?d.seats:0);},0);
  const displayG=guests||(seatedGuests>0?seatedGuests:null);
  box.innerHTML=`
    
    <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);opacity:0.7;margin-bottom:6px;">‚õ∞ Peak Party Rentals</div>
    ${name?`<div class="ev-preview-name">${name}</div>`:""}
    ${type?`<div class="ev-preview-type">${type}</div>`:""}
    ${dateStr?`<div class="ev-preview-row">üìÖ <span>${dateStr}</span></div>`:""}
    ${venue?`<div class="ev-preview-row">üìç <span>${venue}</span></div>`:""}
    ${displayG?`<div class="ev-preview-row">üë• <span>${displayG} guests</span></div>`:""}
    <div class="ev-preview-row">‚õ∫ <span>${tentW} √ó ${tentL} ft Tent</span></div>
    ${note?`<div class="ev-preview-note">"${note}"</div>`:""}
  `;
}
function refreshBanner(){
  const name=document.getElementById("ev-client").value.trim();
  const type=document.getElementById("ev-type").value;
  const date=document.getElementById("ev-date").value;
  const banner=document.getElementById("ev-banner");
  if(!name){banner.classList.remove("visible");return;}
  banner.classList.add("visible");
  document.getElementById("evb-name").textContent=name+(type?" ‚Äî "+type.replace(/^\S+ /,""):"");
  const parts=[];
  if(date)parts.push(new Date(date+"T12:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}));
  parts.push(tentW+"√ó"+tentL+" ft");
  const g=items.reduce((s,i)=>{const d=defOf(i.type);return s+(d?d.seats:0);},0);
  if(g)parts.push(g+" seats");
  document.getElementById("evb-det").textContent=parts.join("  ¬∑  ");
  // Also update event-bar summary chip
  const ebSum = document.getElementById('event-bar-summary');
  if (ebSum) {
    const sumParts = [];
    if (name)  sumParts.push(name);
    if (type)  sumParts.push(type.replace(/^\S+ /,''));
    if (date)  sumParts.push(new Date(date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}));
    if (parts.find(p=>p.includes('seats'))) sumParts.push(parts.find(p=>p.includes('seats')));
    ebSum.textContent = sumParts.join('  ¬∑  ');
  }
}

// ‚îÄ‚îÄ UPSELLS ‚îÄ‚îÄ
function buildUpsellList(){
  const container=document.getElementById("upsell-list");
  UPSELLS.forEach(u=>{
    const div=document.createElement("div");div.className="upsell-item";div.id="upsell-"+u.id;
    div.innerHTML=`<input type="checkbox" id="uchk-${u.id}"><div class="upsell-item-body"><div class="upsell-item-name">${u.icon} ${u.name}</div><div class="upsell-item-desc">${u.desc}</div><div class="upsell-item-price">${u.price}</div></div>`;
    div.querySelector("input").addEventListener("change",()=>div.classList.toggle("checked",div.querySelector("input").checked));
    div.addEventListener("click",e=>{if(e.target.tagName==="INPUT")return;const chk=div.querySelector("input");chk.checked=!chk.checked;div.classList.toggle("checked",chk.checked);});
    container.appendChild(div);
  });
}
function refreshSmartSuggestions(){
  const area=document.getElementById("upsell-smart");
  const hasTables=items.some(i=>{const d=defOf(i.type);return d&&d.seats>0;});
  const hasDance=items.some(i=>i.type==="dance");
  const hasDJ=items.some(i=>i.type==="dj");
  const hasBar=items.some(i=>i.type==="bar");
  const hasBuff=items.some(i=>i.type==="buffet");
  const guests=items.reduce((s,i)=>{const d=defOf(i.type);return s+(d?d.seats:0);},0);
  const tblCount=items.filter(i=>{const d=defOf(i.type);return d&&d.seats>0;}).length;
  const sugg=[];
  if(guests>0)     sugg.push({icon:"üí°",title:"Uplighting",     why:`With ${guests} seated guests, uplighting transforms the tent atmosphere and photos.`});
  if(hasTables)    sugg.push({icon:"üé®",title:"Linen Package",   why:`You have ${tblCount} table${tblCount!==1?"s":""} ‚Äî matching linens instantly upgrade the look.`});
  if(hasDance)     sugg.push({icon:"üî≤",title:"Dance Flooring",  why:"Your dance floor looks great on portable modular flooring ‚Äî guests love it."});
  if(hasBar)       sugg.push({icon:"ü™ü",title:"Tent Sidewalls",   why:"Add sidewalls to keep the bar area comfortable and the setup looking sharp."});
  if(hasBuff)      sugg.push({icon:"ü™ü",title:"Tent Sidewalls",   why:"Sidewalls next to a buffet line keep food fresh and block wind perfectly."});
  if(guests>50)    sugg.push({icon:"üå°",title:"Heating / Cooling",why:`With ${guests}+ guests, temperature control keeps everyone comfortable.`});
  if(guests>75)    sugg.push({icon:"‚ú®",title:"String Lights",    why:"Large events shine with overhead bistro string lights ‚Äî our most popular upgrade."});
  if(!sugg.length){area.innerHTML='<span style="font-size:10px;color:var(--muted);font-style:italic;">Add tables, a DJ, or a dance floor to get suggestions</span>';return;}
  area.innerHTML=sugg.map(s=>`<div class="upsell-smart-card"><div class="usc-title">${s.icon} ${s.title}</div><div class="usc-why">${s.why}</div></div>`).join("");
}
function copyUpsellQuote(){
  const client=document.getElementById("ev-client").value.trim()||"Client";
  const date=document.getElementById("ev-date").value;
  const checked=UPSELLS.filter(u=>document.getElementById("uchk-"+u.id)?.checked);
  if(!checked.length){toast("Check some add-ons first!");return;}
  const dateStr=date?new Date(date+"T12:00:00").toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}):"";
  let text=`Peak Party Rentals ‚Äî Add-On Quote\n`;
  text+=`Client: ${client}${dateStr?"  |  "+dateStr:""}\n`;
  text+=`${Array(42).fill("‚îÄ").join("")}\n`;
  checked.forEach(u=>{text+=`${u.icon} ${u.name.padEnd(26)} ${u.price}\n`;});
  text+=`${Array(42).fill("‚îÄ").join("")}\n`;
  text+=`Questions? Call (215) 385-4040\nor email events@peakpartyrentals.com`;
  navigator.clipboard.writeText(text).then(()=>toast("Quote copied!")).catch(()=>toast("Copy failed"));
}

// ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ
function printLayout(){
  const name  =document.getElementById("ev-client").value.trim()||document.getElementById("cname").value.trim()||"Floor Plan";
  const type  =document.getElementById("ev-type").value;
  const date  =document.getElementById("ev-date").value;
  const venue =document.getElementById("ev-venue").value.trim();
  const note  =document.getElementById("ev-note").value.trim();
  const guests=items.reduce((s,i)=>{const d=defOf(i.type);return s+(d?d.seats:0);},0);
  const dateStr=date?new Date(date+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"}):"";
  const checked=UPSELLS.filter(u=>document.getElementById("uchk-"+u.id)?.checked);
  const ph=document.getElementById("print-header");
  ph.style.display="block";
  ph.innerHTML=`<div style="font-family:'DM Sans',sans-serif;padding:0 24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding-bottom:12px;border-bottom:2.5px solid #0093c7;margin-bottom:14px;">
      <img src="data:image/svg+xml;base64,${LOGO_LIGHT_B64}" style="height:42px;">
      <div style="text-align:right;">
        <div style="font-size:19.5px;font-weight:700;color:#30393d;">${name}${type?" ‚Äî "+type.replace(/^\S+ /,""):""}</div>
        <div style="font-size:12.6px;color:#5a7a88;margin-top:3px;">${[dateStr,venue].filter(Boolean).join("  ¬∑  ")}</div>
      </div>
    </div>
    <div style="display:flex;gap:14px;margin-bottom:14px;font-size:12.6px;flex-wrap:wrap;">
      <div style="background:#f0fafd;border:1px solid #b3dff0;border-radius:7px;padding:7px 12px;"><strong style="color:#0093c7;">Tent Size</strong><br>${tentW} √ó ${tentL} ft</div>
      <div style="background:#f0fafd;border:1px solid #b3dff0;border-radius:7px;padding:7px 12px;"><strong style="color:#0093c7;">Seated Guests</strong><br>${guests}</div>
      <div style="background:#f0fafd;border:1px solid #b3dff0;border-radius:7px;padding:7px 12px;"><strong style="color:#0093c7;">Items on Layout</strong><br>${items.length}</div>
      ${checked.length?`<div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:7px;padding:7px 12px;"><strong style="color:#92400e;">Add-Ons Selected</strong><br>${checked.map(u=>u.icon+" "+u.name).join(", ")}</div>`:""}</div>
    ${note?`<div style="border-left:3px solid #0093c7;padding:7px 12px;font-size:12.6px;color:#30393d;font-style:italic;margin-bottom:14px;">"${note}"<br><small style="font-style:normal;color:#5a7a88;font-weight:600;">‚Äî Peak Party Rentals</small></div>`:""}
    <div style="font-size:12.6px;font-weight:700;color:#30393d;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.8px;">Floor Plan</div>
  </div>`;
  window.print();
  ph.style.display="none";ph.innerHTML="";
}


// ‚îÄ‚îÄ DIRECTIONAL DUPLICATE ‚îÄ‚îÄ
function getGapOverride() {
  const v = parseFloat(document.getElementById("dupe-gap")?.value);
  return isNaN(v) ? null : v;
}

function dirDupe(dir) {
  if (!selIds.size) return;
  const id = [...selIds][0];
  const src = items.find(i => i.id === id);
  if (!src) return;

  // Detect spacing from nearest same-type neighbor in that direction
  const gap = getGapOverride() ?? detectGap(src, dir);
  const offset = (dir === 'right' || dir === 'left') ? src.w + gap : src.h + gap;

  let nx = src.x, ny = src.y;
  if (dir === 'right') nx = src.x + offset;
  if (dir === 'left')  nx = src.x - offset;
  if (dir === 'down')  ny = src.y + offset;
  if (dir === 'up')    ny = src.y - offset;

  // Clamp to tent
  nx = r2(clamp(snapOn ? Math.round(nx/snapSz)*snapSz : nx, 0, tentL - src.w));
  ny = r2(clamp(snapOn ? Math.round(ny/snapSz)*snapSz : ny, 0, tentW - src.h));

  pushUndo();
  const ni = { ...src, id: nid++, x: nx, y: ny };
  items.push(ni);
  selIds.clear(); selIds.add(ni.id);
  renderAll();
  toast(`Duplicated ${dir} (${gap}ft gap)`);
}

function detectGap(src, dir) {
  // Find nearest neighbor item in the given direction
  let best = null, bestDist = Infinity;
  items.forEach(it => {
    if (it.id === src.id) return;
    if (dir === 'right') {
      if (it.x > src.x + src.w - 0.1) {
        const gap = it.x - (src.x + src.w);
        if (gap >= 0 && gap < bestDist) { bestDist = gap; best = it; }
      }
    } else if (dir === 'left') {
      if (it.x + it.w < src.x + 0.1) {
        const gap = src.x - (it.x + it.w);
        if (gap >= 0 && gap < bestDist) { bestDist = gap; best = it; }
      }
    } else if (dir === 'down') {
      if (it.y > src.y + src.h - 0.1) {
        const gap = it.y - (src.y + src.h);
        if (gap >= 0 && gap < bestDist) { bestDist = gap; best = it; }
      }
    } else if (dir === 'up') {
      if (it.y + it.h < src.y + 0.1) {
        const gap = src.y - (it.y + it.h);
        if (gap >= 0 && gap < bestDist) { bestDist = gap; best = it; }
      }
    }
  });
  // Default gap gives 2ft clearance between chair backs.
  // Chair overhang from table edge ‚âà 0.85ft each side ‚Üí gap = 0.85+2.0+0.85 = 3.7ft
  // Exception: along the LENGTH of a banquet table (no chairs on the short ends)
  if (!best) {
    const d = defOf(src.type);
    if (!d || d.seats === 0) return 1;           // non-seating items: 1ft
    if (d.shape === 'circle') return 3.7;         // round tables: chairs all around
    // Rect (banquet) tables: chairs on long sides (h dimension)
    // Going left/right along length ‚Üí no end chairs ‚Üí tighter gap ok
    // Going up/down across width ‚Üí chairs face each other ‚Üí need full clearance
    const CHAIR_OVERHANG = 0.85;
    const acrossChairs = (dir === 'up' || dir === 'down');
    return acrossChairs ? r2(CHAIR_OVERHANG * 2 + 2.0) : 1;
  }
  // When a neighbor IS found, also apply a minimum gap to avoid chair collision
  const d = defOf(src.type);
  if (d && d.seats > 0) {
    const CHAIR_OVERHANG = 0.85;
    const acrossChairs = d.shape === 'circle' ||
                         ((dir === 'up' || dir === 'down') && d.shape === 'rect');
    const minGap = acrossChairs ? r2(CHAIR_OVERHANG * 2 + 2.0) : 0.5;
    return Math.max(r2(bestDist), minGap);
  }
  return r2(bestDist);
}

function dupeRow() {
  // Fill the tent width from the selected item going right, matching spacing
  if (!selIds.size) return;
  const id = [...selIds][0];
  const src = items.find(i => i.id === id);
  if (!src) return;
  const gap = getGapOverride() ?? detectGap(src, 'right'); // right = along length, tight gap ok
  const step = src.w + gap;
  pushUndo();
  let x = src.x + step;
  let added = 0;
  while (x + src.w <= tentL + 0.01) {
    items.push({ ...src, id: nid++, x: r2(clamp(x, 0, tentL - src.w)), y: src.y });
    x += step; added++;
    if (added > 30) break; // safety
  }
  renderAll();
  toast(`Filled row: added ${added} item${added !== 1 ? 's' : ''}`);
}

function dupeCol() {
  // Fill the tent height from the selected item going down, matching spacing
  if (!selIds.size) return;
  const id = [...selIds][0];
  const src = items.find(i => i.id === id);
  if (!src) return;
  const gap = getGapOverride() ?? detectGap(src, 'down'); // down = across chairs, uses 2ft clearance
  const step = src.h + gap;
  pushUndo();
  let y = src.y + step;
  let added = 0;
  while (y + src.h <= tentW + 0.01) {
    items.push({ ...src, id: nid++, x: src.x, y: r2(clamp(y, 0, tentW - src.h)) });
    y += step; added++;
    if (added > 30) break;
  }
  renderAll();
  toast(`Filled column: added ${added} item${added !== 1 ? 's' : ''}`);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3D VIEW ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _3scene=null,_3cam=null,_3renderer=null,_3animId=null;
let _3o = { theta:-0.55, phi:1.05, r:0, tx:0, ty:0, tz:0,
            autoRotate:false, night:false, dragging:false, btn:-1, lx:0, ly:0 };

function open3DView(){
  const ov=document.getElementById('view3d-overlay');
  ov.style.display='flex';
  // Set logo
  document.getElementById('logo-3d').src='data:image/svg+xml;base64,'+LOGO_DARK_B64;
  // Set event label
  const n=document.getElementById('ev-client').value.trim();
  const t=document.getElementById('ev-type').value;
  document.getElementById('view3d-event-label').textContent = n?(n+(t?' ‚Äî '+t.replace(/^\S+ /,''):'')):'';
  // Load Three.js from CDN if needed
  if(!window.THREE){
    const s=document.createElement('script');
    s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
    s.onload=_3build;
    document.head.appendChild(s);
  } else { _3build(); }
}

function close3DView(){
  document.getElementById('view3d-overlay').style.display='none';
  if(_3animId){cancelAnimationFrame(_3animId);_3animId=null;}
  if(_3renderer){_3renderer.dispose();_3renderer=null;}
  _3scene=null;_3cam=null;
}

function reset3DCamera(){
  _3o.theta=-0.55;_3o.phi=1.05;
  _3o.r=Math.max(tentL,tentW)*1.65;
  _3o.tx=tentL/2;_3o.ty=0;_3o.tz=tentW/2;
  _3updateCam();
}

function toggle3DAutoRotate(){
  _3o.autoRotate=!_3o.autoRotate;
  document.getElementById('btn3d-rotate').className='btn3d'+(_3o.autoRotate?' on':'');
}

function toggle3DNight(){
  _3o.night=!_3o.night;
  const b=document.getElementById('btn3d-night');
  b.textContent=_3o.night?'‚òÄÔ∏è Day Mode':'üåô Night Mode';
  b.className='btn3d'+(_3o.night?' on':'');
  if(_3scene)_3build();
}

function _3updateCam(){
  if(!_3cam)return;
  const x=_3o.tx+_3o.r*Math.sin(_3o.phi)*Math.sin(_3o.theta);
  const y=_3o.ty+_3o.r*Math.cos(_3o.phi);
  const z=_3o.tz+_3o.r*Math.sin(_3o.phi)*Math.cos(_3o.theta);
  _3cam.position.set(x,y,z);
  _3cam.lookAt(_3o.tx,_3o.ty+1.5,_3o.tz);
}

function _3build(){
  const wrap=document.getElementById('view3d-wrap');
  if(!wrap)return;
  // Kill old renderer
  if(_3animId){cancelAnimationFrame(_3animId);_3animId=null;}
  if(_3renderer){_3renderer.dispose();}
  wrap.innerHTML='';
  const W=wrap.clientWidth||window.innerWidth;
  const H=wrap.clientHeight||(window.innerHeight-50);
  const night=_3o.night;
  const T=THREE;

  // ‚îÄ‚îÄ Scene ‚îÄ‚îÄ
  _3scene=new T.Scene();
  _3scene.background=new T.Color(night?0x06101a:0x8ec8e8);
  if(!night)_3scene.fog=new T.FogExp2(0xa8d8f0,0.005);
  else _3scene.fog=new T.FogExp2(0x050e16,0.006);

  // ‚îÄ‚îÄ Camera ‚îÄ‚îÄ
  _3cam=new T.PerspectiveCamera(48,W/H,0.1,800);
  if(!_3o.r||_3o.r<1)_3o.r=Math.max(tentL,tentW)*1.65;
  _3o.tx=tentL/2;_3o.ty=0;_3o.tz=tentW/2;
  _3updateCam();

  // ‚îÄ‚îÄ Renderer ‚îÄ‚îÄ
  _3renderer=new T.WebGLRenderer({antialias:true});
  _3renderer.setSize(W,H);
  _3renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  _3renderer.shadowMap.enabled=true;
  _3renderer.shadowMap.type=T.PCFSoftShadowMap;
  wrap.appendChild(_3renderer.domElement);

  // ‚îÄ‚îÄ Lighting ‚îÄ‚îÄ
  _3scene.add(new T.AmbientLight(night?0x1a2d3a:0xfff5e0, night?0.35:0.65));
  if(!night){
    const sun=new T.DirectionalLight(0xfff8f0,0.9);
    sun.position.set(tentL*1.2,tentL*0.9,tentW*0.6);
    sun.castShadow=true;
    sun.shadow.mapSize.set(2048,2048);
    const sc=sun.shadow.camera;
    sc.left=-tentL;sc.right=tentL*2;sc.top=tentW*2;sc.bottom=-tentW;sc.far=300;
    _3scene.add(sun);
    _3scene.add(Object.assign(new T.DirectionalLight(0xdeeeff,0.3),{position:new T.Vector3(-tentL,tentW,tentL)}));
  } else {
    // Warm interior lights
    [[tentL/2,4.5,tentW/2,0xffe080,2.2],[tentL/4,3.5,tentW/4,0xffcc60,1.2],[tentL*3/4,3.5,tentW*3/4,0xffe4a0,1.2]]
      .forEach(([x,y,z,c,i])=>{const pl=new T.PointLight(c,i,Math.max(tentL,tentW)*1.3);pl.position.set(x,y,z);_3scene.add(pl);});
  }

  // ‚îÄ‚îÄ Ground ‚îÄ‚îÄ
  const gGeo=new T.PlaneGeometry(tentL*8,tentW*8); gGeo.rotateX(-Math.PI/2);
  const gMesh=new T.Mesh(gGeo,new T.MeshLambertMaterial({color:night?0x071208:0x4a7830}));
  gMesh.position.set(tentL/2,-0.01,tentW/2); gMesh.receiveShadow=true; _3scene.add(gMesh);

  // ‚îÄ‚îÄ Tent ‚îÄ‚îÄ
  _3buildTent(T,night);

  // ‚îÄ‚îÄ Furniture ‚îÄ‚îÄ
  _3buildFurniture(T,night);

  // ‚îÄ‚îÄ Controls ‚îÄ‚îÄ
  _3setupControls(_3renderer.domElement);

  // ‚îÄ‚îÄ Resize ‚îÄ‚îÄ
  const onResize=()=>{
    const nW=wrap.clientWidth,nH=wrap.clientHeight;
    _3cam.aspect=nW/nH; _3cam.updateProjectionMatrix();
    _3renderer.setSize(nW,nH);
  };
  window.addEventListener('resize',onResize);

  // ‚îÄ‚îÄ Hide loader ‚îÄ‚îÄ
  document.getElementById('view3d-loading').style.display='none';

  // ‚îÄ‚îÄ Animate ‚îÄ‚îÄ
  function tick(){
    _3animId=requestAnimationFrame(tick);
    if(_3o.autoRotate){_3o.theta+=0.004;_3updateCam();}
    _3renderer.render(_3scene,_3cam);
  }
  tick();
}

function _3buildTent(T,night){
  const tL=tentL, tW=tentW;
  const wallH=8, hipBack=Math.min(tW*0.5,tL*0.45), ridgeH=wallH+Math.max(tW*0.13,2.5);
  const cx=tL/2, cz=tW/2;

  function makeFabricTex(){
    const c=document.createElement('canvas'); c.width=512; c.height=512;
    const ctx=c.getContext('2d');
    const g=ctx.createLinearGradient(0,0,512,512);
    g.addColorStop(0,'#f9f9f7'); g.addColorStop(1,'#f2f2f0');
    ctx.fillStyle=g; ctx.fillRect(0,0,512,512);
    ctx.strokeStyle='rgba(160,160,155,0.55)'; ctx.lineWidth=1.5;
    for(let y=60;y<512;y+=60){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(512,y);ctx.stroke();}
    ctx.fillStyle='rgba(0,0,0,0.018)';
    for(let i=0;i<300;i++) ctx.fillRect(Math.random()*512,Math.random()*512,1.5,1.5);
    const tex=new THREE.CanvasTexture(c);
    tex.wrapS=THREE.RepeatWrapping; tex.wrapT=THREE.RepeatWrapping;
    tex.repeat.set(tL/12,tW/8); return tex;
  }
  const tentMat=new T.MeshLambertMaterial({color:night?0xdcdcd8:0xffffff,map:makeFabricTex(),side:T.DoubleSide,transparent:true,opacity:night?0.82:0.96});

  // Floor
  const fGeo=new T.PlaneGeometry(tL,tW); fGeo.rotateX(-Math.PI/2);
  const fMesh=new T.Mesh(fGeo,new T.MeshLambertMaterial({color:night?0xc8c0b0:0xf0ece0}));
  fMesh.position.set(cx,0.005,cz); fMesh.receiveShadow=true; _3scene.add(fMesh);

  // Grid
  const gFine=new T.LineBasicMaterial({color:0x0093c7,transparent:true,opacity:0.06});
  const gBold=new T.LineBasicMaterial({color:0x0093c7,transparent:true,opacity:0.14});
  for(let x=0;x<=tL;x++){const p=[new T.Vector3(x,.01,0),new T.Vector3(x,.01,tW)];_3scene.add(new T.Line(new T.BufferGeometry().setFromPoints(p),x%5===0?gBold:gFine));}
  for(let z=0;z<=tW;z++){const p=[new T.Vector3(0,.01,z),new T.Vector3(tL,.01,z)];_3scene.add(new T.Line(new T.BufferGeometry().setFromPoints(p),z%5===0?gBold:gFine));}

  // Hip roof corners & ridge
  const A=new T.Vector3(0,wallH,0),B=new T.Vector3(tL,wallH,0);
  const C=new T.Vector3(tL,wallH,tW),D=new T.Vector3(0,wallH,tW);
  const R1=new T.Vector3(hipBack,ridgeH,tW/2),R2=new T.Vector3(tL-hipBack,ridgeH,tW/2);
  const hasRidge=hipBack<tL/2-0.5;

  function tri(p1,p2,p3,mat){
    const v=new Float32Array([p1.x,p1.y,p1.z,p2.x,p2.y,p2.z,p3.x,p3.y,p3.z]);
    const g=new T.BufferGeometry(); g.setAttribute('position',new T.BufferAttribute(v,3));
    g.computeVertexNormals(); const m=new T.Mesh(g,mat); m.castShadow=true; _3scene.add(m);
  }
  function quad(p1,p2,p3,p4,mat){tri(p1,p2,p3,mat);tri(p1,p3,p4,mat);}

  if(hasRidge){
    quad(A,B,R2,R1,tentMat); quad(D,R1,R2,C,tentMat);
    tri(A,R1,D,tentMat); tri(B,C,R2,tentMat);
    _3scene.add(new T.Line(new T.BufferGeometry().setFromPoints([R1,R2]),new T.LineBasicMaterial({color:0xbbbbbb,transparent:true,opacity:0.6})));
  } else {
    tri(A,B,R1,tentMat);tri(B,C,R1,tentMat);tri(C,D,R1,tentMat);tri(D,A,R1,tentMat);
  }

  const eaveMat=new T.LineBasicMaterial({color:0xcccccc,transparent:true,opacity:0.55});
  [[A,B],[B,C],[C,D],[D,A]].forEach(([p,q])=>_3scene.add(new T.Line(new T.BufferGeometry().setFromPoints([p,q]),eaveMat)));
  if(hasRidge)[[A,R1],[D,R1],[B,R2],[C,R2]].forEach(([p,q])=>_3scene.add(new T.Line(new T.BufferGeometry().setFromPoints([p,q]),eaveMat)));

  // Perimeter legs every 10ft
  const legMat=new T.MeshLambertMaterial({color:0xe8eaec});
  function addLeg(lx,lz){
    const leg=new T.Mesh(new T.CylinderGeometry(0.045,0.05,wallH,10),legMat);
    leg.position.set(lx,wallH/2,lz); leg.castShadow=true; _3scene.add(leg);
    const stakeAmt=1.8; let sx=lx,sz=lz;
    if(Math.abs(lz)<0.1)sz=-stakeAmt; if(Math.abs(lz-tW)<0.1)sz=tW+stakeAmt;
    if(Math.abs(lx)<0.1)sx=-stakeAmt; if(Math.abs(lx-tL)<0.1)sx=tL+stakeAmt;
    _3scene.add(new T.Line(new T.BufferGeometry().setFromPoints([new T.Vector3(lx,wallH*0.85,lz),new T.Vector3(sx,0,sz)]),new T.LineBasicMaterial({color:night?0x606878:0x909aaa,transparent:true,opacity:0.55})));
  }
  for(let x=0;x<=tL+0.01;x+=10)addLeg(Math.min(x,tL),0);
  for(let x=0;x<=tL+0.01;x+=10)addLeg(Math.min(x,tL),tW);
  for(let z=10;z<tW;z+=10)if(tW>15)addLeg(0,z);
  for(let z=10;z<tW;z+=10)if(tW>15)addLeg(tL,z);

  // Eave rails
  const railMat=new T.MeshLambertMaterial({color:0xd8dadc});
  function addRail(x1,z1,x2,z2){
    const len=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(z2-z1,2));
    const rail=new T.Mesh(new T.CylinderGeometry(0.032,0.032,len,8),railMat);
    rail.position.set((x1+x2)/2,wallH,(z1+z2)/2);
    rail.rotation.y=-Math.atan2(z2-z1,x2-x1); rail.rotation.z=Math.PI/2; _3scene.add(rail);
  }
  addRail(0,0,tL,0);addRail(0,tW,tL,tW);addRail(0,0,0,tW);addRail(tL,0,tL,tW);

  // String lights
  const bulbMat=new T.MeshBasicMaterial({color:night?0xffee88:0xffe8aa});
  const bulbGeo=new T.SphereGeometry(0.065,6,6);
  function addStringLights(x1,z1,x2,z2){
    const steps=Math.ceil(Math.sqrt(Math.pow(x2-x1,2)+Math.pow(z2-z1,2))/1.5);
    for(let s=0;s<=steps;s++){
      const t=s/steps,sag=Math.sin(t*Math.PI)*0.25;
      const bulb=new T.Mesh(bulbGeo,bulbMat);
      bulb.position.set(x1+(x2-x1)*t,wallH-0.15-sag,z1+(z2-z1)*t); _3scene.add(bulb);
      if(night){const pl=new T.PointLight(0xffe080,0.12,2.8);pl.position.copy(bulb.position);_3scene.add(pl);}
    }
  }
  addStringLights(0,0,tL,0);addStringLights(0,tW,tL,tW);addStringLights(0,0,0,tW);addStringLights(tL,0,tL,tW);

  if(night){
    const rows=Math.max(1,Math.floor(tL/15)),cols=Math.max(1,Math.floor(tW/12));
    for(let r=0;r<=rows;r++)for(let c=0;c<=cols;c++){
      const pl=new T.PointLight(0xffcc66,1.2,Math.max(tL,tW)*0.8);
      pl.position.set((r+0.5)*(tL/(rows+0)),wallH-1.2,(c+0.5)*(tW/(cols+0)));_3scene.add(pl);
    }
  }
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REALISTIC CHAIR RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _3chairStyle = 'white_folding';

function _3drawChair(T, pos, facingAngle, chairStyle){
  const grp=new T.Group();
  grp.position.set(pos.x,pos.y,pos.z);
  grp.rotation.y=facingAngle;

  let frameCol,seatCol,backCol,cushionCol;
  if(chairStyle==='brown_folding'){
    frameCol=0x6b4c2a;seatCol=0x7a5530;backCol=0x7a5530;cushionCol=null;
  } else if(chairStyle==='chiavari'){
    frameCol=0xd4af6a;seatCol=0xd4af6a;backCol=0xd4af6a;cushionCol=0xf5f0e8;
  } else if(chairStyle==='padded'){
    frameCol=0xd8d8d8;seatCol=0xd8d8d8;backCol=0xd8d8d8;cushionCol=0xf0ece4;
  } else {
    frameCol=0xe8e8e4;seatCol=0xedede9;backCol=0xedede9;cushionCol=null;
  }

  const fMat=new T.MeshLambertMaterial({color:frameCol});
  const sMat=new T.MeshLambertMaterial({color:seatCol});
  const bMat=new T.MeshLambertMaterial({color:backCol});
  const seatW=0.42,seatD=0.40,seatH=0.44,backH=0.38,backThick=0.035,legR=0.012;

  if(chairStyle==='chiavari'){
    const seat=new T.Mesh(new T.BoxGeometry(seatW,0.06,seatD),new T.MeshLambertMaterial({color:cushionCol||0xf5f0e8}));
    seat.position.set(0,seatH,0); grp.add(seat);
    [[-1,-1],[1,-1],[1,1],[-1,1]].forEach(([sx,sz])=>{
      const leg=new T.Mesh(new T.CylinderGeometry(legR*0.7,legR,seatH,6),fMat);
      leg.position.set(sx*(seatW/2-0.04),seatH/2,sz*(seatD/2-0.04)); grp.add(leg);
    });
    for(let i=0;i<5;i++){
      const sp=new T.Mesh(new T.CylinderGeometry(0.008,0.008,backH,6),fMat);
      sp.position.set(-seatW/2+0.05+i*(seatW-0.1)/4,seatH+backH/2,-seatD/2+0.02); grp.add(sp);
    }
    const topRail=new T.Mesh(new T.BoxGeometry(seatW,0.045,0.04),fMat);
    topRail.position.set(0,seatH+backH,-seatD/2+0.02); grp.add(topRail);
  } else {
    const seatMsh=new T.Mesh(new T.BoxGeometry(seatW,0.032,seatD),sMat);
    seatMsh.position.set(0,seatH,0); seatMsh.castShadow=true; grp.add(seatMsh);
    const backMsh=new T.Mesh(new T.BoxGeometry(seatW,backH,backThick),bMat);
    backMsh.position.set(0,seatH+backH/2+0.02,-seatD/2+0.01);
    backMsh.rotation.x=0.09; backMsh.castShadow=true; grp.add(backMsh);
    if(chairStyle==='padded'&&cushionCol){
      const cush=new T.Mesh(new T.BoxGeometry(seatW-0.04,0.055,seatD-0.04),new T.MeshLambertMaterial({color:cushionCol}));
      cush.position.set(0,seatH+0.028,0.01); grp.add(cush);
    }
    [-1,1].forEach(side=>{
      const fl=new T.Mesh(new T.CylinderGeometry(legR,legR*1.1,seatH+0.02,8),fMat);
      fl.position.set(side*(seatW/2-0.06),seatH/2,seatD/2-0.06); fl.rotation.z=side*0.04; grp.add(fl);
      const bl=new T.Mesh(new T.CylinderGeometry(legR,legR*1.1,seatH+0.08,8),fMat);
      bl.position.set(side*(seatW/2-0.06),seatH/2-0.02,-(seatD/2-0.06)); bl.rotation.x=0.1; bl.rotation.z=side*0.04; grp.add(bl);
      // X-brace
      const xb=new T.Mesh(new T.BoxGeometry(0.018,seatH*0.55,0.018),fMat);
      xb.position.set(side*(seatW/2-0.06),seatH*0.38,-(seatD/4)); xb.rotation.x=0.38; grp.add(xb);
      const xb2=new T.Mesh(new T.BoxGeometry(0.018,seatH*0.55,0.018),fMat);
      xb2.position.set(side*(seatW/2-0.06),seatH*0.38,-(seatD/4)); xb2.rotation.x=-0.38; grp.add(xb2);
      const rail=new T.Mesh(new T.CylinderGeometry(legR*0.85,legR*0.85,seatD*0.72,8),fMat);
      rail.rotation.x=Math.PI/2; rail.position.set(side*(seatW/2-0.06),seatH-0.08,0); grp.add(rail);
    });
  }
  grp.castShadow=true; _3scene.add(grp);
}

function _3makeTex(label,bg,fg,round){
  const c=document.createElement('canvas'); c.width=256; c.height=round?256:128;
  const ctx=c.getContext('2d');
  ctx.fillStyle=bg; ctx.fillRect(0,0,c.width,c.height);
  if(round){ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.lineWidth=10;ctx.beginPath();ctx.arc(128,128,110,0,Math.PI*2);ctx.stroke();}
  ctx.fillStyle=fg||'rgba(0,0,0,0.7)';
  ctx.font='bold 72px sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(label,c.width/2,c.height/2);
  return new THREE.CanvasTexture(c);
}

function _3buildFurniture(T,night){
  const tH=0.28, chH=0.34;
  const tn=getTableNums();

  items.forEach(item=>{
    const d=defOf(item.type); if(!d)return;
    const cx=item.x+item.w/2, cz=item.y+item.h/2;
    const num=tn[item.id];
    const rot=((item.rot||0)*Math.PI)/180;

    if(d.shape==='circle'){
      const r=item.w/2;
      // Table surface layers: side, top, bottom
      const tex=_3makeTex(num?'T'+num:d.lbl,d.bg,d.fg,true);
      const mats=[
        new T.MeshLambertMaterial({color:new T.Color(d.bg)}),
        new T.MeshLambertMaterial({map:tex}),
        new T.MeshLambertMaterial({color:new T.Color(d.bg)}),
      ];
      const table=new T.Mesh(new T.CylinderGeometry(r,r,tH,36),mats);
      table.position.set(cx,tH/2,cz); table.castShadow=true; _3scene.add(table);

      // Table leg
      const leg=new T.Mesh(new T.CylinderGeometry(0.06,0.08,tH*2,8),new T.MeshLambertMaterial({color:0xccbba0}));
      leg.position.set(cx,-tH*0.5,cz); _3scene.add(leg);

      // Chairs
      const cMat=new T.MeshLambertMaterial({color:new T.Color(d.chairBg||d.bd)});
      const seatR=item.w/2+0.52;
      for(let i=0;i<d.seats;i++){
        const a=(i/d.seats)*Math.PI*2-Math.PI/2;
        const sx=cx+seatR*Math.cos(a), sz=cz+seatR*Math.sin(a);
        // Seat
        const seat=new T.Mesh(new T.CylinderGeometry(0.2,0.2,chH,10),cMat);
        seat.position.set(sx,chH/2,sz); seat.castShadow=true; _3scene.add(seat);
        // Back
        const back=new T.Mesh(new T.BoxGeometry(0.38,chH*0.72,0.06),cMat);
        back.position.set(cx+(seatR+0.16)*Math.cos(a),chH+0.16,cz+(seatR+0.16)*Math.sin(a));
        back.rotation.y=a; _3scene.add(back);
      }

    } else if(d.shape==='rect' && d.type!=='door'){
      const tw=item.w, td=item.h;
      const isEvent=d.seats===0;
      const itemH = d.type==='stage'?1.3 : d.type==='bar'?1.05 : d.type==='dj'?0.85 : d.type==='buffet'?0.9 : tH;
      const col=new T.Color(d.bg);

      let mat;
      if(d.seats>0){
        const tex=_3makeTex(num?'T'+num:d.lbl,d.bg,d.fg,false);
        mat=[col,col,tex,col,col,col].map((v,i)=>i===2?new T.MeshLambertMaterial({map:v}):new T.MeshLambertMaterial({color:v}));
      } else {
        mat=new T.MeshLambertMaterial({color:col});
      }

      const mesh=new T.Mesh(new T.BoxGeometry(tw,itemH,td),mat);
      mesh.position.set(cx,itemH/2,cz); mesh.rotation.y=rot;
      mesh.castShadow=true; mesh.receiveShadow=true; _3scene.add(mesh);

      // Label sign for event items
      if(isEvent && d.type!=='stage'){
        const sCanvas=document.createElement('canvas'); sCanvas.width=256;sCanvas.height=64;
        const sCtx=sCanvas.getContext('2d');
        sCtx.fillStyle='rgba(0,0,0,0)';sCtx.fillRect(0,0,256,64);
        sCtx.fillStyle='rgba(255,255,255,0.9)';sCtx.font='bold 36px sans-serif';sCtx.textAlign='center';sCtx.textBaseline='middle';
        sCtx.fillText(d.lbl,128,32);
        const sTex=new T.CanvasTexture(sCanvas);
        const sign=new T.Mesh(new T.PlaneGeometry(tw*0.7,0.4),new T.MeshBasicMaterial({map:sTex,transparent:true,side:T.DoubleSide}));
        sign.position.set(cx,itemH+0.22,cz); sign.rotation.y=rot; _3scene.add(sign);
      }

      // Banquet table chairs
      if(d.seats>0){
        const cMat=new T.MeshLambertMaterial({color:new T.Color(d.chairBg||d.bd)});
        const spp=Math.floor(d.seats/2);
        for(let i=0;i<spp;i++){
          const t2=(i+1)/(spp+1)-0.5;
          [-1,1].forEach(side=>{
            const lx=t2*tw, lz=side*(td/2+0.5);
            const wx=cx+lx*Math.cos(rot)-lz*Math.sin(rot);
            const wz=cz+lx*Math.sin(rot)+lz*Math.cos(rot);
            const seat=new T.Mesh(new T.CylinderGeometry(0.18,0.18,chH,10),cMat);
            seat.position.set(wx,chH/2,wz); seat.castShadow=true; _3scene.add(seat);
            const blz=side*(td/2+0.62);
            const bx=cx+lx*Math.cos(rot)-blz*Math.sin(rot);
            const bz=cz+lx*Math.sin(rot)+blz*Math.cos(rot);
            const back=new T.Mesh(new T.BoxGeometry(0.34,chH*0.7,0.05),cMat);
            back.position.set(bx,chH+0.14,bz); back.rotation.y=-rot; _3scene.add(back);
          });
        }
      }

    } else if(d.shape==='check'){
      // Checkered dance floor
      const m1=new T.MeshLambertMaterial({color:night?0x102838:0xe0f2fc});
      const m2=new T.MeshLambertMaterial({color:night?0x1a3a4a:0xb8d8ed});
      for(let xi=0;xi<item.w;xi++){
        for(let zi=0;zi<item.h;zi++){
          const tile=new T.Mesh(new T.BoxGeometry(1,0.06,1),(xi+zi)%2===0?m1:m2);
          tile.position.set(item.x+xi+0.5,0.03,item.y+zi+0.5);
          tile.receiveShadow=true; _3scene.add(tile);
        }
      }
      if(night){
        // Glow under dance floor
        const glowMat=new T.MeshBasicMaterial({color:0x0060a0,transparent:true,opacity:0.25});
        const glow=new T.Mesh(new T.PlaneGeometry(item.w+1,item.h+1).applyMatrix4(new T.Matrix4().makeRotationX(-Math.PI/2)),glowMat);
        glow.position.set(cx,0.001,cz); _3scene.add(glow);
      }

    } else if(d.shape==='pole'){
      const p=new T.Mesh(new T.CylinderGeometry(0.12,0.15,3.5,10),new T.MeshLambertMaterial({color:0x9ca3af}));
      p.position.set(cx,1.75,cz); p.castShadow=true; _3scene.add(p);

    } else if(d.shape==='chairrow'){
      const count=d.chairCount||d.seats||8;
      const spacing=item.w/count;
      for(let i=0;i<count;i++){
        const offset=(i+0.5)*spacing-item.w/2;
        _3drawChair(T,{x:cx+offset*Math.cos(rot),y:0,z:cz+offset*Math.sin(rot)},rot+Math.PI/2,_3chairStyle);
      }
    } else if(d.shape==='door'){
      const arrow=new T.Mesh(new T.BoxGeometry(item.w,0.06,0.35),new T.MeshLambertMaterial({color:0x0093c7}));
      arrow.position.set(cx,0.03,cz); _3scene.add(arrow);
    }
  });
}


function _3buildCeremonyRows(T){
  const stages=items.filter(i=>i.type==='stage');if(!stages.length)return;
  const stage=stages[0],stageCX=stage.x+stage.w/2,stageCZ=stage.y+stage.h/2;
  const spaceBelow=tentW-(stage.y+stage.h),spaceAbove=stage.y;
  const useBelow=spaceBelow>=spaceAbove;
  const startZ=useBelow?stage.y+stage.h+1.2:stage.y-1.2;
  const faceAngle=useBelow?Math.PI:0;
  const rowDepth=2.6,chairGap=0.55,aisleW=2.4,chairW=0.48;
  const availDepth=useBelow?spaceBelow-1.5:spaceAbove-1.5;
  const numRows=Math.max(1,Math.floor(availDepth/rowDepth));
  const halfW=(tentL-2-aisleW)/2;
  const chaiarsPerSide=Math.max(1,Math.floor(halfW/(chairW+chairGap)));
  for(let row=0;row<numRows;row++){
    const rowZ=useBelow?startZ+row*rowDepth:startZ-row*rowDepth;
    if(rowZ<0.3||rowZ>tentW-0.3)continue;
    for(let c=0;c<chaiarsPerSide;c++){
      const xl=tentL/2-aisleW/2-(chairW+chairGap)*(c+0.5);
      const xr=tentL/2+aisleW/2+(chairW+chairGap)*(c+0.5);
      if(xl>0.3)_3drawChair(T,{x:xl,y:0,z:rowZ},faceAngle,_3chairStyle);
      if(xr<tentL-0.3)_3drawChair(T,{x:xr,y:0,z:rowZ},faceAngle,_3chairStyle);
    }
  }
  const runnerLen=numRows*rowDepth+1.5;
  const runnerGeo=new T.PlaneGeometry(aisleW-0.3,runnerLen);runnerGeo.rotateX(-Math.PI/2);
  const runner=new T.Mesh(runnerGeo,new T.MeshLambertMaterial({color:_3o.night?0x1a3050:0xdde8f5,transparent:true,opacity:0.7}));
  runner.position.set(tentL/2,0.01,useBelow?startZ+runnerLen/2-rowDepth*0.5:startZ-runnerLen/2+rowDepth*0.5);
  _3scene.add(runner);
}

function _3setupControls(el){
  el.addEventListener('mousedown',e=>{_3o.dragging=true;_3o.btn=e.button;_3o.lx=e.clientX;_3o.ly=e.clientY;e.preventDefault();});
  el.addEventListener('contextmenu',e=>e.preventDefault());
  window.addEventListener('mousemove',e=>{
    if(!_3o.dragging)return;
    const dx=e.clientX-_3o.lx, dy=e.clientY-_3o.ly;
    _3o.lx=e.clientX; _3o.ly=e.clientY;
    if(_3o.btn===0){ // orbit
      _3o.theta-=dx*0.006;
      _3o.phi=Math.max(0.12,Math.min(Math.PI/2-0.04,_3o.phi-dy*0.005));
    } else if(_3o.btn===2){ // pan
      const spd=_3o.r*0.0012;
      const right=new THREE.Vector3(-Math.cos(_3o.theta),0,Math.sin(_3o.theta));
      const fwd=new THREE.Vector3(-Math.sin(_3o.theta)*Math.cos(_3o.phi),0,-Math.cos(_3o.theta)*Math.cos(_3o.phi));
      _3o.tx+=right.x*dx*spd - fwd.x*dy*spd;
      _3o.tz+=right.z*dx*spd - fwd.z*dy*spd;
    }
    _3updateCam();
  });
  window.addEventListener('mouseup',()=>{_3o.dragging=false;});
  el.addEventListener('wheel',e=>{
    _3o.r=Math.max(3,Math.min(250,_3o.r+e.deltaY*0.06));
    _3updateCam(); e.preventDefault();
  },{passive:false});
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT LAYOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function exportLayout() {
  _sceneSaveCurrent(); // ensure active scene is up to date
  const name = document.getElementById('cname').value.trim()
             || document.getElementById('ev-client').value.trim()
             || 'layout';

  const payload = {
    _version: 3,
    _app: 'Peak Party Rentals Floor Planner',
    _exported: new Date().toISOString(),
    // Legacy single-tent fields (backward compat)
    tentW, tentL,
    items: JSON.parse(JSON.stringify(items)),
    nid,
    // Multi-scene data
    scenes: JSON.parse(JSON.stringify(scenes)),
    fieldElements: JSON.parse(JSON.stringify(fieldElements)),
    activeSceneIdx,
    event: {
      client:  document.getElementById('ev-client').value.trim(),
      type:    document.getElementById('ev-type').value,
      date:    document.getElementById('ev-date').value,
      venue:   document.getElementById('ev-venue').value.trim(),
      guests:  document.getElementById('ev-guests') ? document.getElementById('ev-guests').value.trim() : '',
      note:    document.getElementById('ev-note').value.trim(),
    },
    upsells: UPSELLS
      .filter(u => document.getElementById('uchk-'+u.id)?.checked)
      .map(u => u.id),
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const safe = name.replace(/[^a-z0-9_\- ]/gi,'').trim().replace(/\s+/g,'-') || 'layout';
  a.href     = url;
  a.download = `PPR-${safe}-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Festival layout exported: ' + a.download);
}

function importLayout(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);

      // Validate it's a PPR layout file
      if (!data._app || !data._app.includes('Peak Party')) {
        toast('‚ö†Ô∏è Not a valid Peak Party layout file'); return;
      }
      if (!data.items || !Array.isArray(data.items)) {
        toast('‚ö†Ô∏è Layout file appears corrupted'); return;
      }

      // Confirm if canvas has items
      if (items.length > 0) {
        if (!confirm(`Import "${data.event?.client || file.name}"?

This will replace your current canvas.`)) {
          event.target.value = ''; return;
        }
      }

      // Load everything
      pushUndo();

      // Multi-scene restore (v3+)
      if (data.scenes && Array.isArray(data.scenes) && data.scenes.length > 0) {
        scenes = data.scenes;
        fieldElements = data.fieldElements || [];
        fieldNid = Math.max(fieldNid, ...fieldElements.map(e=>e.id||0)) + 1;
        const idx = Math.min(data.activeSceneIdx||0, scenes.length-1);
        // activateScene will set tentL/tentW/items etc
        activateScene(idx);
      } else {
        // Legacy v2 single-tent
        tentW = data.tentW || 30;
        tentL = data.tentL || 60;
        items = data.items;
        nid   = data.nid || items.length + 1;
        scenes[0] = Object.assign(scenes[0]||{}, {tentW,tentL,items:JSON.parse(JSON.stringify(items)),nid});
      }

      document.getElementById('tw').value = tentW;
      document.getElementById('tl').value = tentL;
      const k = tentW+','+tentL;
      const ps = document.getElementById('preset');
      ps.value = [...ps.options].some(o => o.value===k) ? k : '';

      // Restore event fields
      if (data.event) {
        if (data.event.client) document.getElementById('ev-client').value = data.event.client;
        if (data.event.type)   document.getElementById('ev-type').value   = data.event.type;
        if (data.event.date)   document.getElementById('ev-date').value   = data.event.date;
        if (data.event.venue)  document.getElementById('ev-venue').value  = data.event.venue;
        if (data.event.note)   document.getElementById('ev-note').value   = data.event.note;
        if (data.event.guests && document.getElementById('ev-guests'))
          document.getElementById('ev-guests').value = data.event.guests;
      }

      // Restore upsell checkboxes
      if (data.upsells && Array.isArray(data.upsells)) {
        UPSELLS.forEach(u => {
          const chk = document.getElementById('uchk-'+u.id);
          const el  = document.getElementById('upsell-'+u.id);
          if (chk) {
            chk.checked = data.upsells.includes(u.id);
            if (el) el.classList.toggle('checked', chk.checked);
          }
        });
      }

      selIds.clear(); history = []; future = [];
      applyTent(); fitView(); refreshEvent();

      const exportedDate = data._exported
        ? new Date(data._exported).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})
        : '';
      toast(`Loaded: ${data.event?.client || file.name}${exportedDate ? ' ¬∑ exported '+exportedDate : ''}`);

    } catch(err) {
      console.error(err);
      toast('‚ö†Ô∏è Could not read file ‚Äî is it a valid .json?');
    }
    event.target.value = ''; // reset so same file can be re-imported
  };
  reader.readAsText(file);
}

// Drag-and-drop import onto the whole canvas
(function setupDropImport(){
  const ca = document.getElementById('canvas-area');
  ca.addEventListener('dragover', e => {
    if([...e.dataTransfer.items].some(i=>i.type==='application/json'||i.name?.endsWith('.json'))){
      e.preventDefault(); ca.style.outline='2px dashed #0093c7';
    }
  });
  ca.addEventListener('dragleave', () => { ca.style.outline=''; });
  ca.addEventListener('drop', e => {
    e.preventDefault(); ca.style.outline='';
    const file = [...e.dataTransfer.files].find(f=>f.name.endsWith('.json'));
    if (file) importLayout({target:{files:[file],value:''}});
  });
})();




function toggleViewMenu(){
  const m=document.getElementById('view-menu');
  const isOpen=m.style.display!=='none';
  m.style.display=isOpen?'none':'block';
  if(!isOpen) setTimeout(()=>document.addEventListener('click',_closeViewOnOutside,{once:true}),10);
}
function closeViewMenu(){document.getElementById('view-menu').style.display='none';}
function _closeViewOnOutside(e){
  const m=document.getElementById('view-menu');
  const btn=document.getElementById('btn-view-toggle');
  if(m&&!m.contains(e.target)&&e.target!==btn)closeViewMenu();
}

function toggleAlignMenu(){
  const m=document.getElementById('align-menu');
  const isOpen=m.style.display!=='none';
  m.style.display=isOpen?'none':'block';
  if(!isOpen){
    // Close when clicking outside
    setTimeout(()=>document.addEventListener('click',_closeAlignOnOutside,{once:true}),10);
  }
}
function closeAlignMenu(){document.getElementById('align-menu').style.display='none';}
function _closeAlignOnOutside(e){
  const m=document.getElementById('align-menu');
  const btn=document.getElementById('btn-align-toggle');
  if(m&&!m.contains(e.target)&&e.target!==btn)closeAlignMenu();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIELD VIEW ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const FIELD_FT_PX = 2;          // base pixels per foot at zoom=1
let fieldSelId = null;           // selected element id in field view
let fieldCurrentTool = 'select';
let _pendingRoad = null;         // road being drawn (pre-label)

function setFieldTool(t) {
  fieldCurrentTool = t;
  document.querySelectorAll('.ftb-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('ftb-' + t);
  if (btn) btn.classList.add('active');
  document.getElementById('field-cvs').style.cursor = t === 'road' ? 'crosshair' : 'default';
}


function zoomToScene(idx) {
  const s = scenes[idx];
  if (!s) return;
  const wrap = document.getElementById('field-canvas-wrap');
  const W = wrap.clientWidth, H = wrap.clientHeight;
  const pad = 60;
  const targetZoom = Math.min(20, Math.max(0.5,
    Math.min((W - pad*2) / (s.tentL * FIELD_FT_PX),
             (H - pad*2) / (s.tentW * FIELD_FT_PX))
  ));
  const targetPanX = (W - s.tentL * FIELD_FT_PX * targetZoom) / 2 - s.fieldX * FIELD_FT_PX * targetZoom;
  const targetPanY = (H - s.tentW * FIELD_FT_PX * targetZoom) / 2 - s.fieldY * FIELD_FT_PX * targetZoom;

  // Animate smoothly
  const startZoom = fieldZoom, startPX = fieldPanX, startPY = fieldPanY;
  const startTime = performance.now();
  const dur = 380;
  function ease(t) { return t < 0.5 ? 2*t*t : -1+(4-2*t)*t; }
  function step(now) {
    const t = Math.min(1, (now - startTime) / dur);
    const e = ease(t);
    fieldZoom = startZoom + (targetZoom - startZoom) * e;
    fieldPanX = startPX  + (targetPanX  - startPX)  * e;
    fieldPanY = startPY  + (targetPanY  - startPY)  * e;
    renderFieldView();
    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}


function _fieldZoomStep(dir) {
  const steps = [0.1,0.15,0.2,0.25,0.33,0.5,0.67,0.75,1,1.25,1.5,2,2.5,3,4,5,6,8,10,15,20];
  let i = steps.findIndex(s => Math.abs(s - fieldZoom) < s*0.05);
  if (i < 0) i = steps.findIndex(s => s > fieldZoom) - 1;
  const ni = Math.max(0, Math.min(steps.length-1, i + dir));
  const wrap = document.getElementById('field-canvas-wrap');
  const cx = wrap.clientWidth/2, cy = wrap.clientHeight/2;
  const fxPin = pxToFt(cx, fieldPanX), fyPin = pxToFt(cy, fieldPanY);
  fieldZoom = steps[ni];
  fieldPanX = cx - fxPin * FIELD_FT_PX * fieldZoom;
  fieldPanY = cy - fyPin * FIELD_FT_PX * fieldZoom;
  renderFieldView();
}

function fieldFit() {
  if (!scenes.length) return;
  const wrap = document.getElementById('field-canvas-wrap');
  const W = wrap.clientWidth, H = wrap.clientHeight;
  // Find bounding box of all tents
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  scenes.forEach(s => {
    minX = Math.min(minX, s.fieldX);
    minY = Math.min(minY, s.fieldY);
    maxX = Math.max(maxX, s.fieldX + s.tentL);
    maxY = Math.max(maxY, s.fieldY + s.tentW);
  });
  fieldElements.forEach(e => {
    minX = Math.min(minX, e.x); minY = Math.min(minY, e.y);
    maxX = Math.max(maxX, e.x+e.w); maxY = Math.max(maxY, e.y+e.h);
  });
  const pad = 60;
  const fw = maxX-minX, fh = maxY-minY;
  fieldZoom = Math.min(20, Math.max(0.1, Math.min((W-pad*2)/(fw*FIELD_FT_PX), (H-pad*2)/(fh*FIELD_FT_PX))));
  fieldPanX = (W - fw*FIELD_FT_PX*fieldZoom)/2 - minX*FIELD_FT_PX*fieldZoom;
  fieldPanY = (H - fh*FIELD_FT_PX*fieldZoom)/2 - minY*FIELD_FT_PX*fieldZoom;
  renderFieldView();
}

function ftW(ft) { return ft * FIELD_FT_PX * fieldZoom; }
function ftX(ft) { return fieldPanX + ft * FIELD_FT_PX * fieldZoom; }
function ftY(ft) { return fieldPanY + ft * FIELD_FT_PX * fieldZoom; }
function pxToFt(px, pan) { return (px - pan) / (FIELD_FT_PX * fieldZoom); }

function renderFieldView() {
  const wrap = document.getElementById('field-canvas-wrap');
  const cvs  = document.getElementById('field-cvs');
  if (!cvs) return;
  const W = wrap.clientWidth, H = wrap.clientHeight;
  cvs.width = W; cvs.height = H;
  const ctx = cvs.getContext('2d');

  // ‚îÄ‚îÄ Background: grassy field ‚îÄ‚îÄ
  ctx.fillStyle = '#2a3520';
  ctx.fillRect(0, 0, W, H);

  // ‚îÄ‚îÄ Grid (every 10 ft) ‚îÄ‚îÄ
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  const gridFt = fieldZoom > 1 ? 10 : (fieldZoom > 0.4 ? 25 : 50);
  const startX = Math.floor(pxToFt(0, fieldPanX)/gridFt)*gridFt;
  const startY = Math.floor(pxToFt(0, fieldPanY)/gridFt)*gridFt;
  for (let x = startX; ftX(x) < W+1; x += gridFt) {
    ctx.beginPath(); ctx.moveTo(ftX(x), 0); ctx.lineTo(ftX(x), H); ctx.stroke();
  }
  for (let y = startY; ftY(y) < H+1; y += gridFt) {
    ctx.beginPath(); ctx.moveTo(0, ftY(y)); ctx.lineTo(W, ftY(y)); ctx.stroke();
  }

  // ‚îÄ‚îÄ Roads ‚îÄ‚îÄ
  fieldElements.filter(e => e.type === 'road').forEach(road => {
    const rx = ftX(road.x), ry = ftY(road.y);
    const rw = ftW(road.w), rh = ftW(road.h);
    ctx.save();
    if (road.rot) {
      ctx.translate(rx+rw/2, ry+rh/2);
      ctx.rotate(road.rot * Math.PI/180);
      ctx.translate(-rw/2, -rh/2);
    } else {
      ctx.translate(rx, ry);
    }
    // Road fill
    ctx.fillStyle = road.id === fieldSelId ? '#9aacba' : '#708090';
    ctx.fillRect(0, 0, rw, rh);
    // Center line dashes
    if (rw > 40) {
      ctx.strokeStyle = '#f5e050';
      ctx.lineWidth = Math.max(1, ftW(0.5));
      ctx.setLineDash([ftW(8), ftW(6)]);
      ctx.beginPath();
      ctx.moveTo(0, rh/2); ctx.lineTo(rw, rh/2);
      ctx.stroke(); ctx.setLineDash([]);
    }
    // Edge lines
    ctx.strokeStyle = '#aab5bd';
    ctx.lineWidth = 1;
    ctx.strokeRect(0, 0, rw, rh);
    // Selection outline
    if (road.id === fieldSelId) {
      ctx.strokeStyle = '#41b8ea';
      ctx.lineWidth = 2;
      ctx.strokeRect(-2, -2, rw+4, rh+4);
    }
    // Label
    if (road.label) {
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.font = `bold ${Math.max(9, ftW(4))}px DM Sans, sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(road.label, rw/2, rh/2);
    }
    ctx.restore();
  });

  // ‚îÄ‚îÄ Tents ‚îÄ‚îÄ
  scenes.forEach((s, i) => {
    const tx = ftX(s.fieldX), ty = ftY(s.fieldY);
    const tw = ftW(s.tentL), th = ftW(s.tentW);
    const isSel = s.id === fieldSelId;
    // px per foot inside this tent at current field zoom
    const pxpft = FIELD_FT_PX * fieldZoom;
    const detailThreshold = 2; // show furniture when >= 2px per foot

    // Tent shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(tx+4, ty+4, tw, th);

    // Tent floor
    ctx.fillStyle = isSel ? '#e8f4fa' : '#f4f4f0';
    ctx.fillRect(tx, ty, tw, th);

    // ‚îÄ‚îÄ Interior furniture detail (zoom-dependent) ‚îÄ‚îÄ
    if (pxpft >= detailThreshold && s.items && s.items.length > 0) {
      ctx.save();
      ctx.beginPath(); ctx.rect(tx, ty, tw, th); ctx.clip(); // clip to tent

      s.items.forEach(item => {
        const d = defOf(item.type); if (!d) return;
        const ix = tx + item.x * pxpft;
        const iy = ty + item.y * pxpft;
        const iw = item.w * pxpft;
        const ih = item.h * pxpft;
        const rot = (item.rot || 0) * Math.PI / 180;

        ctx.save();
        ctx.translate(ix + iw/2, iy + ih/2);
        ctx.rotate(rot);

        if (d.shape === 'circle') {
          const r = iw / 2;
          ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2);
          ctx.fillStyle = d.bg; ctx.fill();
          ctx.strokeStyle = d.bd; ctx.lineWidth = Math.max(0.5, pxpft*0.06); ctx.stroke();
          // Chair dots around table
          if (pxpft >= 5 && d.seats > 0) {
            const seatR = r + Math.max(2, pxpft * 0.45);
            const dotR = Math.max(1.5, pxpft * 0.22);
            ctx.fillStyle = d.chairBg || d.bd;
            for (let j = 0; j < d.seats; j++) {
              const a = (j/d.seats)*Math.PI*2 - Math.PI/2;
              ctx.beginPath();
              ctx.arc(seatR*Math.cos(a), seatR*Math.sin(a), dotR, 0, Math.PI*2);
              ctx.fill();
            }
          }
          // Label
          if (pxpft >= 6) {
            ctx.fillStyle = d.fg; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.font = `bold ${Math.max(5, r*0.55)}px DM Sans,sans-serif`;
            ctx.fillText(d.lbl, 0, 0);
          }
        } else if (d.shape === 'chairrow') {
          // Row of seat dots
          const count = d.chairCount || d.seats || 8;
          const dotW = iw / count * 0.72;
          const dotH = ih * 0.7;
          ctx.fillStyle = d.bg; ctx.strokeStyle = d.bd;
          ctx.lineWidth = Math.max(0.3, pxpft*0.04);
          for (let j = 0; j < count; j++) {
            const dx = -iw/2 + (j + 0.5) * (iw/count);
            ctx.fillRect(dx - dotW/2, -dotH/2, dotW, dotH);
            ctx.strokeRect(dx - dotW/2, -dotH/2, dotW, dotH);
          }
        } else {
          // Rectangle items (tables, stage, bar, etc.)
          ctx.fillStyle = d.bg;
          ctx.strokeStyle = d.bd;
          ctx.lineWidth = Math.max(0.5, pxpft*0.06);
          const r2 = d.shape === 'door' ? 1 : 2;
          ctx.beginPath();
          if(ctx.roundRect) ctx.roundRect(-iw/2,-ih/2,iw,ih,r2); else ctx.rect(-iw/2,-ih/2,iw,ih);
          ctx.fill(); ctx.stroke();
          // Label inside rect
          if (pxpft >= 5 && iw > 8) {
            ctx.fillStyle = d.fg; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.font = `bold ${Math.max(4, Math.min(iw*0.28, ih*0.55))}px DM Sans,sans-serif`;
            ctx.fillText(d.lbl, 0, 0);
          }
        }
        ctx.restore();
      });
      ctx.restore(); // remove clip
    }

    // Tent roof / outline overlay (drawn on top of furniture)
    ctx.strokeStyle = isSel ? '#0093c7' : '#888';
    ctx.lineWidth = isSel ? 2 : 1;
    ctx.strokeRect(tx, ty, tw, th);

    // Hip roof lines (only when zoomed out ‚Äî they'd overlap furniture at high zoom)
    if (pxpft < detailThreshold) {
      ctx.strokeStyle = 'rgba(100,100,100,0.3)';
      ctx.lineWidth = 0.5;
      const hipD = Math.min(tw,th)*0.18;
      ctx.beginPath();
      ctx.moveTo(tx+hipD, ty); ctx.lineTo(tx+tw/2, ty+th*0.12);
      ctx.moveTo(tx+tw-hipD, ty); ctx.lineTo(tx+tw/2, ty+th*0.12);
      ctx.moveTo(tx+hipD, ty+th); ctx.lineTo(tx+tw/2, ty+th*0.88);
      ctx.moveTo(tx+tw-hipD, ty+th); ctx.lineTo(tx+tw/2, ty+th*0.88);
      ctx.moveTo(tx, ty+hipD*0.5); ctx.lineTo(tx+tw/2, ty+th*0.12);
      ctx.moveTo(tx+tw, ty+hipD*0.5); ctx.lineTo(tx+tw/2, ty+th*0.12);
      ctx.stroke();
    }

    // Selection highlight
    if (isSel) {
      ctx.strokeStyle = '#0093c7';
      ctx.lineWidth = 2.5;
      ctx.strokeRect(tx-2, ty-2, tw+4, th+4);
    }

    // Tent name label ‚Äî hide when zoomed in enough to see items
    if (pxpft < 12) {
      const fontSize = Math.max(9, Math.min(16, ftW(4)));
      ctx.fillStyle = pxpft >= detailThreshold ? 'rgba(48,57,61,0.55)' : '#30393d';
      ctx.font = `bold ${fontSize}px DM Sans, sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(s.name, tx + tw/2, ty + th/2 - fontSize*0.3);
      ctx.font = `${Math.max(7, fontSize*0.7)}px DM Sans, sans-serif`;
      ctx.fillStyle = '#5a7a88';
      ctx.fillText(s.tentW+'√ó'+s.tentL+' ft', tx + tw/2, ty + th/2 + fontSize*0.5);
    } else {
      // Zoomed in: show name in top bar of tent
      const fontSize = Math.max(8, Math.min(13, ftW(3)));
      ctx.fillStyle = 'rgba(0,147,199,0.85)';
      ctx.fillRect(tx, ty, tw, fontSize + 6);
      ctx.fillStyle = '#fff';
      ctx.font = `bold ${fontSize}px DM Sans,sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(s.name + '  ' + s.tentW+'√ó'+s.tentL+' ft', tx+tw/2, ty+fontSize/2+3);
    }

    // Seat count badge (only when zoomed out)
    if (pxpft < detailThreshold) {
      const totalSeats = s.items.reduce((acc, it) => {
        const d = defOf(it.type); return acc + (d ? d.seats : 0);
      }, 0);
      if (totalSeats > 0 && tw > 40) {
        ctx.fillStyle = 'rgba(0,147,199,0.85)';
        const bw = Math.max(ftW(12), 36), bh = ftW(5);
        const bx = tx+tw/2-bw/2, by = ty+th-bh-4;
        ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(bx, by, bw, bh, 3); else ctx.rect(bx, by, bw, bh);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.font = `bold ${Math.max(7, ftW(2.8))}px DM Sans, sans-serif`;
        ctx.fillText('üë• '+totalSeats+' seats', tx+tw/2, by+bh/2);
      }
    }

    // Double-click hint on selected tent (only when zoomed out)
    if (isSel && tw > 50 && pxpft < 6) {
      ctx.fillStyle = 'rgba(0,147,199,0.9)';
      const hw = ftW(20), hh = ftW(5);
      const hx = tx+tw/2-hw/2, hy = ty-hh-6;
      ctx.beginPath();
      if(ctx.roundRect) ctx.roundRect(hx,hy,hw,hh,3); else ctx.rect(hx,hy,hw,hh);
      ctx.fill();
      ctx.fillStyle='#fff'; ctx.font=`bold ${Math.max(7,ftW(2.8))}px DM Sans,sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('Double-click to edit', tx+tw/2, hy+hh/2);
    }
  });

  // ‚îÄ‚îÄ Preview road being drawn ‚îÄ‚îÄ
  if (fieldDrawingRoad) {
    const d = fieldDrawingRoad;
    ctx.strokeStyle = '#41b8ea';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,4]);
    ctx.fillStyle = 'rgba(112,128,144,0.4)';
    ctx.fillRect(d.x, d.y, d.w, d.h);
    ctx.strokeRect(d.x, d.y, d.w, d.h);
    ctx.setLineDash([]);
  }

  // ‚îÄ‚îÄ Scale bar ‚îÄ‚îÄ
  const scaleBarFt = fieldZoom > 1.5 ? 50 : (fieldZoom > 0.6 ? 100 : 200);
  const scaleBarPx = ftW(scaleBarFt);
  const scaleEl = document.getElementById('field-scale-line');
  const scaleLbl = document.getElementById('field-scale-label');
  if (scaleEl) scaleEl.style.width = scaleBarPx + 'px';
  if (scaleLbl) scaleLbl.textContent = scaleBarFt + ' ft';
}

// ‚îÄ‚îÄ Field view mouse events ‚îÄ‚îÄ
function setupFieldView() {
  const cvs = document.getElementById('field-cvs');
  if (!cvs) return;

  let _fp = {             // field pointer state
    panActive: false,       // panning via middle-mouse or space+drag
    spaceDown: false,
    tentDrag: null,         // {id, ox, oy}
    roadDrag: null,         // {id, ox, oy}
    drawingRoad: false,
    drawStart: {x:0, y:0},
    panStart: {mx:0, my:0, px:0, py:0},
    moved: false,           // did mouse actually move since mousedown?
    downX: 0, downY: 0
  };

  // ‚îÄ‚îÄ Scroll to zoom (toward cursor, like main canvas) ‚îÄ‚îÄ
  cvs.addEventListener('wheel', e => {
    e.preventDefault();
    const rect = cvs.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    // Pin the world point under the cursor
    const fxPin = pxToFt(mx, fieldPanX), fyPin = pxToFt(my, fieldPanY);
    const factor = e.deltaY < 0 ? 1.12 : (1/1.12);
    fieldZoom = Math.max(0.1, Math.min(20, fieldZoom * factor));
    fieldPanX = mx - fxPin * FIELD_FT_PX * fieldZoom;
    fieldPanY = my - fyPin * FIELD_FT_PX * fieldZoom;
    renderFieldView();
  }, {passive:false});

  // ‚îÄ‚îÄ Space bar = temporary pan mode (like main canvas alt-drag) ‚îÄ‚îÄ
  document.addEventListener('keydown', e => {
    if (!isFieldView) return;
    if (e.code === 'Space' && !e.repeat) { _fp.spaceDown = true; cvs.style.cursor = 'grab'; }
    // +/- keys to zoom
    if (e.key === '+' || e.key === '=') _fieldZoomStep(1);
    if (e.key === '-' || e.key === '_') _fieldZoomStep(-1);
    if (e.key === '0') fieldFit();
  });
  document.addEventListener('keyup', e => {
    if (!isFieldView) return;
    if (e.code === 'Space') { _fp.spaceDown = false; cvs.style.cursor = fieldCurrentTool==='road'?'crosshair':'default'; }
  });

  cvs.addEventListener('dblclick', e => {
    const rect = cvs.getBoundingClientRect();
    const fx = pxToFt(e.clientX-rect.left, fieldPanX);
    const fy = pxToFt(e.clientY-rect.top, fieldPanY);
    const hit = _fieldHitTest(fx, fy);
    if (hit && hit.type === 'tent') {
      const idx = scenes.findIndex(s => s.id === hit.id);
      const s = scenes[idx];
      const wrap2 = document.getElementById('field-canvas-wrap');
      const tentPxW = s.tentL * FIELD_FT_PX * fieldZoom;
      if (tentPxW > wrap2.clientWidth * 0.65) {
        activateScene(idx);
      } else {
        zoomToScene(idx);
        fieldSelId = s.id;
        toast('Double-click again to open and edit');
      }
    }
  });

  cvs.addEventListener('mousedown', e => {
    const rect = cvs.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const fx = pxToFt(mx, fieldPanX), fy = pxToFt(my, fieldPanY);
    _fp.downX = mx; _fp.downY = my; _fp.moved = false;

    // Middle mouse OR space+left = pan
    if (e.button === 1 || (e.button === 0 && _fp.spaceDown)) {
      e.preventDefault();
      _fp.panActive = true;
      _fp.panStart = {mx, my, px: fieldPanX, py: fieldPanY};
      cvs.style.cursor = 'grabbing';
      return;
    }

    if (e.button !== 0) return;

    // Road draw tool
    if (fieldCurrentTool === 'road') {
      _fp.drawingRoad = true;
      _fp.drawStart = {x: fx, y: fy};
      fieldDrawingRoad = {x:mx, y:my, w:0, h:0};
      return;
    }

    // Hit test
    const hit = _fieldHitTest(fx, fy);
    if (hit) {
      fieldSelId = hit.id;
      if (hit.type === 'tent') {
        const s = scenes.find(s => s.id === hit.id);
        _fp.tentDrag = {id: hit.id, ox: fx - s.fieldX, oy: fy - s.fieldY};
      } else if (hit.type === 'road') {
        const r = fieldElements.find(r => r.id === hit.id);
        _fp.roadDrag = {id: hit.id, ox: fx - r.x, oy: fy - r.y};
      }
    } else {
      // Click on empty space = pan
      fieldSelId = null;
      _fp.panActive = true;
      _fp.panStart = {mx, my, px: fieldPanX, py: fieldPanY};
      cvs.style.cursor = 'grabbing';
    }
    renderFieldView();
  });

  window.addEventListener('mousemove', e => {
    if (!isFieldView) return;
    const cvs2 = document.getElementById('field-cvs');
    if (!cvs2) return;
    const rect = cvs2.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const fx = pxToFt(mx, fieldPanX), fy = pxToFt(my, fieldPanY);
    if (Math.abs(mx-_fp.downX)>2 || Math.abs(my-_fp.downY)>2) _fp.moved = true;

    if (_fp.panActive) {
      fieldPanX = _fp.panStart.px + (mx - _fp.panStart.mx);
      fieldPanY = _fp.panStart.py + (my - _fp.panStart.my);
      renderFieldView(); return;
    }
    if (_fp.drawingRoad) {
      const rx = Math.min(ftX(_fp.drawStart.x), mx);
      const ry = Math.min(ftY(_fp.drawStart.y), my);
      fieldDrawingRoad = {x:rx, y:ry, w:Math.abs(mx-ftX(_fp.drawStart.x)), h:Math.abs(my-ftY(_fp.drawStart.y))};
      renderFieldView(); return;
    }
    if (_fp.tentDrag) {
      const s = scenes.find(s => s.id === _fp.tentDrag.id);
      if (s) { s.fieldX = Math.max(0, fx - _fp.tentDrag.ox); s.fieldY = Math.max(0, fy - _fp.tentDrag.oy); }
      renderFieldView(); return;
    }
    if (_fp.roadDrag) {
      const r = fieldElements.find(r => r.id === _fp.roadDrag.id);
      if (r) { r.x = Math.max(0, fx - _fp.roadDrag.ox); r.y = Math.max(0, fy - _fp.roadDrag.oy); }
      renderFieldView(); return;
    }
  });

  window.addEventListener('mouseup', e => {
    if (!isFieldView) return;
    const cvs2 = document.getElementById('field-cvs');
    if (cvs2) cvs2.style.cursor = fieldCurrentTool==='road' ? 'crosshair' : (_fp.spaceDown ? 'grab' : 'default');

    if (_fp.panActive) { _fp.panActive = false; return; }

    if (_fp.drawingRoad && fieldDrawingRoad) {
      const x1ft = Math.min(_fp.drawStart.x, pxToFt(fieldDrawingRoad.x+fieldDrawingRoad.w, fieldPanX));
      const y1ft = Math.min(_fp.drawStart.y, pxToFt(fieldDrawingRoad.y+fieldDrawingRoad.h, fieldPanY));
      const wft  = Math.abs(pxToFt(fieldDrawingRoad.x+fieldDrawingRoad.w, fieldPanX) - pxToFt(fieldDrawingRoad.x, fieldPanX));
      const hft  = Math.abs(pxToFt(fieldDrawingRoad.y+fieldDrawingRoad.h, fieldPanY) - pxToFt(fieldDrawingRoad.y, fieldPanY));
      if (wft > 2 && hft > 0.5) {
        _pendingRoad = {type:'road', id:fieldNid++, x:x1ft, y:y1ft, w:wft, h:hft, label:'', rot:0};
        const popup = document.getElementById('road-label-popup');
        const wrapR = document.getElementById('field-canvas-wrap');
        const cx = ftX(x1ft + wft/2), cy = ftY(y1ft);
        popup.style.left = Math.min(cx-120, wrapR.clientWidth-320)+'px';
        popup.style.top  = Math.max(cy-80, 10)+'px';
        popup.style.display = 'block';
        document.getElementById('road-label-input').value = '';
        document.getElementById('road-label-input').focus();
      }
      fieldDrawingRoad = null; _fp.drawingRoad = false;
      setFieldTool('select');
      renderFieldView();
    }
    _fp.tentDrag = null; _fp.roadDrag = null;
  });

  // Prevent context menu on middle-click
  cvs.addEventListener('contextmenu', e => e.preventDefault());
}

function _fieldHitTest(fx, fy) {
  // Check roads first (on top)
  for (let i = fieldElements.length-1; i >= 0; i--) {
    const r = fieldElements[i];
    if (r.type==='road' && fx>=r.x && fx<=r.x+r.w && fy>=r.y && fy<=r.y+r.h)
      return {type:'road', id:r.id};
  }
  // Check tents
  for (let i = scenes.length-1; i >= 0; i--) {
    const s = scenes[i];
    if (fx>=s.fieldX && fx<=s.fieldX+s.tentL && fy>=s.fieldY && fy<=s.fieldY+s.tentW)
      return {type:'tent', id:s.id};
  }
  return null;
}

function confirmRoadLabel() {
  if (!_pendingRoad) return;
  _pendingRoad.label = document.getElementById('road-label-input').value.trim();
  fieldElements.push(_pendingRoad);
  _pendingRoad = null;
  document.getElementById('road-label-popup').style.display = 'none';
  renderFieldView();
}

function cancelRoadLabel() {
  _pendingRoad = null;
  document.getElementById('road-label-popup').style.display = 'none';
}

function deleteFieldSel() {
  if (!fieldSelId) return;
  const ri = fieldElements.findIndex(r => r.id === fieldSelId);
  if (ri >= 0) { fieldElements.splice(ri, 1); fieldSelId = null; renderFieldView(); toast('Road deleted'); return; }
  toast('Select a road to delete it (tents cannot be deleted here ‚Äî use the √ó on the tab)');
}

// ‚îÄ‚îÄ Resize field canvas on window resize ‚îÄ‚îÄ
window.addEventListener('resize', () => {
  if (isFieldView) renderFieldView();
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function toast(msg){const t=document.getElementById("toast");t.textContent=msg;t.style.opacity="1";clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity="0",2200);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEND TO CLIENT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openSendModal() {
  const modal = document.getElementById('send-modal');
  modal.style.display = 'flex';
  _smPopulateUpsells();
  _smUpdatePreview();
}

function closeSendModal() {
  document.getElementById('send-modal').style.display = 'none';
}

// Close on backdrop click
document.addEventListener('click', e => {
  if (e.target.id === 'send-modal') closeSendModal();
});

function _smGetEventData() {
  const name   = (document.getElementById('ev-client')?.value || '').trim();
  const type   = document.getElementById('ev-type')?.value || '';
  const date   = document.getElementById('ev-date')?.value || '';
  const venue  = (document.getElementById('ev-venue')?.value || '').trim();
  const guests = (document.getElementById('ev-guests')?.value || '').trim();
  const note   = (document.getElementById('ev-note')?.value || '').trim();
  const seatedGuests = items.reduce((s,i)=>{ const d=defOf(i.type); return s+(d?d.seats:0); },0);
  const dateStr = date ? new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'}) : '';
  const firstName = name ? name.split(' ')[0] : 'there';
  const typeClean = type.replace(/^\S+ /, '');
  const displayGuests = guests || (seatedGuests > 0 ? String(seatedGuests) : '');
  return { name, type, typeClean, date, dateStr, venue, guests: displayGuests, seatedGuests, note, firstName };
}

function _smGetCheckedUpsells() {
  return UPSELLS.filter(u => {
    const cb = document.getElementById('sm-uchk-'+u.id);
    return cb && cb.checked;
  });
}

function _smPopulateUpsells() {
  // Event summary box
  const ev = _smGetEventData();
  const sumEl = document.getElementById('sm-event-summary');
  if (sumEl) {
    const parts = [];
    if (ev.name)         parts.push(`<strong>${ev.name}</strong>`);
    if (ev.typeClean)    parts.push(ev.type);
    if (ev.dateStr)      parts.push('üìÖ ' + ev.dateStr);
    if (ev.venue)        parts.push('üìç ' + ev.venue);
    parts.push(`‚õ∫ ${tentW} √ó ${tentL} ft`);
    if (ev.guests)       parts.push('üë• ' + ev.guests + ' guests');
    sumEl.innerHTML = parts.join('<br>');
  }

  // Upsell checkboxes (auto-select relevant ones)
  const list = document.getElementById('sm-upsell-list');
  if (!list) return;
  if (list.children.length > 0) return; // already built
  const hasDance = items.some(i => defOf(i.type)?.type?.includes('dance') || i.type?.includes('dance'));
  const hasDJ    = items.some(i => i.type?.includes('dj') || i.type?.includes('stage'));

  UPSELLS.forEach(u => {
    const autoCheck = u.trigger === 'any' ||
                      (u.trigger === 'tables' && items.some(i => defOf(i.type)?.seats > 0)) ||
                      (u.trigger === 'dance' && hasDance) ||
                      (u.trigger === 'dj' && hasDJ);

    const row = document.createElement('label');
    row.style.cssText = `display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid ${autoCheck?'#16a34a':'#d0e4ee'};border-radius:7px;cursor:pointer;transition:all 0.15s;font-size:12.5px;font-weight:500;background:${autoCheck?'#f0fdf4':'white'};`;
    row.innerHTML = `
      <input type="checkbox" id="sm-uchk-${u.id}" ${autoCheck?'checked':''} style="width:14px;height:14px;cursor:pointer;accent-color:#16a34a;" onchange="_smOnUpsellChange(this,'${u.id}');_smUpdatePreview()">
      <span style="font-size:15px;">${u.icon}</span>
      <span style="flex:1;">${u.name}</span>
      <span style="font-size:11px;color:#5a7a88;white-space:nowrap;">${u.price}</span>
    `;
    list.appendChild(row);
  });
}

function _smOnUpsellChange(cb, id) {
  const row = cb.closest('label');
  if (cb.checked) {
    row.style.borderColor = '#16a34a';
    row.style.background = '#f0fdf4';
  } else {
    row.style.borderColor = '#d0e4ee';
    row.style.background = 'white';
  }
}

function _smUpdatePreview() {
  const ev = _smGetEventData();
  const checked = _smGetCheckedUpsells();

  document.getElementById('sm-ep-to').textContent = ev.name || '‚Äî';
  document.getElementById('sm-ep-subject').textContent = ev.name
    ? `Your Floor Plan is Ready ‚Äî ${ev.name}${ev.typeClean?' '+ev.typeClean:''}`
    : 'Your Floor Plan is Ready ‚Äî Peak Party Rentals';

  const upsellHTML = checked.length > 0 ? `
    <div style="border-top:2px solid #e8edf0;margin:20px 0 16px;padding-top:20px;">
      <div style="font-size:14px;font-weight:800;color:#1e2d35;margin-bottom:4px;">‚ú® A Few Ideas to Make It Even Better</div>
      <div style="font-size:12px;color:#5a7a88;margin-bottom:14px;line-height:1.5;">Based on your layout, here are a few add-ons other clients with similar setups have loved. No pressure ‚Äî just want to make sure you have the full picture!</div>
      ${checked.map(u => `
        <div style="display:flex;align-items:flex-start;gap:12px;padding:11px;margin-bottom:8px;border-radius:8px;border:1px solid #d0e4ee;background:#fafbfd;">
          <div style="font-size:22px;flex-shrink:0;">${u.icon}</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:#1e2d35;">${u.name}</div>
            <div style="font-size:11.5px;color:#5a7a88;margin-top:2px;line-height:1.4;">${u.desc}</div>
          </div>
          <div style="font-size:12px;font-weight:700;color:#0093c7;white-space:nowrap;">${u.price}</div>
        </div>
      `).join('')}
    </div>
  ` : '';

  const detailsHTML = `
    <div style="background:#f0fafd;border:1px solid #b3dff0;border-left:4px solid #0093c7;border-radius:6px;padding:14px 16px;margin-bottom:20px;">
      ${ev.name   ? `<div style="display:flex;gap:8px;font-size:12.5px;margin-bottom:4px;"><span style="color:#5a7a88;min-width:90px;">Event:</span><span style="font-weight:600;">${ev.name}${ev.typeClean?' ‚Äî '+ev.typeClean:''}</span></div>` : ''}
      ${ev.dateStr? `<div style="display:flex;gap:8px;font-size:12.5px;margin-bottom:4px;"><span style="color:#5a7a88;min-width:90px;">üìÖ Date:</span><span style="font-weight:600;">${ev.dateStr}</span></div>` : ''}
      ${ev.venue  ? `<div style="display:flex;gap:8px;font-size:12.5px;margin-bottom:4px;"><span style="color:#5a7a88;min-width:90px;">üìç Venue:</span><span style="font-weight:600;">${ev.venue}</span></div>` : ''}
      <div style="display:flex;gap:8px;font-size:12.5px;margin-bottom:4px;"><span style="color:#5a7a88;min-width:90px;">‚õ∫ Tent:</span><span style="font-weight:600;">${tentW} √ó ${tentL} ft</span></div>
      ${ev.guests ? `<div style="display:flex;gap:8px;font-size:12.5px;"><span style="color:#5a7a88;min-width:90px;">üë• Guests:</span><span style="font-weight:600;">${ev.guests} seated guests</span></div>` : ''}
    </div>
  `;

  document.getElementById('sm-email-body').innerHTML = `
    <div style="background:linear-gradient(160deg,#e8f7fd 0%,#c8ecf8 45%,#d8f3fc 100%);padding:28px 28px 22px;border-bottom:4px solid #0093c7;position:relative;overflow:hidden;">
      <!-- mountain accent shape -->
      <div style="position:absolute;bottom:0;right:0;left:0;height:40px;background:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 600 40%22%3E%3Cpolygon points=%220,40 150,8 220,22 310,2 390,18 460,6 540,16 600,4 600,40%22 fill=%22rgba(0,147,199,0.1)%22/%3E%3C/svg%3E') no-repeat bottom/cover;"></div>
      <table width="100%" cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td style="vertical-align:middle;">
            <img src="data:image/svg+xml;base64,${LOGO_LIGHT_B64}" style="height:44px;display:block;filter:brightness(0) saturate(100%) invert(34%) sepia(72%) saturate(1200%) hue-rotate(178deg) brightness(92%);" alt="Peak Party Rentals">
          </td>
          <td style="text-align:right;vertical-align:middle;">
            <div style="font-size:11px;font-weight:700;color:#0093c7;text-transform:uppercase;letter-spacing:1.5px;">Floor Plan Ready</div>
            <div style="font-size:10px;font-style:italic;color:#5a9ab8;margin-top:2px;">Take your events to greater heights</div>
          </td>
        </tr>
      </table>
      <div style="margin-top:14px;font-size:22px;font-weight:800;color:#0d1c26;letter-spacing:-0.3px;">${ev.name ? ev.name + (ev.typeClean ? ' ‚Äî ' + ev.typeClean : '') : 'Your Event'}</div>
      ${ev.dateStr ? `<div style="font-size:13px;color:#2a6a8a;margin-top:4px;">üìÖ ${ev.dateStr}</div>` : ''}
    </div>
    <div style="padding:22px 24px;font-family:'DM Sans',sans-serif;">
      <div style="font-size:15px;color:#1e2d35;margin-bottom:14px;line-height:1.6;">
        Hi <strong style="color:#0093c7;">${ev.firstName}</strong>,<br><br>
        We're so excited to help make your ${ev.typeClean||'event'} absolutely unforgettable!
        Your floor plan is all set ‚Äî we've attached it as a PDF to this email so you have everything in one place.
      </div>
      ${detailsHTML}
      ${ev.note ? `<div style="border-left:3px solid #0093c7;padding:8px 14px;font-size:12.5px;color:#1e2d35;font-style:italic;margin-bottom:20px;background:#f0fafd;border-radius:0 6px 6px 0;">"${ev.note}"<br><small style="font-style:normal;color:#5a7a88;font-weight:600;">‚Äî Peak Party Rentals</small></div>` : ''}
      ${upsellHTML}
      <div style="background:linear-gradient(135deg,#0093c7,#007aab);border-radius:8px;padding:18px 20px;margin-top:20px;text-align:center;">
        <div style="font-size:13px;color:rgba(255,255,255,0.85);margin-bottom:10px;">Questions about your layout or any of these add-ons? We'd love to help!</div>
        <div style="display:inline-block;background:#fff;color:#0093c7;font-size:13px;font-weight:800;padding:10px 24px;border-radius:6px;">üìû Call (215) 385-4040</div>
      </div>
      <div style="margin-top:20px;font-size:11.5px;color:#5a7a88;line-height:1.7;">
        Warm regards,<br>
        <strong style="color:#1e2d35;">The Peak Party Rentals Team</strong><br>
        <span style="color:#0093c7;">(215) 385-4040 ¬∑ events@peakpartyrentals.com</span><br>
        PA, NJ &amp; DE
      </div>
    </div>
    <div style="background:#0d1c26;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:12px;font-weight:700;color:#41b8ea;">Peak Party Rentals</span>
      <span style="font-size:11px;color:rgba(255,255,255,0.35);">¬© 2025 ¬∑ PA, NJ &amp; DE</span>
    </div>
  `;
}

// Copy plain-text email
function smCopyEmail() {
  const ev = _smGetEventData();
  const checked = _smGetCheckedUpsells();

  // ‚îÄ‚îÄ Build Gmail-compatible HTML (inline styles only, no external CSS) ‚îÄ‚îÄ
  const upsellRows = checked.map(u => `
    <tr>
      <td style="padding:10px 14px;border-bottom:1px solid #e8edf2;vertical-align:top;">
        <table width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td style="width:36px;font-size:22px;vertical-align:middle;">${u.icon}</td>
            <td style="padding-left:10px;vertical-align:middle;">
              <div style="font-size:14px;font-weight:700;color:#1e2d35;">${u.name}</div>
              <div style="font-size:12px;color:#5a7a88;margin-top:2px;">${u.desc}</div>
            </td>
            <td style="white-space:nowrap;text-align:right;font-size:13px;font-weight:700;color:#0093c7;vertical-align:middle;padding-left:10px;">${u.price}</td>
          </tr>
        </table>
      </td>
    </tr>
  `).join('');

  const upsellSection = checked.length > 0 ? `
    <tr><td style="padding:0 0 4px;">
      <div style="border-top:2px solid #e0edf2;margin:20px 0 14px;"></div>
      <div style="font-size:15px;font-weight:800;color:#1e2d35;margin-bottom:4px;">‚ú® A Few Ideas to Make It Even Better</div>
      <div style="font-size:13px;color:#5a7a88;margin-bottom:14px;line-height:1.5;">Based on your layout, here are some add-ons other clients with similar setups have loved. No pressure ‚Äî just want to make sure you have the full picture!</div>
      <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border:1px solid #d0e4ee;border-radius:8px;border-collapse:collapse;overflow:hidden;">
        ${upsellRows}
      </table>
    </td></tr>
  ` : '';

  const detailRows = [
    ev.name    ? `<tr><td style="padding:4px 0;font-size:13px;color:#5a7a88;width:110px;">Event:</td><td style="padding:4px 0;font-size:13px;font-weight:600;color:#1e2d35;">${ev.name}${ev.typeClean?' ‚Äî '+ev.typeClean:''}</td></tr>` : '',
    ev.dateStr ? `<tr><td style="padding:4px 0;font-size:13px;color:#5a7a88;">üìÖ Date:</td><td style="padding:4px 0;font-size:13px;font-weight:600;color:#1e2d35;">${ev.dateStr}</td></tr>` : '',
    ev.venue   ? `<tr><td style="padding:4px 0;font-size:13px;color:#5a7a88;">üìç Venue:</td><td style="padding:4px 0;font-size:13px;font-weight:600;color:#1e2d35;">${ev.venue}</td></tr>` : '',
    `<tr><td style="padding:4px 0;font-size:13px;color:#5a7a88;">‚õ∫ Tent:</td><td style="padding:4px 0;font-size:13px;font-weight:600;color:#1e2d35;">${tentW} √ó ${tentL} ft</td></tr>`,
    ev.guests  ? `<tr><td style="padding:4px 0;font-size:13px;color:#5a7a88;">üë• Guests:</td><td style="padding:4px 0;font-size:13px;font-weight:600;color:#1e2d35;">${ev.guests} seated guests</td></tr>` : '',
  ].filter(Boolean).join('');

  const noteBlock = ev.note ? `
    <tr><td style="padding:0 0 16px;">
      <div style="border-left:4px solid #0093c7;padding:10px 14px;background:#f0fafd;border-radius:0 6px 6px 0;font-size:13px;font-style:italic;color:#1e2d35;">
        "${ev.note}"<br>
        <span style="font-style:normal;font-weight:600;font-size:12px;color:#5a7a88;">‚Äî Peak Party Rentals</span>
      </div>
    </td></tr>
  ` : '';

  const htmlEmail = `
<!DOCTYPE html>
<html>
<body style="margin:0;padding:0;background:#f0f4f6;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;">
<table width="100%" cellpadding="0" cellspacing="0" border="0" style="background:#f0f4f6;padding:20px 0;">
  <tr><td align="center">
    <table width="600" cellpadding="0" cellspacing="0" border="0" style="max-width:600px;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,0.1);">

      <!-- Header -->
      <tr><td style="background:linear-gradient(160deg,#e8f7fd 0%,#c8ecf8 45%,#d8f3fc 100%);padding:28px 28px 22px;border-bottom:4px solid #0093c7;">
        <table width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td style="vertical-align:middle;padding-bottom:12px;">
              <img src="data:image/svg+xml;base64,${LOGO_LIGHT_B64}" width="160" style="display:block;filter:brightness(0) saturate(100%) invert(34%) sepia(72%) saturate(1200%) hue-rotate(178deg) brightness(92%);" alt="Peak Party Rentals">
            </td>
            <td style="text-align:right;vertical-align:middle;padding-bottom:12px;">
              <div style="font-size:11px;font-weight:800;color:#0093c7;text-transform:uppercase;letter-spacing:1.5px;">Floor Plan Ready</div>
              <div style="font-size:10px;font-style:italic;color:#5a9ab8;margin-top:2px;">Take your events to greater heights</div>
            </td>
          </tr>
          <tr>
            <td colspan="2" style="border-top:1px solid rgba(0,147,199,0.2);padding-top:14px;">
              <div style="font-size:24px;font-weight:800;color:#0d1c26;letter-spacing:-0.3px;">${ev.name ? ev.name + (ev.typeClean ? ' \u2014 ' + ev.typeClean : '') : 'Your Event'}</div>
              ${ev.dateStr ? `<div style="font-size:13px;color:#2a6a8a;margin-top:5px;">&#128197; ${ev.dateStr}</div>` : ''}
            </td>
          </tr>
        </table>
      </td></tr>

      <!-- Body -->
      <tr><td style="padding:26px 28px;">
        <table width="100%" cellpadding="0" cellspacing="0" border="0">

          <!-- Greeting -->
          <tr><td style="padding-bottom:16px;">
            <div style="font-size:16px;color:#1e2d35;line-height:1.7;">
              Hi <strong style="color:#0093c7;">${ev.firstName}</strong>,
            </div>
            <div style="font-size:15px;color:#1e2d35;line-height:1.7;margin-top:8px;">
              We're so excited to help make your ${ev.typeClean||'event'} absolutely unforgettable!
              Your floor plan is all set ‚Äî we've attached it as a PDF so you have everything in one place.
            </div>
          </td></tr>

          <!-- Event details box -->
          <tr><td style="padding-bottom:16px;">
            <table width="100%" cellpadding="12" cellspacing="0" border="0" style="background:#f0fafd;border:1px solid #b3dff0;border-left:5px solid #0093c7;border-radius:6px;">
              ${detailRows}
            </table>
          </td></tr>

          ${noteBlock}
          ${upsellSection}

          <!-- CTA -->
          <tr><td style="padding-top:20px;">
            <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background:#0093c7;border-radius:8px;">
              <tr><td style="padding:18px 20px;text-align:center;">
                <div style="font-size:14px;color:rgba(255,255,255,0.9);margin-bottom:10px;">Questions about your layout or any of these add-ons? We'd love to help!</div>
                <div style="font-size:16px;font-weight:800;color:#ffffff;">üìû (215) 385-4040</div>
              </td></tr>
            </table>
          </td></tr>

          <!-- Sign-off -->
          <tr><td style="padding-top:22px;">
            <div style="font-size:13px;color:#5a7a88;line-height:1.8;">
              Warm regards,<br>
              <strong style="color:#1e2d35;font-size:14px;">The Peak Party Rentals Team</strong><br>
              <span style="color:#0093c7;">(215) 385-4040 ¬∑ events@peakpartyrentals.com</span><br>
              PA, NJ &amp; DE
            </div>
          </td></tr>

        </table>
      </td></tr>

      <!-- Footer -->
      <tr><td style="background:linear-gradient(90deg,#e0f3fb,#d0edf8);padding:16px 28px;border-top:1px solid #b3dff0;">
        <table width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td style="font-size:12px;font-weight:800;color:#0093c7;text-transform:uppercase;letter-spacing:1px;">Peak Party Rentals</td>
            <td style="text-align:right;font-size:11px;color:#5a9ab8;">PA, NJ &amp; DE ¬∑ (215) 385-4040</td>
          </tr>
        </table>
      </td></tr>

    </table>
  </td></tr>
</table>
</body>
</html>`;

  // Copy both HTML and plain-text fallback ‚Äî Gmail reads the HTML version
  const plainText = `Hi ${ev.firstName},\n\nWe're so excited to help make your ${ev.typeClean||'event'} unforgettable! Your floor plan is attached as a PDF.\n\n`
    + (ev.name    ? `Event: ${ev.name}${ev.typeClean?' ‚Äî '+ev.typeClean:''}\n` : '')
    + (ev.dateStr ? `Date: ${ev.dateStr}\n` : '')
    + (ev.venue   ? `Venue: ${ev.venue}\n` : '')
    + `Tent: ${tentW} √ó ${tentL} ft\n`
    + (ev.guests  ? `Guests: ${ev.guests} seated\n` : '')
    + (checked.length > 0 ? `\nRecommended Add-Ons:\n${checked.map(u=>`  ${u.icon} ${u.name} ‚Äî ${u.price}`).join('\n')}\n` : '')
    + `\nüìû (215) 385-4040 ¬∑ events@peakpartyrentals.com\n\nWarm regards,\nThe Peak Party Rentals Team`;

  try {
    const htmlBlob  = new Blob([htmlEmail],  { type: 'text/html' });
    const textBlob  = new Blob([plainText],  { type: 'text/plain' });
    const clipItem  = new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob });
    navigator.clipboard.write([clipItem]).then(() => {
      const btn = document.getElementById('sm-copy-btn');
      btn.textContent = '‚úì Copied! Paste into Gmail or Outlook ‚Äî fully formatted';
      btn.style.background = '#16a34a';
      setTimeout(() => {
        btn.textContent = 'üìã Copy Email to Clipboard';
        btn.style.background = '#0093c7';
      }, 4000);
    }).catch(err => {
      // Fallback: plain text
      navigator.clipboard.writeText(plainText).then(() => {
        const btn = document.getElementById('sm-copy-btn');
        btn.textContent = '‚úì Copied (plain text ‚Äî open via HTTPS for rich format)';
        btn.style.background = '#d97706';
        setTimeout(() => { btn.textContent = 'üìã Copy Email to Clipboard'; btn.style.background = '#0093c7'; }, 4000);
      });
    });
  } catch(e) {
    navigator.clipboard.writeText(plainText);
  }
}

// Download PDF with floor plan snapshot + upsells
function smDownloadPDF() {
  const btn = document.getElementById('sm-pdf-btn');
  btn.textContent = '‚è≥ Generating PDF‚Ä¶';
  btn.disabled = true;

  const ev = _smGetEventData();
  const checked = _smGetCheckedUpsells();

  // Capture the tent/layout using html2canvas
  const captureEl = document.getElementById('tent') || document.getElementById('world');
  
  const capturePromise = captureEl && window.html2canvas ? 
    html2canvas(captureEl, {
      backgroundColor: '#ffffff',
      scale: 1.5,
      useCORS: true,
      allowTaint: true,
      logging: false
    }).catch(() => null) : Promise.resolve(null);

  capturePromise.then(capturedCanvas => {
  const snapSrc = capturedCanvas ? capturedCanvas.toDataURL('image/png') : null;

  // Use jsPDF
  setTimeout(() => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'letter' });
      const PW = doc.internal.pageSize.getWidth();
      const PH = doc.internal.pageSize.getHeight();
      let y = 0;

      // ‚îÄ‚îÄ Header bar ‚îÄ‚îÄ
      doc.setFillColor(13, 28, 38);
      doc.rect(0, 0, PW, 60, 'F');
      doc.setFillColor(0, 147, 199);
      doc.rect(0, 57, PW, 3, 'F');

      doc.setFont('helvetica','bold');
      doc.setFontSize(18); doc.setTextColor(255,255,255);
      doc.text('Peak Party Rentals', 28, 28);
      doc.setFont('helvetica','italic');
      doc.setFontSize(9); doc.setTextColor(65,184,234);
      doc.text('Take your events to greater heights', 28, 42);

      if (ev.name) {
        doc.setFont('helvetica','bold');
        doc.setFontSize(13); doc.setTextColor(255,255,255);
        const nameStr = ev.name + (ev.typeClean ? ' ‚Äî ' + ev.typeClean : '');
        doc.text(nameStr, PW - 28, 28, {align:'right'});
        if (ev.dateStr) {
          doc.setFont('helvetica','normal');
          doc.setFontSize(9); doc.setTextColor(180,200,210);
          doc.text(ev.dateStr, PW - 28, 42, {align:'right'});
        }
      }
      y = 75;

      // ‚îÄ‚îÄ Event details row ‚îÄ‚îÄ
      const stats = [];
      stats.push({ label:'Tent Size', val: tentW+'√ó'+tentL+' ft' });
      const seatedCount = items.reduce((s,i)=>{ const d=defOf(i.type); return s+(d?d.seats:0); },0);
      if (seatedCount > 0) stats.push({ label:'Seated Guests', val: String(seatedCount) });
      stats.push({ label:'Items on Layout', val: String(items.length) });
      if (ev.venue) stats.push({ label:'Venue', val: ev.venue });

      const statW = (PW - 56) / stats.length;
      doc.setFillColor(240,250,253);
      doc.rect(28, y, PW-56, 48, 'F');
      doc.setDrawColor(179,223,240); doc.setLineWidth(0.5);
      doc.rect(28, y, PW-56, 48);

      stats.forEach((s, i) => {
        const sx = 28 + i*statW + statW/2;
        doc.setFont('helvetica','bold'); doc.setFontSize(8);
        doc.setTextColor(90,122,136);
        doc.text(s.label.toUpperCase(), sx, y+15, {align:'center'});
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.setTextColor(0,147,199);
        doc.text(s.val, sx, y+34, {align:'center'});
        if (i < stats.length-1) {
          doc.setDrawColor(210,225,235); doc.setLineWidth(0.5);
          doc.line(28+statW*(i+1), y+8, 28+statW*(i+1), y+40);
        }
      });
      y += 62;

      // ‚îÄ‚îÄ Floor plan label ‚îÄ‚îÄ
      doc.setFont('helvetica','bold'); doc.setFontSize(9);
      doc.setTextColor(90,122,136);
      doc.text('FLOOR PLAN', 28, y+12);
      doc.setDrawColor(210,225,235); doc.setLineWidth(0.5);
      doc.line(100, y+8, PW-28, y+8);
      y += 18;

      // ‚îÄ‚îÄ Canvas snapshot ‚îÄ‚îÄ
      const snapH = 220;
      if (snapSrc) {
        doc.setFillColor(240,250,253);
        doc.rect(28, y, PW-56, snapH, 'F');
        doc.setDrawColor(179,223,240); doc.setLineWidth(0.5);
        doc.rect(28, y, PW-56, snapH);
        try {
          doc.addImage(snapSrc, 'PNG', 30, y+2, PW-60, snapH-4, undefined, 'FAST');
        } catch(e) {}
      } else {
        doc.setFillColor(240,250,253);
        doc.rect(28, y, PW-56, snapH, 'F');
        doc.setFont('helvetica','italic'); doc.setFontSize(11);
        doc.setTextColor(90,122,136);
        doc.text('Floor Plan ‚Äî ' + tentW + '√ó' + tentL + ' ft', PW/2, y + snapH/2, {align:'center'});
      }
      y += snapH + 14;

      // ‚îÄ‚îÄ Personal note ‚îÄ‚îÄ
      if (ev.note) {
        doc.setFillColor(240,250,253);
        doc.setDrawColor(0,147,199); doc.setLineWidth(2);
        doc.rect(28, y, 2, 30, 'F');
        doc.setLineWidth(0.5); doc.setDrawColor(179,223,240);
        doc.rect(28, y, PW-56, 30, 'F');
        doc.setFont('helvetica','italic'); doc.setFontSize(10); doc.setTextColor(48,57,61);
        const noteLines = doc.splitTextToSize(`"${ev.note}"`, PW-90);
        doc.text(noteLines, 38, y+12);
        y += 38;
      }

      // ‚îÄ‚îÄ Upsells section ‚îÄ‚îÄ
      if (checked.length > 0) {
        // Check if new page needed
        const upsellH = 44 + checked.length * 52;
        if (y + upsellH > PH - 50) { doc.addPage(); y = 28; }

        // Section header
        doc.setFillColor(224,244,252);
        doc.setDrawColor(0,147,199); doc.setLineWidth(2);
        doc.rect(28, y, PW-56, 28, 'F');
        doc.setLineWidth(0.5);
        doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(0,147,199);
        doc.text('‚ú®  RECOMMENDED ADD-ONS  ‚Äî  Based on your layout', 38, y+18);
        doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(90,122,136);
        doc.text('Ask your Peak Party Rentals rep about any of these', PW-30, y+18, {align:'right'});
        y += 34;

        checked.forEach(u => {
          if (y + 52 > PH - 50) { doc.addPage(); y = 28; }
          doc.setFillColor(250,251,253);
          doc.setDrawColor(208,228,238); doc.setLineWidth(0.5);
          doc.roundedRect(28, y, PW-56, 44, 4, 4, 'FD');

          doc.setFillColor(0,147,199);
          doc.roundedRect(28, y, 4, 44, 2, 2, 'F');

          doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(48,57,61);
          doc.text(u.name, 44, y+17);

          doc.setFont('helvetica','normal'); doc.setFontSize(9.5); doc.setTextColor(90,122,136);
          const descLines = doc.splitTextToSize(u.desc, PW-160);
          doc.text(descLines, 44, y+30);

          doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(0,147,199);
          doc.text(u.price, PW-36, y+22, {align:'right'});
          y += 52;
        });

        y += 8;
        // CTA box
        if (y + 50 < PH - 30) {
          doc.setFillColor(0,147,199);
          doc.roundedRect(28, y, PW-56, 42, 6, 6, 'F');
          doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(255,255,255);
          doc.text('Interested in any of these? Call or email us ‚Äî we\'d love to make your event perfect.', PW/2, y+14, {align:'center'});
          doc.setFont('helvetica','bold'); doc.setFontSize(12);
          doc.text('(215) 385-4040  ¬∑  events@peakpartyrentals.com', PW/2, y+30, {align:'center'});
          y += 50;
        }
      }

      // ‚îÄ‚îÄ Footer ‚îÄ‚îÄ
      const footY = PH - 28;
      doc.setFillColor(13,28,38);
      doc.rect(0, footY-10, PW, 38, 'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(65,184,234);
      doc.text('Peak Party Rentals', 28, footY+10);
      doc.setFont('helvetica','normal'); doc.setTextColor(120,160,180);
      doc.text('PA, NJ & DE  ¬∑  (215) 385-4040  ¬∑  Floor Plan generated by PPR Floor Planner', PW/2, footY+10, {align:'center'});

      const fname = (ev.name || 'FloorPlan').replace(/\s+/g,'_') + '_PPR.pdf';
      doc.save(fname);

    } catch(err) {
      console.error('PDF error:', err);
      toast('PDF generation failed ‚Äî check console');
    }

    btn.textContent = '‚¨á Download PDF Floor Plan';
    btn.disabled = false;
  }, 80);
  }); // end capturePromise.then
}


</script>

<!-- ‚ïê‚ïê 3D VIEW OVERLAY ‚ïê‚ïê -->
<div id="view3d-overlay" style="display:none;position:fixed;inset:0;z-index:2000;flex-direction:column;font-family:'DM Sans',sans-serif;">
  <div style="height:50px;background:#0d1920;border-bottom:1px solid #1e3040;display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;z-index:10;">
    <img id="logo-3d" style="height:26px;opacity:0.95;">
    <div style="color:#41b8ea;font-size:9.5px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;border-left:1px solid rgba(255,255,255,0.1);padding-left:12px;white-space:nowrap;">3D Preview</div>
    <div id="view3d-event-label" style="color:rgba(255,255,255,0.45);font-size:11px;margin-left:4px;"></div>
    <div style="margin-left:auto;display:flex;gap:7px;align-items:center;">
      <button onclick="reset3DCamera()" class="btn3d">‚äô Reset View</button>
      <button onclick="toggle3DAutoRotate()" id="btn3d-rotate" class="btn3d">‚Ü∫ Auto Rotate</button>
      <button onclick="toggle3DNight()" id="btn3d-night" class="btn3d">üåô Night Mode</button>
      <select id="chair-style-sel" onchange="setChairStyle(this.value)" class="btn3d" style="cursor:pointer;padding:5px 8px;">
        <option value="white_folding">ü™ë White Folding</option>
        <option value="brown_folding">ü™ë Brown Folding</option>
        <option value="chiavari">‚ú® Chiavari</option>
        <option value="padded">ü™ë Padded Folding</option>
      </select>
      <div style="width:1px;background:rgba(255,255,255,0.1);height:24px;margin:0 4px;"></div>
      <button onclick="close3DView()" style="background:rgba(220,38,38,0.18);border:1px solid rgba(220,38,38,0.4);color:#fca5a5;border-radius:5px;padding:5px 14px;font-size:11px;cursor:pointer;font-weight:600;">‚úï Close</button>
    </div>
  </div>
  <div id="view3d-wrap" style="flex:1;position:relative;overflow:hidden;"></div>
  <div style="position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.55);color:rgba(255,255,255,0.45);font-size:10px;padding:5px 16px;border-radius:20px;pointer-events:none;z-index:20;white-space:nowrap;">
    Left drag ¬∑ Orbit &nbsp;&nbsp;¬∑&nbsp;&nbsp; Scroll ¬∑ Zoom &nbsp;&nbsp;¬∑&nbsp;&nbsp; Right drag ¬∑ Pan
  </div>
  <div id="view3d-loading" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(13,25,32,0.95);z-index:15;">
    <div style="text-align:center;color:#41b8ea;">
      <div style="font-size:32px;margin-bottom:12px;">‚¨°</div>
      <div style="font-size:13px;font-weight:600;letter-spacing:1px;">Loading 3D View‚Ä¶</div>
    </div>
  </div>
</div>
<style>
/* ‚îÄ‚îÄ SCENE TAB BAR ‚îÄ‚îÄ */


/* ‚ïê‚ïê FULL-WIDTH EVENT BAR ‚ïê‚ïê */
#event-bar{
  background:var(--panel);
  border-top:2px solid var(--accent);
  flex-shrink:0;
  transition:height 0.22s ease;
}
#event-bar-hdr{
  display:flex;align-items:center;gap:10px;
  padding:6px 16px;cursor:pointer;
  background:linear-gradient(90deg, var(--teal-tint), var(--panel));
  border-bottom:1px solid var(--border);
  user-select:none;
}
#event-bar-hdr:hover{background:var(--teal-tint);}
.eb-arrow{font-size:9px;color:var(--accent);transition:transform 0.2s;flex-shrink:0;}
.eb-arrow.collapsed{transform:rotate(180deg);}
.eb-title{font-size:12.5px;font-weight:800;color:var(--accent);letter-spacing:0.3px;white-space:nowrap;}
.eb-summary{font-size:11.5px;color:var(--muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.eb-hint{font-size:10px;color:rgba(0,0,0,0.25);white-space:nowrap;margin-left:auto;}
#event-bar-body{
  display:flex;flex-direction:row;gap:0;
  padding:10px 16px;overflow:hidden;
}
.eb-col{
  flex:1;min-width:0;padding:0 14px;
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
}
.eb-col:first-child{padding-left:0;}
.eb-col:last-child{border-right:none;}
.eb-preview-col{flex:1.2;}
/* Override ev-input sizing for horizontal layout */
#event-bar .ev-input{font-size:12.5px;padding:5px 8px;width:100%;box-sizing:border-box;}
#event-bar .ev-lbl{font-size:11px;}
#event-bar .ev-preview-box{font-size:11px;}
#event-bar[data-collapsed="true"] #event-bar-body{display:none;}
#event-bar[data-collapsed="true"] .eb-hint{display:none;}
#event-bar[data-collapsed="true"] #event-bar-hdr{border-bottom:none;}

/* ‚îÄ‚îÄ BRAND BADGE (tb-right) ‚îÄ‚îÄ */

/* ‚îÄ‚îÄ PPR Canvas Watermark ‚îÄ‚îÄ */
#canvas-area::after{
  content:'Peak Party Rentals ‚Äî Floor Planner';
  position:absolute;bottom:10px;right:14px;
  font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;
  color:rgba(0,147,199,0.18);pointer-events:none;z-index:5;
  font-family:'DM Sans',sans-serif;
}

.tb-brand-badge{
  display:flex;align-items:center;gap:7px;
  margin-left:8px;padding:5px 12px 5px 10px;
  background:linear-gradient(135deg,rgba(0,147,199,0.15),rgba(65,184,234,0.08));
  border:1px solid rgba(65,184,234,0.25);border-radius:8px;
  cursor:default;transition:border-color 0.2s;
}
.tb-brand-badge:hover{border-color:rgba(65,184,234,0.55);}
.tb-badge-icon{font-size:18px;line-height:1;filter:drop-shadow(0 0 6px rgba(65,184,234,0.5));}
.tb-badge-text{display:flex;flex-direction:column;gap:1px;}
.tb-badge-top{font-size:8.5px;color:rgba(255,255,255,0.4);font-weight:500;text-transform:uppercase;letter-spacing:0.8px;white-space:nowrap;}
.tb-badge-bot{font-size:11px;color:#41b8ea;font-weight:800;letter-spacing:0.3px;white-space:nowrap;}

/* ‚îÄ‚îÄ Ensure all toolbar children respect new height ‚îÄ‚îÄ */
#tb-left{display:flex;align-items:center;overflow:hidden;flex:1;min-width:0;position:relative;z-index:1;}
.tb-sect{display:flex;align-items:center;gap:5px;padding:0 10px;border-right:1px solid rgba(255,255,255,0.07);height:100%;}

#scene-tab-bar{
  height:34px;display:flex;align-items:center;gap:2px;
  background:#0b1820;border-bottom:1px solid rgba(0,147,199,0.4);
  padding:0 8px;overflow-x:auto;flex-shrink:0;scrollbar-width:none;
}
#scene-tab-bar::-webkit-scrollbar{display:none;}
.scene-tab{
  height:28px;padding:0 12px;border-radius:6px 6px 0 0;
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);
  border-bottom:none;color:rgba(255,255,255,0.5);font-size:11px;font-weight:600;
  cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;
  transition:all 0.14s;user-select:none;font-family:'DM Sans',sans-serif;
}
.scene-tab:hover{background:rgba(255,255,255,0.12);color:#fff;}
.scene-tab.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.scene-tab-del{
  background:none;border:none;color:rgba(255,255,255,0.35);
  cursor:pointer;font-size:13px;padding:0 0 0 4px;line-height:1;
}
.scene-tab-del:hover{color:#ff6b6b;}
/* ‚îÄ‚îÄ PALETTE STRUCTURE ‚îÄ‚îÄ */
#pal-hdr-bar{
  background:var(--teal-tint);border-bottom:1px solid var(--border);
  padding:10px 10px 8px;flex-shrink:0;
  font-size:13.2px;font-weight:700;color:var(--blue);
  text-transform:uppercase;letter-spacing:1.5px;
  display:flex;align-items:center;
}
#pal-inner{flex:1;overflow-y:auto;padding:6px;min-height:0;}

/* Event accordion CSS removed ‚Äî now uses #event-bar */

.scene-tab-rename-btn{
  background:none;border:none;color:rgba(255,255,255,0.3);
  cursor:pointer;font-size:9px;padding:0 0 0 3px;line-height:1;
  opacity:0;transition:opacity 0.15s;
}
.scene-tab:hover .scene-tab-rename-btn,
.scene-tab.active .scene-tab-rename-btn{opacity:1;}
.scene-tab-rename-btn:hover{color:#41b8ea!important;opacity:1!important;}
.scene-tab-dims{pointer-events:none;}

.scene-tab-add{
  height:24px;padding:0 10px;border-radius:4px;
  background:rgba(0,147,199,0.18);border:1px dashed rgba(0,147,199,0.5);
  color:#41b8ea;font-size:10px;font-weight:700;cursor:pointer;
  font-family:'DM Sans',sans-serif;transition:all 0.14s;white-space:nowrap;
}
.scene-tab-add:hover{background:rgba(0,147,199,0.32);border-color:#41b8ea;}
.field-view-tab{
  background:rgba(80,120,60,0.25)!important;border-color:rgba(100,160,80,0.4)!important;
  color:#8fca6a!important;
}
.field-view-tab.active{background:#4a7830!important;border-color:#6aaa40!important;color:#fff!important;}

/* ‚îÄ‚îÄ FIELD VIEW ‚îÄ‚îÄ */
#field-toolbar{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:rgba(10,20,14,0.88);border:1px solid rgba(100,180,80,0.35);
  border-radius:8px;padding:5px 10px;display:flex;align-items:center;
  gap:6px;z-index:20;backdrop-filter:blur(4px);
}
.ftb-btn{
  height:26px;padding:0 10px;border-radius:5px;
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);
  color:rgba(255,255,255,0.65);font-size:10.5px;cursor:pointer;
  font-family:'DM Sans',sans-serif;transition:all 0.14s;white-space:nowrap;
}
.ftb-btn:hover{background:rgba(255,255,255,0.16);color:#fff;}
.ftb-btn.active{background:rgba(100,180,80,0.3);border-color:#6aaa40;color:#8fca6a;}
#compass{
  position:absolute;bottom:50px;right:16px;width:40px;height:40px;
  pointer-events:none;z-index:20;
}
#field-scale-bar{
  position:absolute;bottom:16px;right:16px;
  color:rgba(255,255,255,0.6);font-size:9px;text-align:center;z-index:20;
}
#field-scale-line{
  height:3px;background:rgba(255,255,255,0.5);
  border-left:2px solid rgba(255,255,255,0.5);
  border-right:2px solid rgba(255,255,255,0.5);
  margin-bottom:3px;
}

.amenu-btn{height:26px;padding:3px 7px;font-size:10.5px;justify-content:center;width:100%;}
.amenu-btn:hover{background:rgba(0,147,199,0.22);border-color:#41b8ea;color:#fff;}
.btn3d{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.14);color:#c8dde8;border-radius:5px;padding:5px 11px;font-size:11px;cursor:pointer;font-family:'DM Sans',
